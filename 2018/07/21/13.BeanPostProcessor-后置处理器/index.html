<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 13.BeanPostProcessor-后置处理器 · Eureka-Home</title><meta name="description" content="13.BeanPostProcessor-后置处理器 - Eureka"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Eureka-Home"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/sunweiguo" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">13.BeanPostProcessor-后置处理器</h1><div class="post-info">Jul 21, 2018</div><div class="post-content"><p>学习bean的初始化和销毁等。<br><a id="more"></a></p>
<h3 id="BeanPostProcessor-后置处理器"><a href="#BeanPostProcessor-后置处理器" class="headerlink" title="BeanPostProcessor-后置处理器"></a>BeanPostProcessor-后置处理器</h3><p>这是一个接口，<code>bean</code>的后置处理器，在<code>bean</code>初始化前后进行一些处理工作，有两个方法，一个是初始化之前处理，一个是初始化之后处理。</p>
<p><strong>具体的执行时机：</strong></p>
<blockquote>
<p><code>postProcessBeforeInitialization</code>是在<code>bean</code>实例生成之后，在任何的初始化方法之前（比如<code>InitializingBean</code>接口的<code>afterPropertiesSet</code>方法；比如<code>init-method</code>方法）</p>
</blockquote>
<blockquote>
<p><code>postProcessAfterInitialization</code>与上面个完全相反，在任何的初始化方法完成之后再调用。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BeanPostProcessor</span> </span>&#123;</span><br><span class="line">    <span class="function">Object <span class="title">postProcessBeforeInitialization</span><span class="params">(Object var1, String var2)</span> <span class="keyword">throws</span> BeansException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Object <span class="title">postProcessAfterInitialization</span><span class="params">(Object var1, String var2)</span> <span class="keyword">throws</span> BeansException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>示例：</p>
<p>我这里将上面的<code>Dog</code>，<code>Cat</code>，<code>Pig</code>全部用起来。<code>pig</code>用到<code>init-destory</code>和<code>destory-method</code>方法；<code>cat</code>实现<code>InitializingBean</code>,<code>DisposableBean</code>这两个接口；<code>pig</code>是实现<code>@PostConstruct</code>和<code>@PreDestory</code>这两个接口。</p>
<p>再加上后置处理器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBeanPostProcessor</span> <span class="keyword">implements</span> <span class="title">BeanPostProcessor</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bean 还未初始化的bean对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanName 这个bean对象在容器中的名字</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回我们要用的bean实例对象，可以直接返回传进来的bean，也可以包装一下再返回</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> BeansException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"postProcessBeforeInitialization..."</span>+beanName+<span class="string">"=&gt;"</span>+bean);</span><br><span class="line">        <span class="keyword">return</span> bean;<span class="comment">//返回null的话，下面个方法就不会再执行了</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"postProcessAfterInitialization..."</span>+beanName+<span class="string">"=&gt;"</span>+bean);</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于Dog是用的是注解版的<code>@Bean(initMethod = &quot;init&quot;,destroyMethod = &quot;destory&quot;)</code>：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Dog</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Dog</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Dog constructor...."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Dog init..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destory</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Dog destory..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>对于Cat用的是<code>InitializingBean</code>,<code>DisposableBean</code>:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Cat</span> <span class="keyword">implements</span> <span class="title">InitializingBean</span>,<span class="title">DisposableBean</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Cat</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"cat constructor..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"cat destory..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"cat afterPropertiesSet init..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>对于Pig用的是<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Pig</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Pig</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"pig constructor..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"pig init..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PreDestroy</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destory</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"pig destory..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>一起启动，看看是什么先后顺序：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">//1.首先是Dog对象创建</span><br><span class="line">//2.然后是在任何的初始化方法之前执行postProcessBeforeInitialization</span><br><span class="line">//3.然后初始化init</span><br><span class="line">//4.init初始化之后执行postProcessAfterInitialization</span><br><span class="line">Dog constructor....</span><br><span class="line">postProcessBeforeInitialization...dog=&gt;com.swg.bean.Dog@157632c9</span><br><span class="line">Dog init...</span><br><span class="line">postProcessAfterInitialization...dog=&gt;com.swg.bean.Dog@157632c9</span><br><span class="line">//同理</span><br><span class="line">cat constructor...</span><br><span class="line">postProcessBeforeInitialization...cat=&gt;com.swg.bean.Cat@64c87930</span><br><span class="line">cat afterPropertiesSet init...</span><br><span class="line">postProcessAfterInitialization...cat=&gt;com.swg.bean.Cat@64c87930</span><br><span class="line">//同理</span><br><span class="line">pig constructor...</span><br><span class="line">postProcessBeforeInitialization...pig=&gt;com.swg.bean.Pig@4de5031f</span><br><span class="line">pig init...</span><br><span class="line">postProcessAfterInitialization...pig=&gt;com.swg.bean.Pig@4de5031f</span><br><span class="line"></span><br><span class="line">容器已经启动成功...</span><br><span class="line">五月 28, 2018 4:29:27 下午 org.springframework.context.annotation.AnnotationConfigApplicationContext doClose</span><br><span class="line">信息: Closing org.springframework.context.annotation.AnnotationConfigApplicationContext@16f65612: startup date [Mon May 28 16:29:26 CST 2018]; root of context hierarchy</span><br><span class="line"></span><br><span class="line">pig destory...</span><br><span class="line">cat destory...</span><br><span class="line">Dog destory...</span><br></pre></td></tr></table></figure>
<p>结合上面的执行初始化和销毁顺序，总结为下面的一张图：</p>
<p><img src="http://bloghello.oursnail.cn/Spring%E4%B8%ADBean%E7%9A%84%E5%AE%9E%E4%BE%8B%E5%8C%96%E8%BF%87%E7%A8%8B.jpg" alt="image"></p>
<h3 id="BeanPostProcessor原理"><a href="#BeanPostProcessor原理" class="headerlink" title="BeanPostProcessor原理"></a>BeanPostProcessor原理</h3><p>首先是创建<code>IOC</code>容器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AnnotationConfigApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext(MainConfigOfLifeCycle.class);</span><br></pre></td></tr></table></figure>
<p>进去之后是构造器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AnnotationConfigApplicationContext</span><span class="params">(Class... annotatedClasses)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>();</span><br><span class="line">    <span class="keyword">this</span>.register(annotatedClasses);</span><br><span class="line">    <span class="keyword">this</span>.refresh();<span class="comment">//刷新IOC容器</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个<code>refresh</code>方法中有<code>finishBeanFactoryInitialization</code>这个方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//初始化剩下的所有非懒记载的单例bean</span></span><br><span class="line"><span class="keyword">this</span>.finishBeanFactoryInitialization(beanFactory);</span><br></pre></td></tr></table></figure>
<p><code>finishBeanFactoryInitialization</code>这个方法中有一个方法是：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//真正初始化剩下的所有非懒记载的单例bean</span><br><span class="line">beanFactory.preInstantiateSingletons();</span><br></pre></td></tr></table></figure></p>
<p>下面就是获取<code>bean</code>，获取不到就创建对象。</p>
<p>上面已经完成了对象的创建。下面就是进行属性赋值和初始化工作。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、赋值</span><br><span class="line">先执行populateBean方法，是对bean进行属性赋值</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>、初始化</span><br><span class="line"><span class="comment">//遍历得到容器中所有的BeanPostProcessor：挨个执行beforeInitialization,一旦返回null，后置处理器就不会再执行</span></span><br><span class="line">applyBeanPostProcessorsBeforeInitialization<span class="comment">//初始化之前处理</span></span><br><span class="line">invokeInitMethods：执行初始化方法</span><br><span class="line">applyBeanPostProcessorsAfterInitialization<span class="comment">//初始化之后处理</span></span><br></pre></td></tr></table></figure></p>
<h3 id="BeanPostProcessor在spring底层的使用"><a href="#BeanPostProcessor在spring底层的使用" class="headerlink" title="BeanPostProcessor在spring底层的使用"></a>BeanPostProcessor在spring底层的使用</h3><p><code>@Autowired</code>这个注解底层就是<code>BeanPostProcessor</code>实现的</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li>执行初始化和销毁方法</li>
</ul>
<p>通过<code>@Bean</code>指定<code>init-destory</code>和<code>destory-method</code>方法</p>
<ul>
<li>通过让<code>Bean</code>实现<code>InitializingBean</code>（定义初始化逻辑）,<code>DisposableBean</code>（定义销毁前的逻辑）</li>
<li>通过使用<code>JSR250</code>规范中的<code>@PostConstruct</code>和<code>@PreDestory</code>来进行初始化工作和销毁之前的工作</li>
<li><code>BeanPostProcessor</code>：<code>bean</code>的后置处理器，在<code>bean</code>初始化前后进行一些处理工作</li>
</ul>
</div></article></div></main><footer><div class="paginator"><a href="/2018/07/21/13.高并发处理之消息队列思路/" class="prev">PREV</a><a href="/2018/07/21/12、深入fail-fast/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2019 <a href="http://yoursite.com">Eureka</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>