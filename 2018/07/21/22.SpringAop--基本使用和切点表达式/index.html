<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 22.SpringAop--基本使用和切点表达式 · Eureka-Home</title><meta name="description" content="22.SpringAop--基本使用和切点表达式 - Eureka"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Eureka-Home"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/sunweiguo" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">22.SpringAop--基本使用和切点表达式</h1><div class="post-info">Jul 21, 2018</div><div class="post-content"><p>spring aop继续学习。<br><a id="more"></a></p>
<h2 id="概览"><a href="#概览" class="headerlink" title="概览"></a>概览</h2><h4 id="基本认识"><a href="#基本认识" class="headerlink" title="基本认识"></a>基本认识</h4><ul>
<li>是一种编程范式，不是编程语言</li>
<li>解决特定问题，不能解决所有问题</li>
<li>是 OOP 的补充，不是替代</li>
</ul>
<h4 id="AOP设计初衷"><a href="#AOP设计初衷" class="headerlink" title="AOP设计初衷"></a>AOP设计初衷</h4><ul>
<li>解决代码重复性问题（核心要点一）</li>
<li>解决关注点分离问题（核心要点二）<ul>
<li>水平分离：展示层-》服务层-》持久层</li>
<li>垂直分离：模块划分（订单、库存）</li>
<li>切面分离：分离功能性需求和非功能徐求</li>
</ul>
</li>
</ul>
<h4 id="使用AOP的好处"><a href="#使用AOP的好处" class="headerlink" title="使用AOP的好处"></a>使用AOP的好处</h4><ul>
<li>集中处理某一关注点/横切逻辑</li>
<li>可以很方便地添加/删除关注点</li>
<li>侵入性少，增强代码可读性以及可维护性</li>
</ul>
<h4 id="AOP的应用场景"><a href="#AOP的应用场景" class="headerlink" title="AOP的应用场景"></a>AOP的应用场景</h4><ul>
<li>权限控制</li>
<li>缓存控制</li>
<li>事务控制</li>
<li>审计日志</li>
<li>性能监控</li>
<li>分布式追踪</li>
<li>异常处理</li>
</ul>
<h2 id="spring使用aop的一个demo测试"><a href="#spring使用aop的一个demo测试" class="headerlink" title="spring使用aop的一个demo测试"></a>spring使用aop的一个demo测试</h2><h4 id="案例背景"><a href="#案例背景" class="headerlink" title="案例背景"></a>案例背景</h4><ul>
<li>产品管理的服务</li>
<li>产品添加/删除的操作只能管理员才能进行</li>
<li>普通实现 vs AOP实现</li>
</ul>
<h4 id="创建工程"><a href="#创建工程" class="headerlink" title="创建工程"></a>创建工程</h4><p>代码地址：<a href="https://gitee.com/_swg/springaop" target="_blank" rel="noopener">https://gitee.com/_swg/springaop</a></p>
<p>搭建<code>spring-boot</code>工程（略）。</p>
<p>首先要有一个简单的实体类：<code>Product</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Product</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>逻辑层：<code>ProductService</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insert</span><span class="params">(Product product)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"insert product"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">(Long id)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"delete product"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果要实现插入/删除操作的权限控制，那么传统的做法是：我们写一个方法来判断这个user到底有没有权限操作嘛：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AuthService authService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insert</span><span class="params">(Product product)</span></span>&#123;</span><br><span class="line">        <span class="comment">//判断是否可以操作</span></span><br><span class="line">        authService.checkAccess();</span><br><span class="line">        System.out.println(<span class="string">"insert product"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">(Long id)</span></span>&#123;</span><br><span class="line">        <span class="comment">//判断是否可以操作</span></span><br><span class="line">        authService.checkAccess();</span><br><span class="line">        System.out.println(<span class="string">"delete product"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续来实现<code>authService</code>来模拟一下权限控制：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkAccess</span><span class="params">()</span></span>&#123;</span><br><span class="line">        String user = CurrentUserHolder.get();</span><br><span class="line">        <span class="comment">//user不是 admin 就没有权限，直接抛出异常</span></span><br><span class="line">        <span class="keyword">if</span>(!<span class="string">"admin"</span>.equals(user))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"没有权限操作"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们这个user信息是存放在<code>ThreadLocal</code>中的，不了解<code>ThreadLocal</code>的同学可以到我的 java基础 标签下查看最后两篇文章的详细讲解吧！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CurrentUserHolder</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;String&gt; holder = <span class="keyword">new</span> ThreadLocal&lt;String&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">get</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> holder.get() == <span class="keyword">null</span> ? <span class="string">"unkonwn"</span> : holder.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(String user)</span></span>&#123;</span><br><span class="line">        holder.set(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面就可以进行测试了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringaopApplicationTests</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> ProductService productService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//预期应该有异常</span></span><br><span class="line">	<span class="meta">@Test</span>(expected = Exception.class)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkDeleteUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		CurrentUserHolder.set(<span class="string">"tom"</span>);</span><br><span class="line">		productService.delete(<span class="number">1L</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//有权限，所以不抛异常</span></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkDeleteUser2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		CurrentUserHolder.set(<span class="string">"admin"</span>);</span><br><span class="line">		productService.delete(<span class="number">1L</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这种属于硬编码，增加代码复杂度，不容易维护。下面用AOP来实现。</p>
<p>首先是写一个切面类，确定切面的功能、发生时机：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityAspect</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AuthService authService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//只要出现注解了，那么下面的@Before就会先执行</span></span><br><span class="line">    <span class="comment">//制定哪些类那些方法可以执行@Advice的代码</span></span><br><span class="line">    <span class="meta">@Pointcut</span>(value = <span class="string">"@annotation(AdminOnly)"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">adminOnly</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//@Advice：执行时机</span></span><br><span class="line">    <span class="meta">@Before</span>(<span class="string">"adminOnly()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkAccess</span><span class="params">()</span></span>&#123;</span><br><span class="line">        authService.checkAccess();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Target</span>(&#123;ElementType.METHOD&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> AdminOnly &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么，我们只需要在需要权限验证的方法上增加一个注解，就可以自动完成权限的验证：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AdminOnly</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">(Long id)</span></span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"delete product"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试一把，如预期正确执行。</p>
<h2 id="PointCut-Express"><a href="#PointCut-Express" class="headerlink" title="PointCut Express"></a>PointCut Express</h2><p><img src="http://xiaozhao.oursnail.cn/PointcutExpression.png" alt="image"></p>
<ul>
<li><code>expression</code><ul>
<li><code>designators</code> : “excution()” 等</li>
<li><code>wildcards</code> : “*” 和 “..” 和 “+”</li>
<li><code>operators</code> : “&amp;&amp;” 和 “||” 和 “！”</li>
</ul>
</li>
</ul>
<h4 id="designators（指示器）"><a href="#designators（指示器）" class="headerlink" title="designators（指示器）"></a>designators（指示器）</h4><p>重点是了解 <code>execution()</code> ，其他的知道有就行了。</p>
<p><img src="http://xiaozhao.oursnail.cn/designators.png" alt="image"></p>
<p>其中，匹配对象：</p>
<ul>
<li><code>this</code>:匹配AOP对象的目标对象为指定类型的方法，即<code>DemoDao</code>的aop代理对象的方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Pointcut</span>(<span class="string">"this(com.swg.DemoDao)"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">thisDemo</span><span class="params">()</span></span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>target</code>:匹配实现IDao接口的目标对象（而不是aop代理后的对象）的方法，这里即DemoDao的方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Pointcut</span>(<span class="string">"target(com.swg.DemoDao)"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">targetDemo</span><span class="params">()</span></span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>bean</code>:匹配所有以Service结尾的bean里头的方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Pointcut</span>(<span class="string">"bean(*Service)"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beanDemo</span><span class="params">()</span></span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<h4 id="wildcards（通配符）"><a href="#wildcards（通配符）" class="headerlink" title="wildcards（通配符）"></a>wildcards（通配符）</h4><ul>
<li>“*” 匹配任意数量的字符</li>
<li>“+” 匹配制定类及其子类</li>
<li>“..” 一般用于匹配任意数的子包或参数</li>
</ul>
<h4 id="operators（运算符）"><a href="#operators（运算符）" class="headerlink" title="operators（运算符）"></a>operators（运算符）</h4><ul>
<li>“&amp;&amp;” 与操作符 </li>
<li>“||” 或操作符</li>
<li>“!” 非操作符</li>
</ul>
</div></article></div></main><footer><div class="paginator"><a href="/2018/07/21/23.SpringAop--动态代理模式/" class="prev">PREV</a><a href="/2018/07/21/21.spring aop基本使用/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2019 <a href="http://yoursite.com">Eureka</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>