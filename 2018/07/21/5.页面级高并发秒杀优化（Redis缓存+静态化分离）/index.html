<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>5.页面级高并发秒杀优化（Redis缓存+静态化分离） | Eureka-Home</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="在页面级别进行性能提升，比如用缓存和页面静态化技术。">
<meta name="keywords" content="秒杀系统实战">
<meta property="og:type" content="article">
<meta property="og:title" content="5.页面级高并发秒杀优化（Redis缓存+静态化分离）">
<meta property="og:url" content="http://yoursite.com/2018/07/21/5.页面级高并发秒杀优化（Redis缓存+静态化分离）/index.html">
<meta property="og:site_name" content="Eureka-Home">
<meta property="og:description" content="在页面级别进行性能提升，比如用缓存和页面静态化技术。">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2018-06-07T05:24:38.610Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="5.页面级高并发秒杀优化（Redis缓存+静态化分离）">
<meta name="twitter:description" content="在页面级别进行性能提升，比如用缓存和页面静态化技术。">
  
    <link rel="alternate" href="/atom.xml" title="Eureka-Home" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Eureka-Home</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">学习技术一口吃不成胖子，慢慢走，每天只要进步一丢丢！</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-5.页面级高并发秒杀优化（Redis缓存+静态化分离）" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/07/21/5.页面级高并发秒杀优化（Redis缓存+静态化分离）/" class="article-date">
  <time datetime="2018-07-21T03:56:21.602Z" itemprop="datePublished">2018-07-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      5.页面级高并发秒杀优化（Redis缓存+静态化分离）
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>在页面级别进行性能提升，比如用缓存和页面静态化技术。<br><a id="more"></a></p>
<h2 id="1-页面缓存"><a href="#1-页面缓存" class="headerlink" title="1. 页面缓存"></a>1. 页面缓存</h2><p>这里以商品列表页面为例。</p>
<p>原来的商品列表页面是这样写的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"to_list"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toList</span><span class="params">(Model model,MiaoshaUser user)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(user == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"login"</span>;</span><br><span class="line">    model.addAttribute(<span class="string">"user"</span>,user);</span><br><span class="line">    List&lt;GoodsVo&gt; goodsVoList = goodsService.getGoodsVoList();</span><br><span class="line">    model.addAttribute(<span class="string">"goodsList"</span>,goodsVoList);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"goods_list"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>给他添加页面缓存：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"to_list"</span>,produces = <span class="string">"text/html"</span>)</span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toList</span><span class="params">(Model model, MiaoshaUser user, HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(user == <span class="keyword">null</span>)&#123;</span><br><span class="line">        response.sendRedirect(<span class="string">"/login/to_login"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    model.addAttribute(<span class="string">"user"</span>,user);</span><br><span class="line">    <span class="comment">//先尝试从缓存中取</span></span><br><span class="line">    String html = redisService.get(GoodsKey.getGoodsList,<span class="string">""</span>,String.class);</span><br><span class="line">    <span class="keyword">if</span>(!StringUtils.isEmpty(html))&#123;</span><br><span class="line">        <span class="keyword">return</span> html;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//取不到，则手动渲染，再保存到redis</span></span><br><span class="line">    List&lt;GoodsVo&gt; goodsVoList = goodsService.getGoodsVoList();</span><br><span class="line">    model.addAttribute(<span class="string">"goodsList"</span>,goodsVoList);</span><br><span class="line">    SpringWebContext ctx = <span class="keyword">new</span> SpringWebContext(request,response,request.getServletContext(),</span><br><span class="line">                                                request.getLocale(), model.asMap(),applicationContext);</span><br><span class="line">    html = thymeleafViewResolver.getTemplateEngine().process(<span class="string">"goods_list"</span>,ctx);</span><br><span class="line">    <span class="keyword">if</span>(!StringUtils.isEmpty(html))&#123;</span><br><span class="line">        redisService.set(GoodsKey.getGoodsList,<span class="string">""</span>,html);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> html;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于商品详情页面的缓存，原来是这样写的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/to_detail/&#123;goodsId&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toDetail</span><span class="params">(@PathVariable(<span class="string">"goodsId"</span>)</span> <span class="keyword">long</span> goodsId,Model model, MiaoshaUser user)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(user == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"login"</span>;</span><br><span class="line">    model.addAttribute(<span class="string">"user"</span>,user);</span><br><span class="line"></span><br><span class="line">    GoodsVo goodsVo = goodsService.getGoodsVoByGoodsId(goodsId);</span><br><span class="line">    model.addAttribute(<span class="string">"goods"</span>,goodsVo);</span><br><span class="line">    <span class="keyword">long</span> startAt = goodsVo.getStartDate().getTime();</span><br><span class="line">    <span class="keyword">long</span> endAt = goodsVo.getEndDate().getTime();</span><br><span class="line">    <span class="keyword">long</span> now = System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">int</span> miaoshaStatus = <span class="number">0</span>;<span class="comment">//秒杀活动的状态，0-秒杀前；1-正在秒杀；2-秒杀结束</span></span><br><span class="line">    <span class="keyword">int</span> remainSeconds = <span class="number">0</span>;<span class="comment">//秒杀活动还剩多少秒</span></span><br><span class="line">    <span class="keyword">if</span>(now &lt; startAt)&#123;</span><br><span class="line">        miaoshaStatus = Constants.MiaoshaStatus.BEFORE_START;</span><br><span class="line">        remainSeconds = (<span class="keyword">int</span>)(startAt-now)/<span class="number">1000</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> (now &gt; endAt)&#123;</span><br><span class="line">        miaoshaStatus = Constants.MiaoshaStatus.AFTER_MIAOSHA;</span><br><span class="line">        remainSeconds = -<span class="number">1</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        miaoshaStatus = Constants.MiaoshaStatus.ON_MIAOSHA;</span><br><span class="line">        remainSeconds = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    model.addAttribute(<span class="string">"miaoshaStatus"</span>,miaoshaStatus);</span><br><span class="line">    model.addAttribute(<span class="string">"remainSeconds"</span>,remainSeconds);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"goods_detail"</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>现在改为如下，以<code>goodsid</code>作为区别：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/to_detail/&#123;goodsId&#125;"</span>,produces = <span class="string">"text/html"</span>)</span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toDetail</span><span class="params">(@PathVariable(<span class="string">"goodsId"</span>)</span> <span class="keyword">long</span> goodsId,Model model, MiaoshaUser user, HttpServletRequest request,</span></span><br><span class="line"><span class="function">                       HttpServletResponse response) <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(user == <span class="keyword">null</span>)&#123;</span><br><span class="line">        response.sendRedirect(<span class="string">"/login/to_login"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    model.addAttribute(<span class="string">"user"</span>,user);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//先尝试从缓存中取</span></span><br><span class="line">    String html = redisService.get(GoodsKey.getGoodsDetail,<span class="string">""</span>+goodsId,String.class);</span><br><span class="line">    <span class="keyword">if</span>(!StringUtils.isEmpty(html))&#123;</span><br><span class="line">        <span class="keyword">return</span> html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    GoodsVo goodsVo = goodsService.getGoodsVoByGoodsId(goodsId);</span><br><span class="line">    model.addAttribute(<span class="string">"goods"</span>,goodsVo);</span><br><span class="line">    <span class="keyword">long</span> startAt = goodsVo.getStartDate().getTime();</span><br><span class="line">    <span class="keyword">long</span> endAt = goodsVo.getEndDate().getTime();</span><br><span class="line">    <span class="keyword">long</span> now = System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">int</span> miaoshaStatus = <span class="number">0</span>;<span class="comment">//秒杀活动的状态，0-秒杀前；1-正在秒杀；2-秒杀结束</span></span><br><span class="line">    <span class="keyword">int</span> remainSeconds = <span class="number">0</span>;<span class="comment">//秒杀活动还剩多少秒</span></span><br><span class="line">    <span class="keyword">if</span>(now &lt; startAt)&#123;</span><br><span class="line">        miaoshaStatus = Constants.MiaoshaStatus.BEFORE_START;</span><br><span class="line">        remainSeconds = (<span class="keyword">int</span>)(startAt-now)/<span class="number">1000</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> (now &gt; endAt)&#123;</span><br><span class="line">        miaoshaStatus = Constants.MiaoshaStatus.AFTER_MIAOSHA;</span><br><span class="line">        remainSeconds = -<span class="number">1</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        miaoshaStatus = Constants.MiaoshaStatus.ON_MIAOSHA;</span><br><span class="line">        remainSeconds = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    model.addAttribute(<span class="string">"miaoshaStatus"</span>,miaoshaStatus);</span><br><span class="line">    model.addAttribute(<span class="string">"remainSeconds"</span>,remainSeconds);</span><br><span class="line"></span><br><span class="line">    SpringWebContext ctx = <span class="keyword">new</span> SpringWebContext(request,response,request.getServletContext(),</span><br><span class="line">            request.getLocale(), model.asMap(),applicationContext);</span><br><span class="line">    html = thymeleafViewResolver.getTemplateEngine().process(<span class="string">"goods_detail"</span>,ctx);</span><br><span class="line">    <span class="keyword">if</span>(!StringUtils.isEmpty(html))&#123;</span><br><span class="line">        redisService.set(GoodsKey.getGoodsDetail,<span class="string">""</span>+goodsId,html);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> html;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="2-对象缓存"><a href="#2-对象缓存" class="headerlink" title="2. 对象缓存"></a>2. 对象缓存</h2><p>就是对一个对象进行缓存，比如这里可以对<code>MiaoshaUser</code>这个对象进行缓存：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> MiaoshaUser <span class="title">getById</span><span class="params">(<span class="keyword">long</span> id)</span></span>&#123;</span><br><span class="line">    <span class="comment">//先去缓存取</span></span><br><span class="line">    MiaoshaUser user = redisService.get(MiaoshaUserKey.getById,<span class="string">""</span>+id,MiaoshaUser.class);</span><br><span class="line">    <span class="keyword">if</span>(user != <span class="keyword">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//缓存没有则去数据库取</span></span><br><span class="line">    user = miaoshaUserDao.getById(id);</span><br><span class="line">    <span class="keyword">if</span>(user != <span class="keyword">null</span>)&#123;</span><br><span class="line">        redisService.set(MiaoshaUserKey.getById,<span class="string">""</span>+user.getId(),user);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个逻辑是十分清晰的，但是如果我是更新一个信息呢？比如更新登录的用户的<code>Nickname</code>。那么就要注意，先更新数据库，在更新好数据库之后，一定要注意处理相关的缓存。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">updateUsername</span><span class="params">(String token,<span class="keyword">long</span> id,String newUsername)</span></span>&#123;</span><br><span class="line">    MiaoshaUser user = getById(id);</span><br><span class="line">    <span class="keyword">if</span>(user == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> GlobalException(CodeMsg.MOBILE_NOT_EXIST);</span><br><span class="line">    <span class="comment">//更新数据库</span></span><br><span class="line">    MiaoshaUser toBeUpdate = <span class="keyword">new</span> MiaoshaUser();</span><br><span class="line">    toBeUpdate.setId(id);</span><br><span class="line">    toBeUpdate.setNickname(newUsername);</span><br><span class="line">    miaoshaUserDao.update(toBeUpdate);</span><br><span class="line">    <span class="comment">//处理缓存</span></span><br><span class="line">    redisService.del(MiaoshaUserKey.getById,<span class="string">""</span>+id);</span><br><span class="line">    user.setNickname(newUsername);</span><br><span class="line">    redisService.set(MiaoshaUserKey.token,token,user);<span class="comment">//token不能直接删除，否则会要求重新登录</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-商品详情页面静态化"><a href="#3-商品详情页面静态化" class="headerlink" title="3. 商品详情页面静态化"></a>3. 商品详情页面静态化</h2><p>之前我们队商品详情页面进行了<code>redis</code>缓存，因为这个接口只是展示相应产品详情和秒杀倒计时等信息，只要显示几个关键信息即可，其他的都可以进行静态化。</p>
<p>这种技术，我们其实已经做过了，在之前的电商项目中，前端用<code>vue.js</code>等其他js框架或者不用框架，直接<code>jquery</code>。前端分为两部分，一部分是不改变的<code>html</code>块，还有一块就是数据，他只要后端传数据到前端即可，用到<code>ajax</code>技术。</p>
<p>确定哪些是需要传到前端的数据：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DetailVo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> miaoshaStatus = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> remainSeconds = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> GoodsVo goods;</span><br><span class="line">    <span class="keyword">private</span> MiaoshaUser user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将<code>detail</code>这个接口改为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/detail/&#123;goodsId&#125;"</span>)</span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Result&lt;DetailVo&gt; <span class="title">toDetail</span><span class="params">(@PathVariable(<span class="string">"goodsId"</span>)</span> <span class="keyword">long</span> goodsId, MiaoshaUser user, HttpServletRequest request,</span></span><br><span class="line"><span class="function">                                 HttpServletResponse response) <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(user == <span class="keyword">null</span>)&#123;</span><br><span class="line">        response.sendRedirect(<span class="string">"/login/to_login"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    GoodsVo goodsVo = goodsService.getGoodsVoByGoodsId(goodsId);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> startAt = goodsVo.getStartDate().getTime();</span><br><span class="line">    <span class="keyword">long</span> endAt = goodsVo.getEndDate().getTime();</span><br><span class="line">    <span class="keyword">long</span> now = System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">int</span> miaoshaStatus = <span class="number">0</span>;<span class="comment">//秒杀活动的状态，0-秒杀前；1-正在秒杀；2-秒杀结束</span></span><br><span class="line">    <span class="keyword">int</span> remainSeconds = <span class="number">0</span>;<span class="comment">//秒杀活动还剩多少秒</span></span><br><span class="line">    <span class="keyword">if</span>(now &lt; startAt)&#123;</span><br><span class="line">        miaoshaStatus = Constants.MiaoshaStatus.BEFORE_START;</span><br><span class="line">        remainSeconds = (<span class="keyword">int</span>)(startAt-now)/<span class="number">1000</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> (now &gt; endAt)&#123;</span><br><span class="line">        miaoshaStatus = Constants.MiaoshaStatus.AFTER_MIAOSHA;</span><br><span class="line">        remainSeconds = -<span class="number">1</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        miaoshaStatus = Constants.MiaoshaStatus.ON_MIAOSHA;</span><br><span class="line">        remainSeconds = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    DetailVo detailVo = <span class="keyword">new</span> DetailVo();</span><br><span class="line">    detailVo.setUser(user);</span><br><span class="line">    detailVo.setGoods(goodsVo);</span><br><span class="line">    detailVo.setMiaoshaStatus(miaoshaStatus);</span><br><span class="line">    detailVo.setRemainSeconds(remainSeconds);</span><br><span class="line">    <span class="keyword">return</span> Result.success(detailVo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>后端的数据已经有了，那么前端只要接收这些数据即可。</p>
<p>首先是在<code>static</code>目录下新建<code>goods_detail.htm</code>页面，里面讲<code>themeleaf</code>的动态获取的对象全部去除。改为最普通的<code>html</code>，只要用<code>id</code>来标识一下，然后在<code>js</code>中赋值即可。比如：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tr</span>&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;<span class="name">td</span>&gt;</span>商品原价<span class="tag">&lt;/<span class="name">td</span>&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;<span class="name">td</span> <span class="attr">colspan</span>=<span class="string">"3"</span> <span class="attr">id</span>=<span class="string">"goodsPrice"</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">tr</span>&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;<span class="name">td</span>&gt;</span>秒杀价<span class="tag">&lt;/<span class="name">td</span>&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;<span class="name">td</span> <span class="attr">colspan</span>=<span class="string">"3"</span>  <span class="attr">id</span>=<span class="string">"miaoshaPrice"</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">tr</span>&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;<span class="name">td</span>&gt;</span>库存数量<span class="tag">&lt;/<span class="name">td</span>&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;<span class="name">td</span> <span class="attr">colspan</span>=<span class="string">"3"</span>  <span class="attr">id</span>=<span class="string">"stockCount"</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>js</code>部分，首先是打开页面就执行这个方法：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="comment">//countDown();</span></span><br><span class="line">	getDetail();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>里面的<code>getDetail</code>方法为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getDetail</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> goodsId = g_getQueryString(<span class="string">"goodsId"</span>);</span><br><span class="line">	$.ajax(&#123;</span><br><span class="line">		url:<span class="string">"/goods/detail/"</span>+goodsId,</span><br><span class="line">		type:<span class="string">"GET"</span>,</span><br><span class="line">		success:<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(data.code == <span class="number">0</span>)&#123;</span><br><span class="line">				render(data.data);</span><br><span class="line">			&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">				layer.msg(data.msg);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;,</span><br><span class="line">		error:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">			layer.msg(<span class="string">"客户端请求有误"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>获取<code>goods_id</code>，因为<code>list</code>页面的商品详情请求是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;td&gt;&lt;a th:href=&quot;&apos;/goods_detail.htm?goodsId=&apos;+$&#123;goods.id&#125;&quot;&gt;详情&lt;/a&gt;&lt;/td&gt;</span><br></pre></td></tr></table></figure>
<p>所以下面要获取这个参数：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">g_getQueryString</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> reg = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">"(^|&amp;)"</span> + name + <span class="string">"=([^&amp;]*)(&amp;|$)"</span>);</span><br><span class="line"><span class="keyword">var</span> r = <span class="built_in">window</span>.location.search.substr(<span class="number">1</span>).match(reg);</span><br><span class="line"><span class="keyword">if</span>(r != <span class="literal">null</span>) <span class="keyword">return</span> <span class="built_in">unescape</span>(r[<span class="number">2</span>]);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>获取到之后就请求后端接口，获取数据去渲染：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">detail</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> miaoshaStatus = detail.miaoshaStatus;</span><br><span class="line">	<span class="keyword">var</span>  remainSeconds = detail.remainSeconds;</span><br><span class="line">	<span class="keyword">var</span> goods = detail.goods;</span><br><span class="line">	<span class="keyword">var</span> user = detail.user;</span><br><span class="line">	<span class="keyword">if</span>(user)&#123;</span><br><span class="line">		$(<span class="string">"#userTip"</span>).hide();</span><br><span class="line">	&#125;</span><br><span class="line">	$(<span class="string">"#goodsName"</span>).text(goods.goodsName);</span><br><span class="line">	$(<span class="string">"#goodsImg"</span>).attr(<span class="string">"src"</span>, goods.goodsImg);</span><br><span class="line">	$(<span class="string">"#startTime"</span>).text(<span class="keyword">new</span> <span class="built_in">Date</span>(goods.startDate).format(<span class="string">"yyyy-MM-dd hh:mm:ss"</span>));</span><br><span class="line">	$(<span class="string">"#remainSeconds"</span>).val(remainSeconds);</span><br><span class="line">	$(<span class="string">"#goodsId"</span>).val(goods.id);</span><br><span class="line">	$(<span class="string">"#goodsPrice"</span>).text(goods.goodsPrice);</span><br><span class="line">	$(<span class="string">"#miaoshaPrice"</span>).text(goods.miaoshaPrice);</span><br><span class="line">	$(<span class="string">"#stockCount"</span>).text(goods.stockCount);</span><br><span class="line">	countDown();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>倒计时<code>countDown()</code>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">countDown</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> remainSeconds = $(<span class="string">"#remainSeconds"</span>).val();</span><br><span class="line">	<span class="keyword">var</span> timeout;</span><br><span class="line">	<span class="keyword">if</span>(remainSeconds &gt; <span class="number">0</span>)&#123;<span class="comment">//秒杀还没开始，倒计时</span></span><br><span class="line">		$(<span class="string">"#buyButton"</span>).attr(<span class="string">"disabled"</span>, <span class="literal">true</span>);</span><br><span class="line">	   $(<span class="string">"#miaoshaTip"</span>).html(<span class="string">"秒杀倒计时："</span>+remainSeconds+<span class="string">"秒"</span>);</span><br><span class="line">		timeout = setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">			$(<span class="string">"#countDown"</span>).text(remainSeconds - <span class="number">1</span>);</span><br><span class="line">			$(<span class="string">"#remainSeconds"</span>).val(remainSeconds - <span class="number">1</span>);</span><br><span class="line">			countDown();</span><br><span class="line">		&#125;,<span class="number">1000</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span> <span class="keyword">if</span>(remainSeconds == <span class="number">0</span>)&#123;<span class="comment">//秒杀进行中</span></span><br><span class="line">		$(<span class="string">"#buyButton"</span>).attr(<span class="string">"disabled"</span>, <span class="literal">false</span>);</span><br><span class="line">		<span class="keyword">if</span>(timeout)&#123;</span><br><span class="line">			clearTimeout(timeout);</span><br><span class="line">		&#125;</span><br><span class="line">		$(<span class="string">"#miaoshaTip"</span>).html(<span class="string">"秒杀进行中"</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;<span class="comment">//秒杀已经结束</span></span><br><span class="line">		$(<span class="string">"#buyButton"</span>).attr(<span class="string">"disabled"</span>, <span class="literal">true</span>);</span><br><span class="line">		$(<span class="string">"#miaoshaTip"</span>).html(<span class="string">"秒杀已经结束"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的日期格式化为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//设定时间格式化函数，使用new Date().format("yyyyMMddhhmmss");</span></span><br><span class="line"><span class="built_in">Date</span>.prototype.format = <span class="function"><span class="keyword">function</span> (<span class="params">format</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> args = &#123;</span><br><span class="line">        <span class="string">"M+"</span>: <span class="keyword">this</span>.getMonth() + <span class="number">1</span>,</span><br><span class="line">        <span class="string">"d+"</span>: <span class="keyword">this</span>.getDate(),</span><br><span class="line">        <span class="string">"h+"</span>: <span class="keyword">this</span>.getHours(),</span><br><span class="line">        <span class="string">"m+"</span>: <span class="keyword">this</span>.getMinutes(),</span><br><span class="line">        <span class="string">"s+"</span>: <span class="keyword">this</span>.getSeconds(),</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span> (<span class="regexp">/(y+)/</span>.test(format))</span><br><span class="line">        format = format.replace(<span class="built_in">RegExp</span>.$<span class="number">1</span>, (<span class="keyword">this</span>.getFullYear() + <span class="string">""</span>).substr(<span class="number">4</span> - <span class="built_in">RegExp</span>.$<span class="number">1.</span>length));</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> args) &#123;</span><br><span class="line">        <span class="keyword">var</span> n = args[i];</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">"("</span> + i + <span class="string">")"</span>).test(format))</span><br><span class="line">            format = format.replace(<span class="built_in">RegExp</span>.$<span class="number">1</span>, <span class="built_in">RegExp</span>.$<span class="number">1.</span>length == <span class="number">1</span> ? n : (<span class="string">"00"</span> + n).substr((<span class="string">""</span> + n).length));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> format;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="4-订单详情页面静态化"><a href="#4-订单详情页面静态化" class="headerlink" title="4. 订单详情页面静态化"></a>4. 订单详情页面静态化</h2><p>之前的<code>do_miaosha</code>要进行修改，不能再返回<code>String</code>了，而是要返回<code>Json</code>数据，原来是这样写的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/do_miaosha"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">do_miaosha</span><span class="params">(Model model, MiaoshaUser user, @RequestParam(<span class="string">"goodsId"</span>)</span> <span class="keyword">long</span> goodsId)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(user == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"login"</span>;</span><br><span class="line">    model.addAttribute(<span class="string">"user"</span>,user);</span><br><span class="line">    <span class="comment">//判断库存</span></span><br><span class="line">    GoodsVo goodsVo = goodsService.getGoodsVoByGoodsId(goodsId);</span><br><span class="line">    <span class="keyword">if</span>(goodsVo.getStockCount() &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">        model.addAttribute(<span class="string">"errmsg"</span>, CodeMsg.MIAO_SHA_OVER.getMsg());</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"miaosha_fail"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//判断是否已经秒杀到了</span></span><br><span class="line">    MiaoshaOrder miaoshaOrder = orderService.getMiaoshaOrderByUserIdGoodsId(user.getId(),goodsId);</span><br><span class="line">    <span class="keyword">if</span>(miaoshaOrder != <span class="keyword">null</span>)&#123;</span><br><span class="line">        model.addAttribute(<span class="string">"errmsg"</span>, CodeMsg.REPEATE_MIAOSHA.getMsg());</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"miaosha_fail"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//减库存、下订单、写入秒杀订单,需要在一个事务中执行</span></span><br><span class="line">    OrderInfo orderInfo = miaoshaService.miaosha(user,goodsVo);</span><br><span class="line">    model.addAttribute(<span class="string">"orderInfo"</span>, orderInfo);</span><br><span class="line">    model.addAttribute(<span class="string">"goods"</span>, goodsVo);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"order_detail"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在改为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/do_miaosha"</span>,method = RequestMethod.POST)</span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Result&lt;OrderInfo&gt; <span class="title">do_miaosha</span><span class="params">(Model model, MiaoshaUser user, @RequestParam(<span class="string">"goodsId"</span>)</span> <span class="keyword">long</span> goodsId)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(user == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span> Result.error(CodeMsg.SESSION_ERROR);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//判断库存</span></span><br><span class="line">    GoodsVo goodsVo = goodsService.getGoodsVoByGoodsId(goodsId);</span><br><span class="line">    <span class="keyword">if</span>(goodsVo.getStockCount() &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.error(CodeMsg.MIAO_SHA_OVER);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//判断是否已经秒杀到了</span></span><br><span class="line">    MiaoshaOrder miaoshaOrder = orderService.getMiaoshaOrderByUserIdGoodsId(user.getId(),goodsId);</span><br><span class="line">    <span class="keyword">if</span>(miaoshaOrder != <span class="keyword">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.error(CodeMsg.REPEATE_MIAOSHA);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//减库存、下订单、写入秒杀订单,需要在一个事务中执行</span></span><br><span class="line">    OrderInfo orderInfo = miaoshaService.miaosha(user,goodsVo);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Result.success(orderInfo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面按秒杀按钮：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"btn btn-primary btn-block"</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">id</span>=<span class="string">"buyButton"</span><span class="attr">onclick</span>=<span class="string">"doMiaosha()"</span>&gt;</span>立即秒杀<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"goodsId"</span>  <span class="attr">id</span>=<span class="string">"goodsId"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>下面进行处理：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">doMiaosha</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	$.ajax(&#123;</span><br><span class="line">		url:<span class="string">"/miaosha/do_miaosha"</span>,</span><br><span class="line">		type:<span class="string">"POST"</span>,</span><br><span class="line">		data:&#123;</span><br><span class="line">			goodsId:$(<span class="string">"#goodsId"</span>).val(),</span><br><span class="line">		&#125;,</span><br><span class="line">		success:<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(data.code == <span class="number">0</span>)&#123;</span><br><span class="line">				<span class="built_in">window</span>.location.href=<span class="string">"/order_detail.htm?orderId="</span>+data.data.id;</span><br><span class="line">			&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">				layer.msg(data.msg);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;,</span><br><span class="line">		error:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">			layer.msg(<span class="string">"客户端请求有误"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>一旦抢到商品，那么就跳转到订单详情页面，<code>order_detail.htm</code>中的处理与上面的一样：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">detail</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> goods = detail.goods;</span><br><span class="line">	<span class="keyword">var</span> order = detail.order;</span><br><span class="line">	$(<span class="string">"#goodsName"</span>).text(goods.goodsName);</span><br><span class="line">	$(<span class="string">"#goodsImg"</span>).attr(<span class="string">"src"</span>, goods.goodsImg);</span><br><span class="line">	$(<span class="string">"#orderPrice"</span>).text(order.goodsPrice);</span><br><span class="line">	$(<span class="string">"#createDate"</span>).text(<span class="keyword">new</span> <span class="built_in">Date</span>(order.createDate).format(<span class="string">"yyyy-MM-dd hh:mm:ss"</span>));</span><br><span class="line">	<span class="keyword">var</span> status = <span class="string">""</span>;</span><br><span class="line">	<span class="keyword">if</span>(order.status == <span class="number">0</span>)&#123;</span><br><span class="line">		status = <span class="string">"未支付"</span></span><br><span class="line">	&#125;<span class="keyword">else</span> <span class="keyword">if</span>(order.status == <span class="number">1</span>)&#123;</span><br><span class="line">		status = <span class="string">"待发货"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	$(<span class="string">"#orderStatus"</span>).text(status);</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	getOrderDetail();</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getOrderDetail</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> orderId = g_getQueryString(<span class="string">"orderId"</span>);</span><br><span class="line">	$.ajax(&#123;</span><br><span class="line">		url:<span class="string">"/order/detail"</span>,</span><br><span class="line">		type:<span class="string">"GET"</span>,</span><br><span class="line">		data:&#123;</span><br><span class="line">			orderId:orderId</span><br><span class="line">		&#125;,</span><br><span class="line">		success:<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(data.code == <span class="number">0</span>)&#123;</span><br><span class="line">				render(data.data);</span><br><span class="line">			&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">				layer.msg(data.msg);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;,</span><br><span class="line">		error:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">			layer.msg(<span class="string">"客户端请求有误"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>要显示<code>order_detail</code>,他请求<code>/order/detail</code>这个接口，需要<code>order</code>和<code>goods</code>两个对象，所以新建一个<code>vo</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderDetailVo</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> GoodsVo goods;</span><br><span class="line">	<span class="keyword">private</span> OrderInfo order;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对<code>OrderController</code>增加接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/detail"</span>)</span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Result&lt;OrderDetailVo&gt; <span class="title">info</span><span class="params">(MiaoshaUser user,</span></span></span><br><span class="line"><span class="function"><span class="params">								  @RequestParam(<span class="string">"orderId"</span>)</span> <span class="keyword">long</span> orderId) </span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(user == <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> Result.error(CodeMsg.SESSION_ERROR);</span><br><span class="line">	&#125;</span><br><span class="line">	OrderInfo order = orderService.getOrderById(orderId);</span><br><span class="line">	<span class="keyword">if</span>(order == <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> Result.error(CodeMsg.ORDER_NOT_EXIST);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">long</span> goodsId = order.getGoodsId();</span><br><span class="line">	GoodsVo goods = goodsService.getGoodsVoByGoodsId(goodsId);</span><br><span class="line">	OrderDetailVo vo = <span class="keyword">new</span> OrderDetailVo();</span><br><span class="line">	vo.setOrder(order);</span><br><span class="line">	vo.setGoods(goods);</span><br><span class="line">	<span class="keyword">return</span> Result.success(vo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样就ok了，对于商品详情和订单详情两个页面完成了静态化。</p>
<h2 id="5-页面缓存"><a href="#5-页面缓存" class="headerlink" title="5. 页面缓存"></a>5. 页面缓存</h2><p><code>Cache-Control</code>:指定缓存有多少时间</p>
<p>为了在浏览器端进行缓存，以及控制缓存时间，这里可以添加一些配置：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">    resources:</span><br><span class="line">        <span class="keyword">static</span>-locations: classpath:/<span class="keyword">static</span>/</span><br><span class="line">        add-mappings: <span class="keyword">true</span></span><br><span class="line">        cache-period: <span class="number">3600</span></span><br><span class="line">        chain:</span><br><span class="line">          cache: <span class="keyword">true</span></span><br><span class="line">          enabled: <span class="keyword">true</span></span><br><span class="line">          gzipped: <span class="keyword">true</span></span><br><span class="line">          html-application-cache: <span class="keyword">true</span></span><br></pre></td></tr></table></figure></p>
<h2 id="6-解决超卖"><a href="#6-解决超卖" class="headerlink" title="6. 解决超卖"></a>6. 解决超卖</h2><p>先解决卖成负数的问题：</p>
<p>在<code>reduceStock(MiaoshaGoods g);</code>这个方法里，<code>sql</code>要多加一个<code>stock_count &gt; 0</code>即：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> miaosha_goods <span class="keyword">set</span> stock_count = stock_count<span class="number">-1</span> <span class="keyword">where</span> goods_id=#&#123;goodsId&#125; <span class="keyword">and</span> stock_count &gt; <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>给<code>miaosha_order</code>中的<code>user_id</code>和<code>goods_id</code>建立唯一联合索引。保证同一个人不能秒杀都两个商品。</p>
<p>但是从压测结果来看，虽然解决了上面两个问题。但是仍然发生了超卖现象，即比如只有10件秒杀商品，但是有22个人抢到了。这个解决只能靠锁来解决了。</p>
<h2 id="7-静态资源优化"><a href="#7-静态资源优化" class="headerlink" title="7. 静态资源优化"></a>7. 静态资源优化</h2><ul>
<li>js/css压缩</li>
<li>多个js/css组合，减少连接数</li>
<li>CDN就近访问</li>
<li>nginx加缓存，页面缓存，对象缓存</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/07/21/5.页面级高并发秒杀优化（Redis缓存+静态化分离）/" data-id="cjoocveh70064g4w6hjzydcf9" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/秒杀系统实战/">秒杀系统实战</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2018/07/21/5、hashcode和equals/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          5、hashcode和equals
        
      </div>
    </a>
  
  
    <a href="/2018/07/21/5.卖家订单部分/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">5.卖家订单部分</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/redis/">redis</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mysql/">Mysql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java基础/">java基础</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java容器/">java容器</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java并发基础/">java并发基础</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java并发进阶/">java并发进阶</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java虚拟机/">java虚拟机</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/leetcode/">leetcode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mybatis/">mybatis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql多数据源/">mysql多数据源</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/">nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis学习/">redis学习</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spring学习/">spring学习</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/剑指Offer/">剑指Offer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/单车后台系统实战/">单车后台系统实战</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/微信点餐系统/">微信点餐系统</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/技术短文杂记/">技术短文杂记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据结构与算法/">数据结构与算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/深入分析Java-Web技术内幕/">深入分析Java Web技术内幕</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/电商项目实战/">电商项目实战</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/秒杀系统实战/">秒杀系统实战</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/计算机网络及其他/">计算机网络及其他</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/设计模式/">设计模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/随笔/">随笔</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/面试/">面试</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Mysql/" style="font-size: 14px;">Mysql</a> <a href="/tags/java基础/" style="font-size: 16.67px;">java基础</a> <a href="/tags/java容器/" style="font-size: 16.67px;">java容器</a> <a href="/tags/java并发基础/" style="font-size: 16px;">java并发基础</a> <a href="/tags/java并发进阶/" style="font-size: 17.33px;">java并发进阶</a> <a href="/tags/java虚拟机/" style="font-size: 16.67px;">java虚拟机</a> <a href="/tags/leetcode/" style="font-size: 15.33px;">leetcode</a> <a href="/tags/mybatis/" style="font-size: 10px;">mybatis</a> <a href="/tags/mysql多数据源/" style="font-size: 10px;">mysql多数据源</a> <a href="/tags/nginx/" style="font-size: 10px;">nginx</a> <a href="/tags/redis学习/" style="font-size: 15.33px;">redis学习</a> <a href="/tags/spring学习/" style="font-size: 19.33px;">spring学习</a> <a href="/tags/剑指Offer/" style="font-size: 20px;">剑指Offer</a> <a href="/tags/单车后台系统实战/" style="font-size: 18px;">单车后台系统实战</a> <a href="/tags/微信点餐系统/" style="font-size: 14.67px;">微信点餐系统</a> <a href="/tags/技术短文杂记/" style="font-size: 11.33px;">技术短文杂记</a> <a href="/tags/数据结构与算法/" style="font-size: 13.33px;">数据结构与算法</a> <a href="/tags/深入分析Java-Web技术内幕/" style="font-size: 10px;">深入分析Java Web技术内幕</a> <a href="/tags/电商项目实战/" style="font-size: 18.67px;">电商项目实战</a> <a href="/tags/秒杀系统实战/" style="font-size: 13.33px;">秒杀系统实战</a> <a href="/tags/计算机网络及其他/" style="font-size: 13.33px;">计算机网络及其他</a> <a href="/tags/设计模式/" style="font-size: 12px;">设计模式</a> <a href="/tags/随笔/" style="font-size: 10.67px;">随笔</a> <a href="/tags/面试/" style="font-size: 12.67px;">面试</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/10/21/spring多数据源实现读写分离/">spring多数据源实现读写分离</a>
          </li>
        
          <li>
            <a href="/2018/10/19/navicate新建查询报错问题记录/">navicate新建查询报错问题记录</a>
          </li>
        
          <li>
            <a href="/2018/09/24/对于工厂模式的理解/">对于工厂模式的理解</a>
          </li>
        
          <li>
            <a href="/2018/09/24/三、设计模式-抽象工厂模式/">三、设计模式-抽象工厂模式</a>
          </li>
        
          <li>
            <a href="/2018/09/24/二、设计模式-工厂方法模式/">二、设计模式-工厂方法模式</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 Eureka<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>