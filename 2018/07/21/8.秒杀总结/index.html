<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 8.秒杀总结 · Eureka-Home</title><meta name="description" content="8.秒杀总结 - Eureka"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Eureka-Home"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/sunweiguo" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">8.秒杀总结</h1><div class="post-info">Jul 21, 2018</div><div class="post-content"><p>对于课程的总结。<br><a id="more"></a></p>
<h2 id="总体重点回顾"><a href="#总体重点回顾" class="headerlink" title="总体重点回顾"></a>总体重点回顾</h2><p>首先我们要熟悉一下表结构，核心的是商品表、秒杀商品表、订单信息表和秒杀订单表。</p>
<p>商品表：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`goods`</span>(</span><br><span class="line">	<span class="string">`id`</span> <span class="built_in">BIGINT</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'商品ID'</span>,</span><br><span class="line">	<span class="string">`goods_name`</span> <span class="built_in">VARCHAR</span>(<span class="number">16</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'商品名称'</span>,</span><br><span class="line">	<span class="string">`goods_title`</span> <span class="built_in">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'商品标题'</span>,</span><br><span class="line">	<span class="string">`goods_img`</span> <span class="built_in">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'商品图片'</span>,</span><br><span class="line">	<span class="string">`goods_detail`</span> LONGTEXT <span class="keyword">COMMENT</span> <span class="string">'商品的详情介绍'</span>,</span><br><span class="line">	<span class="string">`goods_price`</span> <span class="built_in">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="string">'0.00'</span> <span class="keyword">COMMENT</span> <span class="string">'商品单价'</span>,</span><br><span class="line">	<span class="string">`goods_stock`</span> <span class="built_in">INT</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'商品库存，-1表示没有限制'</span>,</span><br><span class="line">	PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure></p>
<p>秒杀商品表：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`miaosha_goods`</span>(</span><br><span class="line">	<span class="string">`id`</span> <span class="built_in">BIGINT</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'秒杀商品ID'</span>,</span><br><span class="line">	<span class="string">`goods_id`</span> <span class="built_in">BIGINT</span>(<span class="number">16</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'商品id'</span>,</span><br><span class="line">	<span class="string">`miaosha_price`</span> <span class="built_in">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="string">'0.00'</span> <span class="keyword">COMMENT</span> <span class="string">'秒杀价'</span>,</span><br><span class="line">	<span class="string">`stock_count`</span> <span class="built_in">INT</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'库存数量'</span>,</span><br><span class="line">	<span class="string">`start_date`</span> datetime <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'秒杀开始时间'</span>,</span><br><span class="line">	<span class="string">`end_date`</span> datetime <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'秒杀结束时间'</span>,</span><br><span class="line">	PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure></p>
<p>订单信息表：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`order_info`</span>(</span><br><span class="line">	<span class="string">`id`</span> <span class="built_in">BIGINT</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'order ID'</span>,</span><br><span class="line">	<span class="string">`user_id`</span> <span class="built_in">BIGINT</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'用户id'</span>,</span><br><span class="line">	<span class="string">`goods_id`</span> <span class="built_in">BIGINT</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'商品id'</span>,</span><br><span class="line">	<span class="string">`delivery_addr_id`</span> <span class="built_in">BIGINT</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'收货地址'</span>,</span><br><span class="line">	<span class="string">`goods_name`</span> <span class="built_in">VARCHAR</span>(<span class="number">16</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'商品名称'</span>,</span><br><span class="line">	<span class="string">`goods_count`</span> <span class="built_in">INT</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'商品数量'</span>,</span><br><span class="line">	<span class="string">`goods_price`</span> <span class="built_in">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="string">'0.00'</span> <span class="keyword">COMMENT</span> <span class="string">'商品单价'</span>,</span><br><span class="line">	<span class="string">`order_channel`</span> TINYINT(<span class="number">4</span>) <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'1pc,2android,3ios'</span>,</span><br><span class="line">	<span class="string">`status`</span> TINYINT(<span class="number">4</span>) <span class="keyword">DEFAULT</span> <span class="string">'0'</span> <span class="keyword">COMMENT</span> <span class="string">'0新建未支付，2已支付，3已发货4，已收货，5已完成'</span>,</span><br><span class="line">	<span class="string">`create_date`</span> datetime <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'订单创建时间'</span>,</span><br><span class="line">	<span class="string">`pay_date`</span> datetime <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'支付时间'</span>,</span><br><span class="line">	PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure></p>
<p>秒杀订单表：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`miaosha_order`</span>(</span><br><span class="line">	<span class="string">`id`</span> <span class="built_in">BIGINT</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'秒杀 order ID'</span>,</span><br><span class="line">	<span class="string">`user_id`</span> <span class="built_in">BIGINT</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'用户id'</span>,</span><br><span class="line">	<span class="string">`order_id`</span> <span class="built_in">BIGINT</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'订单id'</span>,</span><br><span class="line">	<span class="string">`goods_id`</span> <span class="built_in">BIGINT</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'商品id'</span>,</span><br><span class="line">	PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure></p>
<p>下面就是言归正传的进行秒杀功能的实现。由浅入深地来实现。</p>
<p>一开始想到的整体思路是：</p>
<ul>
<li>判断库存，根据秒杀商品的id来获取秒杀的库存</li>
<li>给用户id和秒杀商品id做成一个唯一组合索引，用它来判断这个用户是否已经秒杀到了</li>
<li>减库存成功，再生成订单，并且写入秒杀订单(同一事务中完成)</li>
</ul>
<blockquote>
<p>优化1：页面静态化</p>
</blockquote>
<p>我们可以用redis对html进行缓存，但是可能更好的方案是前台页面进行静态化，只需要与后端进行必要的数据交互即可。</p>
<p>注意，这里的核心是最后又一个减库存操作，减库存成功之后，下面再进行生成订单，这里为了<strong>防止库存降为负数</strong>，sql写成了：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> miaosha_goods <span class="keyword">set</span> stock_count = stock_count<span class="number">-1</span> <span class="keyword">where</span> goods_id=#&#123;goodsId&#125; <span class="keyword">and</span> stock_count &gt; <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>这里还可以用乐观锁来实现安全的减库存:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">num_old = <span class="keyword">select</span> available <span class="keyword">from</span> goods <span class="keyword">where</span> <span class="keyword">id</span> = xx <span class="keyword">and</span> available &gt;= <span class="number">1</span> ;</span><br><span class="line">num_new = num_old - 1 ;</span><br><span class="line"><span class="keyword">update</span> goods <span class="keyword">set</span> <span class="keyword">num</span>=num_new <span class="keyword">where</span> <span class="keyword">id</span>=xx <span class="keyword">and</span> <span class="keyword">num</span>=num_old ;</span><br></pre></td></tr></table></figure>
<p><strong>注意，当两个进程同时进来的时候，update操作对于id为主键索引的情况下，是会对数据加行锁。</strong> 所以，我们通过数据库的排他锁来防止两个线程同时修改同一条数据。</p>
<blockquote>
<p>优化2：消息队列+redis预减库存</p>
</blockquote>
<p>这里MQ用了<code>rabbitMQ</code>，其核心是<code>Exchange</code>(消息交换机，它指定消息按什么规则，路由到哪个队列)、<code>Queue</code>(消息队列载体，每个消息都会被投入到一个或多个队列)和<code>Binding</code>(绑定，它的作用就是把<code>exchange</code>和<code>queue</code>按照路由规则绑定起来),然后有四种交换机：Direct交换机、Topic交换机、Fanout交换机、Headers交换机。</p>
<p>总体思路是：减少数据库访问</p>
<ul>
<li>系统初始化，把商品库存数量加载到redis</li>
<li>收到请求，redis预减库存，库存不够，直接返回，否则进入3</li>
<li>请求入队，立即返回排队中</li>
<li>请求出队，生成订单，减少库存</li>
<li>客户端轮询，是否秒杀成功</li>
</ul>
<p>先将所有的秒杀商品的库存全部放进redis中，当秒杀接口被调用一次，redis就执行decr一次，如果redis中的库存已经小于等于0了，那么就立即返回失败。下面再进行判断是否是重复秒杀，最后是进入消息队列，慢慢让数据库去操作(判断数据库真实库存、减库存、生成订单等)。前端进行轮训，要么是排队中、要么是秒杀失败、要么是秒杀成功。</p>
<blockquote>
<p>优化3：秒杀地址接口隐藏</p>
</blockquote>
<p>实现思路：对于秒杀接口，不是直接去请求do_miaosha这个接口了，而是先去后端获取一个path(并且存进redis中<a href="key:userid_goodsid,value:path" target="_blank" rel="noopener">key:userid_goodsid,value:path</a>)，前端拿到这个path之后拼装到do_miaosha这个接口上去，秒杀接口，先拿到这个path验证一下是否正确，正确再进入下面的逻辑。这样，在秒杀开始前，都是不知道这个秒杀的链接到底是什么，有效防止了恶意的请求。</p>
<blockquote>
<p>优化4：图形验证码</p>
</blockquote>
<p>在秒杀开始的时候，仍然会存在恶意刷单的请求，这个时候接口地址已经确定下来了，如何防止这种情况呢（机器人），可以用验证码来实现。也可以分散用户的请求，减少并发。</p>
<blockquote>
<p>优化4：接口防刷</p>
</blockquote>
<p>限制用户在规定时间内请求的次数。</p>
<h2 id="再次总结"><a href="#再次总结" class="headerlink" title="再次总结"></a>再次总结</h2><p>一开始想到的整体思路是：</p>
<ul>
<li>判断库存，根据秒杀商品的id来获取秒杀的库存</li>
<li>给用户id和秒杀商品id做成一个唯一组合索引，用它来判断这个用户是否已经秒杀到了</li>
<li>减库存成功，再生成订单，并且写入秒杀订单(同一事务中完成)</li>
</ul>
<p>在此基础上进行优化：</p>
<ul>
<li>页面的静态化，即动静分离，前后端用ajax传递动态数据即可</li>
<li>更新数据库库存的sql</li>
<li>秒杀商品的库存先预存到redis中</li>
<li>减库存、生成订单的事务操作放进消息队列去处理</li>
<li>秒杀地址接口隐藏</li>
<li>图形验证码分散用户请求，减少并发</li>
<li>接口防刷，限制单个用户的请求数量</li>
</ul>
<p>面试问题：秒杀的场景下，如何解决库存超卖问题？</p>
<p>错误的回答：通过加分布式锁，通过数据库的乐观锁。。。</p>
<p>正确的回答：秒杀场景下，并发会特别的大，有两种情况会导致库存卖超：</p>
<ol>
<li>一个用户同时发出了多个请求，如果库存足够，没加限制，用户就可以下多个订单。</li>
<li>减库存的SQL上没有加库存数量的判断，并发的时候也会导致把库存减成负数。</li>
</ol>
<p>对于（1）前端加验证码，防止合法用户快速点鼠标同时发出多个请求，在后端的miaosha_order表中，对user_id和goods_id加唯一索引，确保就算是刷接口一个用户对一个商品绝对不会生成两个订单。对于（2）需要在扣减库存的SQL上加上库存数量的判断，只有扣减库存成功才可以生成订单：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> miaosha_goods <span class="keyword">set</span> stock_count = stock_count<span class="number">-1</span> <span class="keyword">where</span> goods_id=#&#123;goodsId&#125; <span class="keyword">and</span> stock_count &gt; <span class="number">0</span></span><br></pre></td></tr></table></figure>
<ul>
<li><a href="http://zhaoyixing.coding.me/2018/01/10/mysql-update-safe-md/?from=cnblogs" target="_blank" rel="noopener">mysql商品库存扣减问题总结</a></li>
</ul>
<p>还有一种方案来防止超卖并且速度比较快的方法是分布式锁。核心思路是用<code>setnx</code>和<code>getset</code>来实现锁，只让一个线程完成查库存-减库存-生成订单这一系列的操作。</p>
<ul>
<li><a href="http://www.cnblogs.com/VitoYi/p/8726070.html" target="_blank" rel="noopener">使用Redis分布式锁处理并发，解决超卖问题</a></li>
</ul>
</div></article></div></main><footer><div class="paginator"><a href="/2018/07/21/内连接和外连接/" class="prev">PREV</a><a href="/2018/07/21/随笔1/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2019 <a href="http://yoursite.com">Eureka</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>