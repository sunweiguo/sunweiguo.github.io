<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 十、LRU算法实现 · Eureka-Home</title><meta name="description" content="十、LRU算法实现 - Eureka"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Eureka-Home"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/sunweiguo" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">十、LRU算法实现</h1><div class="post-info">Aug 16, 2018</div><div class="post-content"><p>LRU算法实现。<br><a id="more"></a></p>
<h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><p><code>LRU</code>（<code>Least recently used</code>，最近最少使用）算法根据数据的历史访问记录来进行淘汰数据，其核心思想是“如果数据最近被访问过，那么将来被访问的几率也更高”。</p>
<h2 id="LinkedHashMap实现"><a href="#LinkedHashMap实现" class="headerlink" title="LinkedHashMap实现"></a>LinkedHashMap实现</h2><p><code>LinkedHashMap</code>自身已经实现了顺序存储，默认情况下是按照元素的添加顺序存储，也可以启用按照访问顺序存储，即最近读取的数据放在最前面，最早读取的数据放在最后面，然后它还有一个判断是否删除最老数据的方法，默认是返回false，即不删除数据.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//LinkedHashMap的一个构造函数，当参数accessOrder为true时</span></span><br><span class="line"><span class="comment">//会按照访问顺序排序，最近访问的放在最前，最早访问的放在后面</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">LinkedHashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity,<span class="keyword">float</span> loadFactor,<span class="keyword">boolean</span> accessOrder)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(initialCapacity, loadFactor);</span><br><span class="line">    <span class="keyword">this</span>.accessOrder = accessOrder;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//LinkedHashMap 默认返回false 则不删除节点。 返回true 代表要删除最早的节点。</span></span><br><span class="line"><span class="comment">//通常构建一个LruCache会在达到Cache的上限是返回true</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">removeEldestEntry</span><span class="params">(Map.Entry&lt;K,V&gt; eldest)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体实现：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LRUCache</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">LinkedHashMap</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> cacheSize;  <span class="comment">//缓存值大小</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LRUCache</span><span class="params">(<span class="keyword">int</span> cacheSize)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(<span class="number">16</span>, <span class="number">0.75f</span>, <span class="keyword">true</span>);  <span class="comment">//true设置按照访问顺序排序</span></span><br><span class="line">        <span class="keyword">this</span>.cacheSize = cacheSize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果LinkedHashMap的大小超过缓存值，返回true删除最早的数据</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">removeEldestEntry</span><span class="params">(Map.Entry&lt;K, V&gt; eldest)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> size() &gt;= cacheSize;  </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        LRUCache&lt;String, String&gt; cache = <span class="keyword">new</span> LRUCache&lt;&gt;(<span class="number">5</span>);</span><br><span class="line">        cache.put(<span class="string">"1"</span>, <span class="string">"1"</span>);</span><br><span class="line">        cache.put(<span class="string">"2"</span>, <span class="string">"2"</span>);</span><br><span class="line">        cache.put(<span class="string">"3"</span>, <span class="string">"3"</span>);</span><br><span class="line">        cache.put(<span class="string">"4"</span>, <span class="string">"4"</span>);</span><br><span class="line">        cache.put(<span class="string">"5"</span>, <span class="string">"5"</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"初始："</span>);</span><br><span class="line">        cache.keySet().forEach(System.out::println);<span class="comment">//2 3 4 5</span></span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"访问2："</span>);</span><br><span class="line">        cache.get(<span class="string">"2"</span>);</span><br><span class="line">        cache.keySet().forEach(System.out::println);<span class="comment">//3 4 5 2</span></span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"访问2、3："</span>);</span><br><span class="line">        cache.get(<span class="string">"2"</span>);</span><br><span class="line">        cache.get(<span class="string">"3"</span>);</span><br><span class="line">        cache.keySet().forEach(System.out::println);<span class="comment">//4 5 2 3</span></span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"增加数据6、7："</span>);</span><br><span class="line">        cache.put(<span class="string">"6"</span>, <span class="string">"6"</span>);</span><br><span class="line">        cache.put(<span class="string">"7"</span>, <span class="string">"7"</span>);</span><br><span class="line">        cache.keySet().forEach(System.out::println);<span class="comment">//2 3 6 7</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="HashMap原生实现"><a href="#HashMap原生实现" class="headerlink" title="HashMap原生实现"></a>HashMap原生实现</h2><p>将<code>Cache</code>的所有位置都用双链表连接起来，当一个位置被命中之后，就将通过调整链表的指向，将该位置调整到链表头的位置，新加入的<code>Cache</code>直接加到链表头中。 </p>
<p>这样，在多次进行<code>Cache</code>操作后，最近被命中的，就会被向链表头方向移动，而没有命中的，而想链表后面移动，链表尾则表示最近最少使用的<code>Cache</code>。 </p>
<p>当需要替换内容时候，链表的最后位置就是最少被命中的位置，我们只需要淘汰链表最后的部分即可。 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LRUCache1</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">//定义一个节点数据结构</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Entry</span>&lt;<span class="title">K</span>, <span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">        Entry pre;</span><br><span class="line">        Entry next;</span><br><span class="line">        K key;</span><br><span class="line">        V value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//最大缓存数量</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_CACHE_SIZE;</span><br><span class="line">    <span class="comment">//头指针</span></span><br><span class="line">    <span class="keyword">private</span> Entry first;</span><br><span class="line">    <span class="comment">//尾指针</span></span><br><span class="line">    <span class="keyword">private</span> Entry last;</span><br><span class="line">    <span class="keyword">private</span> HashMap&lt;K, Entry&lt;K, V&gt;&gt; hashMap;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">LRUCache1</span><span class="params">(<span class="keyword">int</span> cacheSize)</span> </span>&#123;</span><br><span class="line">        MAX_CACHE_SIZE = cacheSize;</span><br><span class="line">        hashMap = <span class="keyword">new</span> HashMap&lt;K, Entry&lt;K, V&gt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">        Entry entry = getEntry(key);</span><br><span class="line">        <span class="keyword">if</span> (entry == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (hashMap.size() &gt;= MAX_CACHE_SIZE) &#123;</span><br><span class="line">                hashMap.remove(last.key);</span><br><span class="line">                removeLast();</span><br><span class="line">            &#125;</span><br><span class="line">            entry = <span class="keyword">new</span> Entry();</span><br><span class="line">            entry.key = key;</span><br><span class="line">        &#125;</span><br><span class="line">        entry.value = value;</span><br><span class="line">        moveToFirst(entry);</span><br><span class="line">        hashMap.put(key, entry);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(K key)</span> </span>&#123;</span><br><span class="line">        Entry&lt;K, V&gt; entry = getEntry(key);</span><br><span class="line">        <span class="keyword">if</span> (entry == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        moveToFirst(entry);</span><br><span class="line">        <span class="keyword">return</span> entry.value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据key获取节点</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Entry&lt;K, V&gt; <span class="title">getEntry</span><span class="params">(K key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> hashMap.get(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">moveToFirst</span><span class="params">(Entry entry)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (entry == first) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">if</span> (entry.pre != <span class="keyword">null</span>) entry.pre.next = entry.next;</span><br><span class="line">        <span class="keyword">if</span> (entry.next != <span class="keyword">null</span>) entry.next.pre = entry.pre;</span><br><span class="line">        <span class="keyword">if</span> (entry == last) last = last.pre;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (first == <span class="keyword">null</span> || last == <span class="keyword">null</span>) &#123;</span><br><span class="line">            first = last = entry;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        entry.next = first;</span><br><span class="line">        first.pre = entry;</span><br><span class="line">        first = entry;</span><br><span class="line">        entry.pre = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">removeLast</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (last != <span class="keyword">null</span>) &#123;</span><br><span class="line">            last = last.pre;</span><br><span class="line">            <span class="keyword">if</span> (last == <span class="keyword">null</span>) first = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">else</span> last.next = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        LRUCache1&lt;String, String&gt; cache = <span class="keyword">new</span> LRUCache1&lt;&gt;(<span class="number">5</span>);</span><br><span class="line">        cache.put(<span class="string">"1"</span>, <span class="string">"1"</span>);</span><br><span class="line">        cache.put(<span class="string">"2"</span>, <span class="string">"2"</span>);</span><br><span class="line">        cache.put(<span class="string">"3"</span>, <span class="string">"3"</span>);</span><br><span class="line">        cache.put(<span class="string">"4"</span>, <span class="string">"4"</span>);</span><br><span class="line">        cache.put(<span class="string">"5"</span>, <span class="string">"5"</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"初始："</span>);</span><br><span class="line">        cache.hashMap.keySet().forEach(System.out::println);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"访问2："</span>);</span><br><span class="line">        cache.get(<span class="string">"2"</span>);</span><br><span class="line">        cache.hashMap.keySet().forEach(System.out::println);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"访问2、3："</span>);</span><br><span class="line">        cache.get(<span class="string">"2"</span>);</span><br><span class="line">        cache.get(<span class="string">"3"</span>);</span><br><span class="line">        cache.hashMap.keySet().forEach(System.out::println);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"增加数据6、7："</span>);</span><br><span class="line">        cache.put(<span class="string">"6"</span>, <span class="string">"6"</span>);</span><br><span class="line">        cache.put(<span class="string">"7"</span>, <span class="string">"7"</span>);</span><br><span class="line">        cache.hashMap.keySet().forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></article></div></main><footer><div class="paginator"><a href="/2018/08/16/十一、链表问题的总结/" class="prev">PREV</a><a href="/2018/08/16/九、贪心算法/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2019 <a href="http://yoursite.com">Eureka</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>