<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 自己实现一个简单的web服务器 · fossi</title><meta name="description" content="自己实现一个简单的web服务器 - fossi"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"></head><body><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">首页</a></li><li class="nav-list-item"><a href="https://sunweiguo.github.io/tags/" target="_blank" class="nav-list-link">标签</a></li><li class="nav-list-item"><a href="http://bloghello.oursnail.cn/test.html" target="_blank" class="nav-list-link">爱情</a></li><li class="nav-list-item"><a href="https://github.com/sunweiguo" target="_blank" class="nav-list-link">GIT</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">自己实现一个简单的web服务器</h1><div class="post-meta"><span class="post-time">Feb 18, 2019</span></div><div class="post-content"><p>这里涉及网络编程的基本知识以及HTTP协议的基本认识，下面来一步一步实现一下最简单的一个web服务器。</p>
<a id="more"></a>
<h2>一、用户请求域名到底发送了什么信息来</h2>
<p>如果服务端都不知道客户端发来的是什么，那何谈对内容的解析呢？所以我们首先在服务端解析客户端的访问信息，比如我们比较关心的是请求的是什么路径：</p>
<p><img src="http://bloghello.oursnail.cn/thread17-1.png" alt="image"></p>
<p>此时我们访问地址： localhost:8888 打印出来的结果为：</p>
<p><img src="http://bloghello.oursnail.cn/thread17-2.png" alt="image"></p>
<p>其实对于我们这种比较简单的实现来说，红框的信息已经足够了。我们只要知道客户端要发来的资源名字是什么，我们根据这个名字取找响应的资源返回给客户端展示即可。由于我其实请求的是根路径，所以是<code>/</code>。如果我在这里请求 localhost:8888/index.html 那么就会显示 <code>GET /index.html HTTP/1.1</code>这样的信息。不再演示。</p>
<p>但是上面的写法是存在问题的，仅仅是演示而用，因为它会一直等待输入。</p>
<p>那么，不用<code>while</code>一直等待，而且只需要第一行即可，那么可以这样写：</p>
<p><img src="http://bloghello.oursnail.cn/thread17-3.png" alt="image"></p>
<p>好了，不能总之只接收吧，我们服务端要给客户端点什么。</p>
<h2>二、服务端如何响应资源给客户端展示</h2>
<p>首先我们得有资源才能展示，假设我们要展示<code>index.html</code>，我们将其暂时放在<code>F:/webrooot</code>下。</p>
<p>内容暂时为：</p>
<p><img src="http://bloghello.oursnail.cn/thread17-4.png" alt="image"></p>
<p>只是展示一下欢迎信息而已。服务端就需要读取这个文件，然后以流的形式发送给客户端的浏览器上，浏览器再解析展示。</p>
<p><img src="http://bloghello.oursnail.cn/thread17-5.png" alt="image"></p>
<p>此时再去访问页面，就会显示欢迎的信息啦！</p>
<p><img src="http://bloghello.oursnail.cn/thread17-6.png" alt="image"></p>
<p>这里没有关闭流，也没有关闭<code>socket</code>，不过下面都会关闭掉。这个不重要，重要的是，这玩意都是在主线程中做的，显然不如多线程来的快，并且全写在主线程里，肯定是不够好的。下面就用多线程来实现。</p>
<h2>三、普通的多线程实现方式</h2>
<p><img src="http://bloghello.oursnail.cn/thread17-7.png" alt="image"></p>
<p>就是在这个线程中处理数据和返回数据。</p>
<p><img src="http://bloghello.oursnail.cn/thread17-8.png" alt="image"></p>
<p>其很简单，但是如果我想显示一张图片呢？</p>
<p>比如我的根目录下有一张图片叫做：<code>hh.jpg</code></p>
<p><img src="http://bloghello.oursnail.cn/thread17-9.png" alt="image"></p>
<p>很显然现在还是无法展示的，原因是我这里写死了是以<code>text/html</code>的形式响应，但是图片正确的响应是<code>image/jpeg</code>这种格式。</p>
<p>所以我们不能无脑写死，要进行适当的判断才行。下面贴出代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerThread</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">    <span class="comment">//根目录</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String webroot = <span class="string">"F:\\webroot\\"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Socket client;</span><br><span class="line">    InputStream ins;</span><br><span class="line">    OutputStream out;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//存放类型，比如jpg对应的是image/jpeg，这是http协议规定的每种类型的响应格式</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String,String&gt; contentMap =  <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        contentMap.put(<span class="string">"html"</span>,<span class="string">"text/html;charset=utf-8"</span>);</span><br><span class="line">        contentMap.put(<span class="string">"jpg"</span>,<span class="string">"image/jpeg"</span>);</span><br><span class="line">        contentMap.put(<span class="string">"png"</span>,<span class="string">"image/jpeg"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ServerThread</span><span class="params">(Socket client)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.client = client;</span><br><span class="line">        init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ins = client.getInputStream();</span><br><span class="line">            out = client.getOutputStream();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            go();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">go</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">//获取请求内容</span></span><br><span class="line">        BufferedReader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(ins));</span><br><span class="line">        <span class="comment">//获取到请求的资源名称</span></span><br><span class="line">        String line = reader.readLine().split(<span class="string">" "</span>)[<span class="number">1</span>].replace(<span class="string">"/"</span>,<span class="string">"\\"</span>);</span><br><span class="line">        <span class="keyword">if</span>(line.equals(<span class="string">"\\"</span>))&#123;</span><br><span class="line">            line += <span class="string">"index.html"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(line);</span><br><span class="line">        <span class="comment">//拼接起来就是资源的完整路径</span></span><br><span class="line">        File file = <span class="keyword">new</span> File(webroot + line);</span><br><span class="line">        <span class="comment">//判断是否存在，存在则响应内容，不存在则告知不存在</span></span><br><span class="line">        <span class="keyword">if</span> (file.exists()) &#123;</span><br><span class="line">            <span class="comment">//给用户响应</span></span><br><span class="line">            PrintWriter pw = <span class="keyword">new</span> PrintWriter(out);</span><br><span class="line">            InputStream i = <span class="keyword">new</span> FileInputStream(webroot + line);</span><br><span class="line">            <span class="comment">//由于需要将图片也要传给前端，再用这个就不好办了，得用普通的文件输入流</span></span><br><span class="line"><span class="comment">//          BufferedReader fr = new BufferedReader(new InputStreamReader(i));</span></span><br><span class="line">            pw.println(<span class="string">"HTTP/1.1 200 OK"</span>);</span><br><span class="line">            <span class="comment">//返回的类型是动态判断的，图片用图片的类型，文本用文本的类型</span></span><br><span class="line">            String s = contentMap.get(line.substring(line.lastIndexOf(<span class="string">"."</span>)+<span class="number">1</span>,line.length()));</span><br><span class="line">            System.out.println(<span class="string">"返回的类型为："</span>+ s);</span><br><span class="line">            pw.println(<span class="string">"Content-Type: "</span> + s);</span><br><span class="line">            pw.println(<span class="string">"Content-Length:"</span> + i.available());</span><br><span class="line">            pw.println(<span class="string">"Server: hello-server"</span>);</span><br><span class="line">            pw.println(<span class="string">"Date:"</span>+ <span class="keyword">new</span> Date());</span><br><span class="line">            pw.println(<span class="string">""</span>);</span><br><span class="line">            pw.flush();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//写入输出流中通过PrintWriter发给浏览器</span></span><br><span class="line">            <span class="keyword">byte</span>[] buff = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            <span class="keyword">int</span> len = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> ( (len = i.read(buff)) != -<span class="number">1</span>)&#123;</span><br><span class="line">                out.write(buff,<span class="number">0</span>,len);</span><br><span class="line">            &#125;</span><br><span class="line">            pw.flush();</span><br><span class="line">            pw.close();</span><br><span class="line">            i.close();</span><br><span class="line">            reader.close();</span><br><span class="line">            client.close();</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            StringBuffer error = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">            error.append(<span class="string">"HTTP /1.1 400 file not found /r/n"</span>);</span><br><span class="line">            error.append(<span class="string">"Content-Type:text/html \r\n"</span>);</span><br><span class="line">            error.append(<span class="string">"Content-Length:20 \r\n"</span>).append(<span class="string">"\r\n"</span>);</span><br><span class="line">            error.append(<span class="string">"&lt;h1 &gt;File Not Found..&lt;/h1&gt;"</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                out.write(error.toString().getBytes());</span><br><span class="line">                out.flush();</span><br><span class="line">                out.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ok,你会发现，我还添加了判断资源存在不存在的逻辑，这样显得更加健全一点。</p>
<p>当找得到资源得时候：</p>
<p><img src="http://bloghello.oursnail.cn/thread17-10.png" alt="image"></p>
<p>当找不到资源得时候：</p>
<p><img src="http://bloghello.oursnail.cn/thread17-11.png" alt="image"></p>
<h2>四、线程池方式</h2>
<p>其实很简单，线程池的优势以前也说过，不赘述，直接贴一下代码结束。</p>
<p><img src="http://bloghello.oursnail.cn/thread17-12.png" alt="image"></p>
<p>至此，我们完成了一个比较简单的web服务器的开发。</p>
</div></article></div></section><footer><div class="paginator"><a href="/2019/02/19/java-basic/java基础之异常/" class="prev">PRVE</a><a href="/2019/02/17/java-basic/java基础之JDK动态代理/" class="next">NEXT</a></div><div id="container"></div><link rel="stylesheet" href="//billts.site/extra_css/gitment.css">
<script src="//billts.site/js/gitment.js"></script><script>var gitment = new Gitment({
    id: 'Mon Feb 18 2019 20:28:38 GMT+0800',
    owner: 'sunweiguo',
    repo: 'sunweiguo.github.io',
    oauth: {
        client_id: '56c422eddebac740f021',
        client_secret: 'b0520b7f71d5d883e029133f06c3328e3d3168e1',
    },
})
gitment.render('container')</script><div class="copyright"><p>© 2019 - 2020 <a href="http://yoursite.com">fossi</a>,苏ICP备17064972号.</p></div></footer><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-134836068-1",'auto');ga('send','pageview');</script><script src="https://cdn.bootcss.com/mathjax/2.5.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>