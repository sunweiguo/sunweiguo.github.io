<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 3.天气预报系统-天气数据同步 · fossi</title><meta name="description" content="3.天气预报系统-天气数据同步 - fossi"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"></head><body><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">博客</a></li><li class="nav-list-item"><a href="https://sunweiguo.github.io/tags/" target="_blank" class="nav-list-link">标签</a></li><li class="nav-list-item"><a href="http://bloghello.oursnail.cn/test.html" target="_blank" class="nav-list-link">爱情</a></li><li class="nav-list-item"><a href="https://github.com/sunweiguo" target="_blank" class="nav-list-link">GIT</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">3.天气预报系统-天气数据同步</h1><div class="post-meta"><span class="post-time">Feb 21, 2019</span></div><div class="post-content"><p>这是学习的第三篇文章，由于天气信息需要更新，所以我们需要一个定时器定时去获取一下最新的信息。由于本项目实现比较简单就可以用quartz来实现。</p>
<a id="more"></a>
<h2>quartz如何整合</h2>
<p>数据需要定时地刷新，不能等到用户来获取的时候才更新，这里用最常用的quartz定时器来实现。</p>
<p>首先时引入依赖：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-quartz&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p>下面定义一个执行的任务，先什么都不干，就打印一句话即可：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WeatherDataSyncJob</span> <span class="keyword">extends</span> <span class="title">QuartzJobBean</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">executeInternal</span><span class="params">(JobExecutionContext context)</span> <span class="keyword">throws</span> JobExecutionException </span>&#123;</span><br><span class="line">        log.info(<span class="string">"天气数据同步任务开始"</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面要定义配置类：</p>
<p>首先是要定义这个任务的细节：<code>JobDetail</code>，就是说我们配置的这个quartz里面的任务是谁？给他起个名字啥的。</p>
<p>后面个是定义触发器，决定了刚才定义的这个<code>JobDetail</code>多长时间执行一次。这里是为了模拟想过，定义了两秒就执行一次。那么我们启动项目后，看到的效果应该是每两秒打印一次日志。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QuartzConfig</span> </span>&#123;</span><br><span class="line">    <span class="comment">//定义一个jobDetail,就是注册一个定时任务，具体如何执行时在WeatherDataSyncJob中定义</span></span><br><span class="line">    <span class="comment">//具体何时执行，是下面的Trigger定义</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JobDetail <span class="title">weatherDataSyncDetail</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> JobBuilder.newJob(WeatherDataSyncJob.class).</span><br><span class="line">                withIdentity(<span class="string">"WeatherDataSyncJob"</span>).</span><br><span class="line">                storeDurably().build();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//触发器</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Trigger <span class="title">weatherDataSyncTrigger</span><span class="params">()</span></span>&#123;</span><br><span class="line">        SimpleScheduleBuilder scheduleBuilder = SimpleScheduleBuilder</span><br><span class="line">                    .simpleSchedule()</span><br><span class="line">                        .withIntervalInSeconds(<span class="number">2</span>)<span class="comment">//两秒去自动执行一次</span></span><br><span class="line">                            .repeatForever();</span><br><span class="line">        <span class="keyword">return</span> TriggerBuilder.newTrigger().forJob(weatherDataSyncDetail())</span><br><span class="line">                .withIdentity(<span class="string">"weatherDataSyncTrigger"</span>)</span><br><span class="line">                .withSchedule(scheduleBuilder).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2>拉取城市信息</h2>
<p>网站： <a href="http://mobile.weather.com.cn/js/citylist.xml" target="_blank" rel="noopener">http://mobile.weather.com.cn/js/citylist.xml</a></p>
<p>比如我将江苏省的单独拿出来：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">xml</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">c</span> <span class="attr">c1</span>=<span class="string">"0"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190101"</span> <span class="attr">d2</span>=<span class="string">"南京"</span> <span class="attr">d3</span>=<span class="string">"nanjing"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190102"</span> <span class="attr">d2</span>=<span class="string">"溧水"</span> <span class="attr">d3</span>=<span class="string">"lishui"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190103"</span> <span class="attr">d2</span>=<span class="string">"高淳"</span> <span class="attr">d3</span>=<span class="string">"gaochun"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190104"</span> <span class="attr">d2</span>=<span class="string">"江宁"</span> <span class="attr">d3</span>=<span class="string">"jiangning"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190105"</span> <span class="attr">d2</span>=<span class="string">"六合"</span> <span class="attr">d3</span>=<span class="string">"luhe"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190106"</span> <span class="attr">d2</span>=<span class="string">"江浦"</span> <span class="attr">d3</span>=<span class="string">"jiangpu"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190107"</span> <span class="attr">d2</span>=<span class="string">"浦口"</span> <span class="attr">d3</span>=<span class="string">"pukou"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190201"</span> <span class="attr">d2</span>=<span class="string">"无锡"</span> <span class="attr">d3</span>=<span class="string">"wuxi"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190202"</span> <span class="attr">d2</span>=<span class="string">"江阴"</span> <span class="attr">d3</span>=<span class="string">"jiangyin"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190203"</span> <span class="attr">d2</span>=<span class="string">"宜兴"</span> <span class="attr">d3</span>=<span class="string">"yixing"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190204"</span> <span class="attr">d2</span>=<span class="string">"锡山"</span> <span class="attr">d3</span>=<span class="string">"xishan"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190301"</span> <span class="attr">d2</span>=<span class="string">"镇江"</span> <span class="attr">d3</span>=<span class="string">"zhenjiang"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190302"</span> <span class="attr">d2</span>=<span class="string">"丹阳"</span> <span class="attr">d3</span>=<span class="string">"danyang"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190303"</span> <span class="attr">d2</span>=<span class="string">"扬中"</span> <span class="attr">d3</span>=<span class="string">"yangzhong"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190304"</span> <span class="attr">d2</span>=<span class="string">"句容"</span> <span class="attr">d3</span>=<span class="string">"jurong"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190305"</span> <span class="attr">d2</span>=<span class="string">"丹徒"</span> <span class="attr">d3</span>=<span class="string">"dantu"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190401"</span> <span class="attr">d2</span>=<span class="string">"苏州"</span> <span class="attr">d3</span>=<span class="string">"suzhou"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190402"</span> <span class="attr">d2</span>=<span class="string">"常熟"</span> <span class="attr">d3</span>=<span class="string">"changshu"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190403"</span> <span class="attr">d2</span>=<span class="string">"张家港"</span> <span class="attr">d3</span>=<span class="string">"zhangjiagang"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190404"</span> <span class="attr">d2</span>=<span class="string">"昆山"</span> <span class="attr">d3</span>=<span class="string">"kunshan"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190405"</span> <span class="attr">d2</span>=<span class="string">"吴中"</span> <span class="attr">d3</span>=<span class="string">"wuzhong"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190407"</span> <span class="attr">d2</span>=<span class="string">"吴江"</span> <span class="attr">d3</span>=<span class="string">"wujiang"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190408"</span> <span class="attr">d2</span>=<span class="string">"太仓"</span> <span class="attr">d3</span>=<span class="string">"taicang"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190501"</span> <span class="attr">d2</span>=<span class="string">"南通"</span> <span class="attr">d3</span>=<span class="string">"nantong"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190502"</span> <span class="attr">d2</span>=<span class="string">"海安"</span> <span class="attr">d3</span>=<span class="string">"haian"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190503"</span> <span class="attr">d2</span>=<span class="string">"如皋"</span> <span class="attr">d3</span>=<span class="string">"rugao"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190504"</span> <span class="attr">d2</span>=<span class="string">"如东"</span> <span class="attr">d3</span>=<span class="string">"rudong"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190507"</span> <span class="attr">d2</span>=<span class="string">"启东"</span> <span class="attr">d3</span>=<span class="string">"qidong"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190508"</span> <span class="attr">d2</span>=<span class="string">"海门"</span> <span class="attr">d3</span>=<span class="string">"haimen"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190509"</span> <span class="attr">d2</span>=<span class="string">"通州"</span> <span class="attr">d3</span>=<span class="string">"tongzhou"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190601"</span> <span class="attr">d2</span>=<span class="string">"扬州"</span> <span class="attr">d3</span>=<span class="string">"yangzhou"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190602"</span> <span class="attr">d2</span>=<span class="string">"宝应"</span> <span class="attr">d3</span>=<span class="string">"baoying"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190603"</span> <span class="attr">d2</span>=<span class="string">"仪征"</span> <span class="attr">d3</span>=<span class="string">"yizheng"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190604"</span> <span class="attr">d2</span>=<span class="string">"高邮"</span> <span class="attr">d3</span>=<span class="string">"gaoyou"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190605"</span> <span class="attr">d2</span>=<span class="string">"江都"</span> <span class="attr">d3</span>=<span class="string">"jiangdu"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190606"</span> <span class="attr">d2</span>=<span class="string">"邗江"</span> <span class="attr">d3</span>=<span class="string">"hanjiang"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190701"</span> <span class="attr">d2</span>=<span class="string">"盐城"</span> <span class="attr">d3</span>=<span class="string">"yancheng"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190702"</span> <span class="attr">d2</span>=<span class="string">"响水"</span> <span class="attr">d3</span>=<span class="string">"xiangshui"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190703"</span> <span class="attr">d2</span>=<span class="string">"滨海"</span> <span class="attr">d3</span>=<span class="string">"binhai"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190704"</span> <span class="attr">d2</span>=<span class="string">"阜宁"</span> <span class="attr">d3</span>=<span class="string">"funing"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190705"</span> <span class="attr">d2</span>=<span class="string">"射阳"</span> <span class="attr">d3</span>=<span class="string">"sheyang"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190706"</span> <span class="attr">d2</span>=<span class="string">"建湖"</span> <span class="attr">d3</span>=<span class="string">"jianhu"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190707"</span> <span class="attr">d2</span>=<span class="string">"东台"</span> <span class="attr">d3</span>=<span class="string">"dongtai"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190708"</span> <span class="attr">d2</span>=<span class="string">"大丰"</span> <span class="attr">d3</span>=<span class="string">"dafeng"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190709"</span> <span class="attr">d2</span>=<span class="string">"盐都"</span> <span class="attr">d3</span>=<span class="string">"yandu"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190801"</span> <span class="attr">d2</span>=<span class="string">"徐州"</span> <span class="attr">d3</span>=<span class="string">"xuzhou"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190802"</span> <span class="attr">d2</span>=<span class="string">"铜山"</span> <span class="attr">d3</span>=<span class="string">"tongshan"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190803"</span> <span class="attr">d2</span>=<span class="string">"丰县"</span> <span class="attr">d3</span>=<span class="string">"fengxian"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190804"</span> <span class="attr">d2</span>=<span class="string">"沛县"</span> <span class="attr">d3</span>=<span class="string">"peixian"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190805"</span> <span class="attr">d2</span>=<span class="string">"邳州"</span> <span class="attr">d3</span>=<span class="string">"pizhou"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190806"</span> <span class="attr">d2</span>=<span class="string">"睢宁"</span> <span class="attr">d3</span>=<span class="string">"suining"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190807"</span> <span class="attr">d2</span>=<span class="string">"新沂"</span> <span class="attr">d3</span>=<span class="string">"xinyi"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190901"</span> <span class="attr">d2</span>=<span class="string">"淮安"</span> <span class="attr">d3</span>=<span class="string">"huaian"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190902"</span> <span class="attr">d2</span>=<span class="string">"金湖"</span> <span class="attr">d3</span>=<span class="string">"jinhu"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190903"</span> <span class="attr">d2</span>=<span class="string">"盱眙"</span> <span class="attr">d3</span>=<span class="string">"xuyi"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190904"</span> <span class="attr">d2</span>=<span class="string">"洪泽"</span> <span class="attr">d3</span>=<span class="string">"hongze"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190905"</span> <span class="attr">d2</span>=<span class="string">"涟水"</span> <span class="attr">d3</span>=<span class="string">"lianshui"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190906"</span> <span class="attr">d2</span>=<span class="string">"淮阴区"</span> <span class="attr">d3</span>=<span class="string">"huaiyinqu"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101190908"</span> <span class="attr">d2</span>=<span class="string">"淮安区"</span> <span class="attr">d3</span>=<span class="string">"huaianqu"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101191001"</span> <span class="attr">d2</span>=<span class="string">"连云港"</span> <span class="attr">d3</span>=<span class="string">"lianyungang"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101191002"</span> <span class="attr">d2</span>=<span class="string">"东海"</span> <span class="attr">d3</span>=<span class="string">"donghai"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101191003"</span> <span class="attr">d2</span>=<span class="string">"赣榆"</span> <span class="attr">d3</span>=<span class="string">"ganyu"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101191004"</span> <span class="attr">d2</span>=<span class="string">"灌云"</span> <span class="attr">d3</span>=<span class="string">"guanyun"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101191005"</span> <span class="attr">d2</span>=<span class="string">"灌南"</span> <span class="attr">d3</span>=<span class="string">"guannan"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101191101"</span> <span class="attr">d2</span>=<span class="string">"常州"</span> <span class="attr">d3</span>=<span class="string">"changzhou"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101191102"</span> <span class="attr">d2</span>=<span class="string">"溧阳"</span> <span class="attr">d3</span>=<span class="string">"liyang"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101191103"</span> <span class="attr">d2</span>=<span class="string">"金坛"</span> <span class="attr">d3</span>=<span class="string">"jintan"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101191104"</span> <span class="attr">d2</span>=<span class="string">"武进"</span> <span class="attr">d3</span>=<span class="string">"wujin"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101191201"</span> <span class="attr">d2</span>=<span class="string">"泰州"</span> <span class="attr">d3</span>=<span class="string">"taizhou"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101191202"</span> <span class="attr">d2</span>=<span class="string">"兴化"</span> <span class="attr">d3</span>=<span class="string">"xinghua"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101191203"</span> <span class="attr">d2</span>=<span class="string">"泰兴"</span> <span class="attr">d3</span>=<span class="string">"taixing"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101191204"</span> <span class="attr">d2</span>=<span class="string">"姜堰"</span> <span class="attr">d3</span>=<span class="string">"jiangyan"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101191205"</span> <span class="attr">d2</span>=<span class="string">"靖江"</span> <span class="attr">d3</span>=<span class="string">"jingjiang"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101191301"</span> <span class="attr">d2</span>=<span class="string">"宿迁"</span> <span class="attr">d3</span>=<span class="string">"suqian"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101191302"</span> <span class="attr">d2</span>=<span class="string">"沭阳"</span> <span class="attr">d3</span>=<span class="string">"shuyang"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101191303"</span> <span class="attr">d2</span>=<span class="string">"泗阳"</span> <span class="attr">d3</span>=<span class="string">"siyang"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101191304"</span> <span class="attr">d2</span>=<span class="string">"泗洪"</span> <span class="attr">d3</span>=<span class="string">"sihong"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">d</span> <span class="attr">d1</span>=<span class="string">"101191305"</span> <span class="attr">d2</span>=<span class="string">"宿豫"</span> <span class="attr">d3</span>=<span class="string">"suyu"</span> <span class="attr">d4</span>=<span class="string">"江苏"</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">c</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xml</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>其实思路很简单，就是从xml文件中获取所有的城市信息，转换为城市列表对象。然后遍历城市中的id，就可以根据id拼接url去直接去调用天气的接口去查询天气，然后重新覆盖redis中的天气数据即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WeatherDataSyncJob</span> <span class="keyword">extends</span> <span class="title">QuartzJobBean</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IWeatherDataService weatherDataService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ICityDataService cityDataService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">executeInternal</span><span class="params">(JobExecutionContext context)</span> <span class="keyword">throws</span> JobExecutionException </span>&#123;</span><br><span class="line">        log.info(<span class="string">"天气数据同步任务开始"</span>);</span><br><span class="line">        <span class="comment">//获取城市列表</span></span><br><span class="line">        List&lt;City&gt; cityList = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            cityList = cityDataService.listCity();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">"获取城市列表失败！"</span>,e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//遍历城市id获取天气</span></span><br><span class="line">        <span class="keyword">for</span>(City city:cityList)&#123;</span><br><span class="line">            String cityId = city.getCityId();</span><br><span class="line">            log.info(<span class="string">"定时器更新了&#123;&#125;这个城市的天气信息"</span>, city.getCityName());</span><br><span class="line">            weatherDataService.syncDataByCityId(cityId);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">"天气数据同步任务结束"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体如何读取xml文件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CityDataServiceImpl</span> <span class="keyword">implements</span> <span class="title">ICityDataService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;City&gt; <span class="title">listCity</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//读取xml文件</span></span><br><span class="line">        Resource resource = <span class="keyword">new</span> ClassPathResource(<span class="string">"citylist.xml"</span>);</span><br><span class="line">        <span class="comment">//读取文件的buffer流</span></span><br><span class="line">        BufferedReader bf = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(resource.getInputStream(),<span class="string">"UTF-8"</span>));</span><br><span class="line">        StringBuffer buffer = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        String line = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>((line = bf.readLine()) != <span class="keyword">null</span>)&#123;</span><br><span class="line">            buffer.append(line);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//此时数据已经读到buffer里了</span></span><br><span class="line">        bf.close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//xml转换为java对象</span></span><br><span class="line">        CityList cityList = (CityList) XmlBuilder.xmlStrToObj(CityList.class,buffer.toString());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> cityList.getCityList();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> 【swg】.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2018/11/19 17:09</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@DESC</span> xml转换为对象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@CONTACT</span> 317758022@qq.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XmlBuilder</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">xmlStrToObj</span><span class="params">(Class&lt;?&gt; clazz,String xmlStr)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        Object xmlObject = <span class="keyword">null</span>;</span><br><span class="line">        Reader reader = <span class="keyword">null</span>;</span><br><span class="line">        JAXBContext context = JAXBContext.newInstance(clazz);</span><br><span class="line">        <span class="comment">//xml转为对象的接口</span></span><br><span class="line">        Unmarshaller unmarshaller = context.createUnmarshaller();</span><br><span class="line"></span><br><span class="line">        reader = <span class="keyword">new</span> StringReader(xmlStr);</span><br><span class="line">        xmlObject = unmarshaller.unmarshal(reader);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">null</span> != reader)&#123;</span><br><span class="line">            reader.close();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> xmlObject;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中，解析xml我们用到了<code>JAXB</code>，他是什么呢？维基百科：</p>
<blockquote>
<p>JAXB（Java Architecture for XML Binding简称JAXB）允许Java开发人员将Java类映射为XML表示方式。JAXB提供两种主要特性：将一个Java对象序列化为XML，以及反向操作，将XML解析成Java对象。换句话说，JAXB允许以XML格式存储和读取数据，而不需要程序的类结构实现特定的读取XML和保存XML的代码。</p>
</blockquote>
</div></article></div></section><footer><div class="paginator"><a href="/2019/02/21/weather-for-spring-cloud/4.天气预报系统-前端样式/" class="prev">上一篇</a><a href="/2019/02/21/weather-for-spring-cloud/2.天气预报系统-redis提升性能/" class="next">下一篇</a></div><div id="container"></div><link rel="stylesheet" href="https://jjeejj.github.io/css/gitment.css">
<script src="https://jjeejj.github.io/js/gitment.js"></script><script>var gitment = new Gitment({
    id: 'Thu Feb 21 2019 11:26:45 GMT+0800',
    owner: 'sunweiguo',
    repo: 'sunweiguo.github.io',
    oauth: {
        client_id: '56c422eddebac740f021',
        client_secret: 'fd1b1eff6dd6efc61b2a09650840be7aaab787fd',
    },
})
gitment.render('container')</script><div class="copyright"><p>© 2019 <a href="http://yoursite.com">fossi</a>,苏ICP备17064972号.</p></div></footer><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-134836068-1",'auto');ga('send','pageview');</script><script src="https://cdn.bootcss.com/mathjax/2.5.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>