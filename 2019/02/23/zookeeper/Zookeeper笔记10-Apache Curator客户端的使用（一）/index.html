<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Zookeeper笔记10-Apache Curator客户端的使用（一） · fossi</title><meta name="description" content="Zookeeper笔记10-Apache Curator客户端的使用（一） - fossi"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"></head><body><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">首页</a></li><li class="nav-list-item"><a href="https://sunweiguo.github.io/tags/" target="_blank" class="nav-list-link">标签</a></li><li class="nav-list-item"><a href="http://bloghello.oursnail.cn/test.html" target="_blank" class="nav-list-link">爱情</a></li><li class="nav-list-item"><a href="https://github.com/sunweiguo" target="_blank" class="nav-list-link">GIT</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Zookeeper笔记10-Apache Curator客户端的使用（一）</h1><div class="post-meta"><span class="post-time">Feb 23, 2019</span></div><div class="post-content"><p>本文来看看Apache Curator客户端的使用吧！</p>
<a id="more"></a>
<h2>一、前言</h2>
<p>对于上一章中应用的java 原生API来操作节点。来看看他的不足：</p>
<ul>
<li>超时重连，不支持自动，需要手动操作</li>
<li>watcher注册一次后会失效</li>
<li>不支持递归创建节点</li>
</ul>
<p>对于Apache Curator开源客户端，具有以下的优点：</p>
<ul>
<li>Apache的开源项目，值得信赖</li>
<li>解决watcher的注册一次就失效的问题</li>
<li>API更加简单易用</li>
<li>提供更多解决方案并且实现简单，比如分布式锁</li>
<li>提供常用的zookeeper工具类</li>
<li>编程风格更爽</li>
</ul>
<p>本篇文章为上半部分，主要学习了一下自动重连、创建节点、查询节点数据和子节点、删除和修改节点数据。还有就是用nodeCache以及PathChildrenCache缓存节点数据来解决注册一次就失效的问题。</p>
<h2>二、使用</h2>
<p>首先新建一个maven工程，我这里直接新建了一个SpringBoot工程，依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--curator--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>curator-framework<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>curator-recipes<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.zookeeper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zookeeper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2>三、连接&amp;自动重连</h2>
<p>配置完依赖后，我们就可以来写一个简单的demo测试与zookeeper服务端的连接。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CuratorConnect</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> CuratorFramework client = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String zkServerPath = <span class="string">"127.0.0.1:2181,127.0.0.1:2182,127.0.0.1:2183"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CuratorConnect</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * （推荐）</span></span><br><span class="line"><span class="comment">         * 同步创建zk示例，原生api是异步的</span></span><br><span class="line"><span class="comment">         * 这一步是设置重连策略</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * 构造器参数：</span></span><br><span class="line"><span class="comment">         *  curator链接zookeeper的策略:ExponentialBackoffRetry</span></span><br><span class="line"><span class="comment">         *  baseSleepTimeMs：初始sleep的时间</span></span><br><span class="line"><span class="comment">         *  maxRetries：最大重试次数</span></span><br><span class="line"><span class="comment">         *  maxSleepMs：最大重试时间</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        RetryPolicy retryPolicy = <span class="keyword">new</span> ExponentialBackoffRetry(<span class="number">1000</span>,<span class="number">5</span>);</span><br><span class="line">        client = CuratorFrameworkFactory.builder()</span><br><span class="line">                .connectString(zkServerPath)</span><br><span class="line">                .sessionTimeoutMs(<span class="number">10</span>*<span class="number">1000</span>)</span><br><span class="line">                .retryPolicy(retryPolicy)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        client.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">closeZKClient</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(client != <span class="keyword">null</span>)&#123;</span><br><span class="line">            client.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        CuratorConnect curatorConnect = <span class="keyword">new</span> CuratorConnect();</span><br><span class="line">        <span class="keyword">boolean</span> isZkClientStart = curatorConnect.client.isStarted();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"客户端是否打开:"</span>+isZkClientStart);</span><br><span class="line"></span><br><span class="line">        curatorConnect.closeZKClient();</span><br><span class="line"></span><br><span class="line">        isZkClientStart = curatorConnect.client.isStarted();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"客户端是否打开:"</span>+isZkClientStart);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>curator连接zookeeper服务器时有自动重连机制，而curator的重连策略有五种。</p>
<ul>
<li>第一种就是上面提到的：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * （推荐）</span></span><br><span class="line"><span class="comment"> * 同步创建zk示例，原生api是异步的</span></span><br><span class="line"><span class="comment"> * 这一步是设置重连策略</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 构造器参数：</span></span><br><span class="line"><span class="comment"> *  curator链接zookeeper的策略:ExponentialBackoffRetry</span></span><br><span class="line"><span class="comment"> *  baseSleepTimeMs：初始sleep的时间</span></span><br><span class="line"><span class="comment"> *  maxRetries：最大重试次数</span></span><br><span class="line"><span class="comment"> *  maxSleepMs：最大重试时间</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">RetryPolicy retryPolicy = <span class="keyword">new</span> ExponentialBackoffRetry(<span class="number">1000</span>, <span class="number">5</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>第二种，可设定重连n次：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * （推荐）</span></span><br><span class="line"><span class="comment"> * curator链接zookeeper的策略:RetryNTimes</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 构造器参数：</span></span><br><span class="line"><span class="comment"> * n：重试的次数</span></span><br><span class="line"><span class="comment"> * sleepMsBetweenRetries：每次重试间隔的时间</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">RetryPolicy retryPolicy = <span class="keyword">new</span> RetryNTimes(<span class="number">3</span>, <span class="number">5000</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>第三种，只会重连一次：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * （不推荐）</span></span><br><span class="line"><span class="comment"> * curator链接zookeeper的策略:RetryOneTime</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 构造器参数：</span></span><br><span class="line"><span class="comment"> * sleepMsBetweenRetry:每次重试间隔的时间</span></span><br><span class="line"><span class="comment"> * 这个策略只会重试一次</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">RetryPolicy retryPolicy2 = <span class="keyword">new</span> RetryOneTime(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>第四种，永远重连：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 永远重试，不推荐使用</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">RetryPolicy retryPolicy3 = <span class="keyword">new</span> RetryForever(retryIntervalMs)</span><br></pre></td></tr></table></figure>
<ul>
<li>第五种，可设定最大重试时间：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * curator链接zookeeper的策略:RetryUntilElapsed</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 构造器参数：</span></span><br><span class="line"><span class="comment"> * maxElapsedTimeMs:最大重试时间</span></span><br><span class="line"><span class="comment"> * sleepMsBetweenRetries:每次重试间隔</span></span><br><span class="line"><span class="comment"> * 重试时间超过maxElapsedTimeMs后，就不再重试</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">RetryPolicy retryPolicy4 = <span class="keyword">new</span> RetryUntilElapsed(<span class="number">2000</span>, <span class="number">3000</span>);</span><br></pre></td></tr></table></figure>
<h2>四、zk命名空间以及创建节点</h2>
<p>zookeeper的命名空间就类似于我们平时使用Eclipse等开发工具的工作空间一样，我们该连接中所有的操作都是基于这个命名空间的。curator提供了设置命名空间的方法，这样我们任何的连接都可以去设置一个命名空间。设置了命名空间并成功连接后，zookeeper的根节点会多出一个以命名空间名称所命名的节点。然后我们在该连接的增删查改等操作都会在这个节点中进行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CuratorCreateNode</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Curator客户端</span></span><br><span class="line">    <span class="keyword">public</span> CuratorFramework client = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// 集群模式则是多个ip</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String zkServerIps = <span class="string">"127.0.0.1:2181,127.0.0.1:2182,127.0.0.1:2183"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CuratorCreateNode</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        RetryPolicy retryPolicy = <span class="keyword">new</span> ExponentialBackoffRetry(<span class="number">1000</span>, <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 实例化Curator客户端</span></span><br><span class="line">        client = CuratorFrameworkFactory.builder() <span class="comment">// 使用工厂类来建造客户端的实例对象</span></span><br><span class="line">                .connectString(zkServerIps)  <span class="comment">// 放入zookeeper服务器ip</span></span><br><span class="line">                .sessionTimeoutMs(<span class="number">10000</span>).retryPolicy(retryPolicy)  <span class="comment">// 设定会话时间以及重连策略</span></span><br><span class="line">                .namespace(<span class="string">"workspace"</span>).build();  <span class="comment">// 设置命名空间以及开始建立连接</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 启动Curator客户端</span></span><br><span class="line">        client.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关闭zk客户端连接</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">closeZKClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (client != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.client.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 实例化</span></span><br><span class="line">        CuratorCreateNode curatorConnect = <span class="keyword">new</span> CuratorCreateNode();</span><br><span class="line">        <span class="comment">// 获取当前客户端的状态</span></span><br><span class="line">        <span class="keyword">boolean</span> isZkCuratorStarted = curatorConnect.client.isStarted();</span><br><span class="line">        System.out.println(<span class="string">"当前客户端的状态："</span> + (isZkCuratorStarted ? <span class="string">"连接中..."</span> : <span class="string">"已关闭..."</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建节点</span></span><br><span class="line">        String nodePath = <span class="string">"/super/testNode"</span>;  <span class="comment">// 节点路径</span></span><br><span class="line">        <span class="keyword">byte</span>[] data = <span class="string">"this is a test data"</span>.getBytes();  <span class="comment">// 节点数据</span></span><br><span class="line">        String result = curatorConnect.client.create().creatingParentsIfNeeded()  <span class="comment">// 创建父节点，也就是会递归创建</span></span><br><span class="line">                .withMode(CreateMode.PERSISTENT)  <span class="comment">// 节点类型</span></span><br><span class="line">                .withACL(ZooDefs.Ids.OPEN_ACL_UNSAFE)  <span class="comment">// 节点的acl权限</span></span><br><span class="line">                .forPath(nodePath, data);</span><br><span class="line"></span><br><span class="line">        System.out.println(result + <span class="string">"节点，创建成功..."</span>);</span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 关闭客户端</span></span><br><span class="line">        curatorConnect.closeZKClient();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取当前客户端的状态</span></span><br><span class="line">        isZkCuratorStarted = curatorConnect.client.isStarted();</span><br><span class="line">        System.out.println(<span class="string">"当前客户端的状态："</span> + (isZkCuratorStarted ? <span class="string">"连接中..."</span> : <span class="string">"已关闭..."</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行该类，控制台输出信息如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">当前客户端的状态：连接中...</span><br><span class="line">/super/testNode节点，创建成功...</span><br><span class="line">当前客户端的状态：已关闭...</span><br></pre></td></tr></table></figure>
<h2>五、修改节点以及删除节点</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CuratorConnect</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Curator客户端</span></span><br><span class="line">    <span class="keyword">public</span> CuratorFramework client = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// 集群模式则是多个ip</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String zkServerIps = <span class="string">"192.168.190.128:2181,192.168.190.129:2181,192.168.190.130:2181"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CuratorConnect</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        RetryPolicy retryPolicy = <span class="keyword">new</span> ExponentialBackoffRetry(<span class="number">1000</span>, <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 实例化Curator客户端</span></span><br><span class="line">        client = CuratorFrameworkFactory.builder() <span class="comment">// 使用工厂类来建造客户端的实例对象</span></span><br><span class="line">                .connectString(zkServerIps)  <span class="comment">// 放入zookeeper服务器ip</span></span><br><span class="line">                .sessionTimeoutMs(<span class="number">10000</span>).retryPolicy(retryPolicy)  <span class="comment">// 设定会话时间以及重连策略</span></span><br><span class="line">                .namespace(<span class="string">"workspace"</span>).build();  <span class="comment">// 设置命名空间以及开始建立连接</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 启动Curator客户端</span></span><br><span class="line">        client.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关闭zk客户端连接</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">closeZKClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (client != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.client.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 实例化</span></span><br><span class="line">        CuratorConnect curatorConnect = <span class="keyword">new</span> CuratorConnect();</span><br><span class="line">        <span class="comment">// 获取当前客户端的状态</span></span><br><span class="line">        <span class="keyword">boolean</span> isZkCuratorStarted = curatorConnect.client.isStarted();</span><br><span class="line">        System.out.println(<span class="string">"当前客户端的状态："</span> + (isZkCuratorStarted ? <span class="string">"连接中..."</span> : <span class="string">"已关闭..."</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 节点路径</span></span><br><span class="line">        String nodePath = <span class="string">"/super/testNode"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 更新节点数据</span></span><br><span class="line">        <span class="keyword">byte</span>[] newData = <span class="string">"this is a new data"</span>.getBytes();</span><br><span class="line">        Stat resultStat = curatorConnect.client.setData().withVersion(<span class="number">0</span>)  <span class="comment">// 指定数据版本</span></span><br><span class="line">                .forPath(nodePath, newData);  <span class="comment">// 需要修改的节点路径以及新数据</span></span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"更新节点数据成功，新的数据版本为："</span> + resultStat.getVersion());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 删除节点</span></span><br><span class="line">        curatorConnect.client.delete()</span><br><span class="line">                .guaranteed()  <span class="comment">// 如果删除失败，那么在后端还是会继续删除，直到成功</span></span><br><span class="line">                .deletingChildrenIfNeeded()  <span class="comment">// 子节点也一并删除，也就是会递归删除</span></span><br><span class="line">                .withVersion(resultStat.getVersion())</span><br><span class="line">                .forPath(nodePath);</span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 关闭客户端</span></span><br><span class="line">        curatorConnect.closeZKClient();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取当前客户端的状态</span></span><br><span class="line">        isZkCuratorStarted = curatorConnect.client.isStarted();</span><br><span class="line">        System.out.println(<span class="string">"当前客户端的状态："</span> + (isZkCuratorStarted ? <span class="string">"连接中..."</span> : <span class="string">"已关闭..."</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2>六、查询节点相关信息</h2>
<p>1.获取某个节点的数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CuratorConnect</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 实例化</span></span><br><span class="line">        CuratorConnect curatorConnect = <span class="keyword">new</span> CuratorConnect();</span><br><span class="line">        <span class="comment">// 获取当前客户端的状态</span></span><br><span class="line">        <span class="keyword">boolean</span> isZkCuratorStarted = curatorConnect.client.isStarted();</span><br><span class="line">        System.out.println(<span class="string">"当前客户端的状态："</span> + (isZkCuratorStarted ? <span class="string">"连接中..."</span> : <span class="string">"已关闭..."</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 节点路径</span></span><br><span class="line">        String nodePath = <span class="string">"/super/testNode"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 读取节点数据</span></span><br><span class="line">        Stat stat = <span class="keyword">new</span> Stat();</span><br><span class="line">        <span class="keyword">byte</span>[] nodeData = curatorConnect.client.getData().storingStatIn(stat).forPath(nodePath);</span><br><span class="line">        System.out.println(<span class="string">"节点 "</span> + nodePath + <span class="string">" 的数据为："</span> + <span class="keyword">new</span> String(nodeData));</span><br><span class="line">        System.out.println(<span class="string">"该节点的数据版本号为："</span> + stat.getVersion());</span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 关闭客户端</span></span><br><span class="line">        curatorConnect.closeZKClient();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取当前客户端的状态</span></span><br><span class="line">        isZkCuratorStarted = curatorConnect.client.isStarted();</span><br><span class="line">        System.out.println(<span class="string">"当前客户端的状态："</span> + (isZkCuratorStarted ? <span class="string">"连接中..."</span> : <span class="string">"已关闭..."</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2.获取某个节点下的子节点列表，现有一个节点的子节点列表如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost:2181(CONNECTED) 33] ls /workspace/super/testNode</span><br><span class="line">[threeNode, twoNode, oneNode]</span><br><span class="line">[zk: localhost:2181(CONNECTED) 34]</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CuratorConnect</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 实例化</span></span><br><span class="line">        CuratorConnect curatorConnect = <span class="keyword">new</span> CuratorConnect();</span><br><span class="line">        <span class="comment">// 获取当前客户端的状态</span></span><br><span class="line">        <span class="keyword">boolean</span> isZkCuratorStarted = curatorConnect.client.isStarted();</span><br><span class="line">        System.out.println(<span class="string">"当前客户端的状态："</span> + (isZkCuratorStarted ? <span class="string">"连接中..."</span> : <span class="string">"已关闭..."</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 节点路径</span></span><br><span class="line">        String nodePath = <span class="string">"/super/testNode"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取子节点列表</span></span><br><span class="line">        List&lt;String&gt; childNodes = curatorConnect.client.getChildren().forPath(nodePath);</span><br><span class="line">        System.out.println(nodePath + <span class="string">" 节点下的子节点列表："</span>);</span><br><span class="line">        <span class="keyword">for</span> (String childNode : childNodes) &#123;</span><br><span class="line">            System.out.println(childNode);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 关闭客户端</span></span><br><span class="line">        curatorConnect.closeZKClient();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取当前客户端的状态</span></span><br><span class="line">        isZkCuratorStarted = curatorConnect.client.isStarted();</span><br><span class="line">        System.out.println(<span class="string">"当前客户端的状态："</span> + (isZkCuratorStarted ? <span class="string">"连接中..."</span> : <span class="string">"已关闭..."</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3.查询某个节点是否存在</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CuratorConnect</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 实例化</span></span><br><span class="line">        CuratorConnect curatorConnect = <span class="keyword">new</span> CuratorConnect();</span><br><span class="line">        <span class="comment">// 获取当前客户端的状态</span></span><br><span class="line">        <span class="keyword">boolean</span> isZkCuratorStarted = curatorConnect.client.isStarted();</span><br><span class="line">        System.out.println(<span class="string">"当前客户端的状态："</span> + (isZkCuratorStarted ? <span class="string">"连接中..."</span> : <span class="string">"已关闭..."</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 节点路径</span></span><br><span class="line">        String nodePath = <span class="string">"/super/testNode"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 查询某个节点是否存在，存在就会返回该节点的状态信息，如果不存在的话则返回空</span></span><br><span class="line">        Stat statExist = curatorConnect.client.checkExists().forPath(nodePath);</span><br><span class="line">        <span class="keyword">if</span> (statExist == <span class="keyword">null</span>) &#123;</span><br><span class="line">            System.out.println(nodePath + <span class="string">" 节点不存在"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(nodePath + <span class="string">" 节点存在"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 关闭客户端</span></span><br><span class="line">        curatorConnect.closeZKClient();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取当前客户端的状态</span></span><br><span class="line">        isZkCuratorStarted = curatorConnect.client.isStarted();</span><br><span class="line">        System.out.println(<span class="string">"当前客户端的状态："</span> + (isZkCuratorStarted ? <span class="string">"连接中..."</span> : <span class="string">"已关闭..."</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2>七、curator之usingWatcher</h2>
<p>curator在注册watch事件上，提供了一个usingWatcher方法，使用这个方法注册的watch事件和默认watch事件一样，监听只会触发一次，监听完毕后就会销毁，也就是一次性的。而这个方法有两种参数可选，一个是zk原生API的Watcher接口的实现类，另一个是Curator提供的CuratorWatcher接口的实现类，不过在usingWatcher方法上使用哪一个效果都是一样的，都是一次性的。</p>
<p>新建一个 MyWatcher 实现类，实现 Watcher 接口。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@program</span>: zookeeper-connection</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:  zk原生API的Watcher接口实现</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: 01</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span>: 2018-04-28 13:41</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyWatcher</span> <span class="keyword">implements</span> <span class="title">Watcher</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Watcher事件通知方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(WatchedEvent watchedEvent)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"触发watcher，节点路径为："</span> + watchedEvent.getPath());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>新建一个 MyCuratorWatcher 实现类，实现 CuratorWatcher 接口。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@program</span>: zookeeper-connection</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: Curator提供的CuratorWatcher接口实现</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: 01</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span>: 2018-04-28 13:40</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyCuratorWatcher</span> <span class="keyword">implements</span> <span class="title">CuratorWatcher</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Watcher事件通知方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(WatchedEvent watchedEvent)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"触发watcher，节点路径为："</span> + watchedEvent.getPath());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CuratorConnect</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 实例化</span></span><br><span class="line">        CuratorConnect curatorConnect = <span class="keyword">new</span> CuratorConnect();</span><br><span class="line">        <span class="comment">// 获取当前客户端的状态</span></span><br><span class="line">        <span class="keyword">boolean</span> isZkCuratorStarted = curatorConnect.client.isStarted();</span><br><span class="line">        System.out.println(<span class="string">"当前客户端的状态："</span> + (isZkCuratorStarted ? <span class="string">"连接中..."</span> : <span class="string">"已关闭..."</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 节点路径</span></span><br><span class="line">        String nodePath = <span class="string">"/super/testNode"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 添加 watcher 事件，当使用usingWatcher的时候，监听只会触发一次，监听完毕后就销毁</span></span><br><span class="line">        curatorConnect.client.getData().usingWatcher(<span class="keyword">new</span> MyCuratorWatcher()).forPath(nodePath);</span><br><span class="line">        <span class="comment">// curatorConnect.client.getData().usingWatcher(new MyWatcher()).forPath(nodePath);</span></span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">100000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 关闭客户端</span></span><br><span class="line">        curatorConnect.closeZKClient();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取当前客户端的状态</span></span><br><span class="line">        isZkCuratorStarted = curatorConnect.client.isStarted();</span><br><span class="line">        System.out.println(<span class="string">"当前客户端的状态："</span> + (isZkCuratorStarted ? <span class="string">"连接中..."</span> : <span class="string">"已关闭..."</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行该类，然后到zookeeper服务器上修改/super/testNode节点的数据：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost:<span class="number">2181</span>(CONNECTED) <span class="number">35</span>] set /workspace/<span class="keyword">super</span>/testNode <span class="keyword">new</span>-data</span><br><span class="line">cZxid = <span class="number">0xb00000015</span></span><br><span class="line">ctime = Sat Apr <span class="number">28</span> <span class="number">20</span>:<span class="number">59</span>:<span class="number">57</span> CST <span class="number">2018</span></span><br><span class="line">mZxid = <span class="number">0xb0000002b</span></span><br><span class="line">mtime = Sat Apr <span class="number">28</span> <span class="number">21</span>:<span class="number">40</span>:<span class="number">58</span> CST <span class="number">2018</span></span><br><span class="line">pZxid = <span class="number">0xb0000001c</span></span><br><span class="line">cversion = <span class="number">3</span></span><br><span class="line">dataVersion = <span class="number">2</span></span><br><span class="line">aclVersion = <span class="number">0</span></span><br><span class="line">ephemeralOwner = <span class="number">0x0</span></span><br><span class="line">dataLength = <span class="number">8</span></span><br><span class="line">numChildren = <span class="number">3</span></span><br><span class="line">[zk: localhost:<span class="number">2181</span>(CONNECTED) <span class="number">36</span>]</span><br></pre></td></tr></table></figure>
<p>修改完成后，此时控制台输出内容如下，因为workspace是命名空间节点，所以不会被打印出来：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">触发watcher，节点路径为：/super/testNode</span><br></pre></td></tr></table></figure>
<h2>八、curator之nodeCache一次注册N次监听</h2>
<p>想要实现watch一次注册n次监听的话，我们需要使用到curator里的一个NodeCache对象。这个对象可以用来缓存节点数据，并且可以给节点添加nodeChange事件，当节点的数据发生变化就会触发这个事件。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CuratorConnect</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 实例化</span></span><br><span class="line">        CuratorConnect curatorConnect = <span class="keyword">new</span> CuratorConnect();</span><br><span class="line">        <span class="comment">// 获取当前客户端的状态</span></span><br><span class="line">        <span class="keyword">boolean</span> isZkCuratorStarted = curatorConnect.client.isStarted();</span><br><span class="line">        System.out.println(<span class="string">"当前客户端的状态："</span> + (isZkCuratorStarted ? <span class="string">"连接中..."</span> : <span class="string">"已关闭..."</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 节点路径</span></span><br><span class="line">        String nodePath = <span class="string">"/super/testNode"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// NodeCache: 缓存节点，并且可以监听数据节点的变更，会触发事件</span></span><br><span class="line">        <span class="keyword">final</span> NodeCache nodeCache = <span class="keyword">new</span> NodeCache(curatorConnect.client, nodePath);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 参数 buildInitial : 初始化的时候获取node的值并且缓存</span></span><br><span class="line">        nodeCache.start(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取缓存里的节点初始化数据</span></span><br><span class="line">        <span class="keyword">if</span> (nodeCache.getCurrentData() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">"节点初始化数据为："</span> + <span class="keyword">new</span> String(nodeCache.getCurrentData().getData()));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">"节点初始化数据为空..."</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 为缓存的节点添加watcher，或者说添加监听器</span></span><br><span class="line">        nodeCache.getListenable().addListener(<span class="keyword">new</span> NodeCacheListener() &#123;</span><br><span class="line">            <span class="comment">// 节点数据change事件的通知方法</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">nodeChanged</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="comment">// 防止节点被删除时发生错误</span></span><br><span class="line">                <span class="keyword">if</span> (nodeCache.getCurrentData() == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    System.out.println(<span class="string">"获取节点数据异常，无法获取当前缓存的节点数据，可能该节点已被删除"</span>);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 获取节点最新的数据</span></span><br><span class="line">                String data = <span class="keyword">new</span> String(nodeCache.getCurrentData().getData());</span><br><span class="line">                System.out.println(nodeCache.getCurrentData().getPath() + <span class="string">" 节点的数据发生变化，最新的数据为："</span> + data);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">200000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 关闭客户端</span></span><br><span class="line">        curatorConnect.closeZKClient();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取当前客户端的状态</span></span><br><span class="line">        isZkCuratorStarted = curatorConnect.client.isStarted();</span><br><span class="line">        System.out.println(<span class="string">"当前客户端的状态："</span> + (isZkCuratorStarted ? <span class="string">"连接中..."</span> : <span class="string">"已关闭..."</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行该类后，我们到zookeeper服务器上，对/super/testNode节点进行如下操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost:<span class="number">2181</span>(CONNECTED) <span class="number">2</span>] set /workspace/<span class="keyword">super</span>/testNode change-data     </span><br><span class="line">cZxid = <span class="number">0xb00000015</span></span><br><span class="line">ctime = Sat Apr <span class="number">28</span> <span class="number">20</span>:<span class="number">59</span>:<span class="number">57</span> CST <span class="number">2018</span></span><br><span class="line">mZxid = <span class="number">0xb00000037</span></span><br><span class="line">mtime = Sat Apr <span class="number">28</span> <span class="number">23</span>:<span class="number">49</span>:<span class="number">42</span> CST <span class="number">2018</span></span><br><span class="line">pZxid = <span class="number">0xb0000001c</span></span><br><span class="line">cversion = <span class="number">3</span></span><br><span class="line">dataVersion = <span class="number">6</span></span><br><span class="line">aclVersion = <span class="number">0</span></span><br><span class="line">ephemeralOwner = <span class="number">0x0</span></span><br><span class="line">dataLength = <span class="number">11</span></span><br><span class="line">numChildren = <span class="number">3</span>      </span><br><span class="line">[zk: localhost:<span class="number">2181</span>(CONNECTED) <span class="number">3</span>] set /workspace/<span class="keyword">super</span>/testNode change-agin-data</span><br><span class="line">cZxid = <span class="number">0xb00000015</span></span><br><span class="line">ctime = Sat Apr <span class="number">28</span> <span class="number">20</span>:<span class="number">59</span>:<span class="number">57</span> CST <span class="number">2018</span></span><br><span class="line">mZxid = <span class="number">0xb00000038</span></span><br><span class="line">mtime = Sat Apr <span class="number">28</span> <span class="number">23</span>:<span class="number">50</span>:<span class="number">01</span> CST <span class="number">2018</span></span><br><span class="line">pZxid = <span class="number">0xb0000001c</span></span><br><span class="line">cversion = <span class="number">3</span></span><br><span class="line">dataVersion = <span class="number">7</span></span><br><span class="line">aclVersion = <span class="number">0</span></span><br><span class="line">ephemeralOwner = <span class="number">0x0</span></span><br><span class="line">dataLength = <span class="number">16</span></span><br><span class="line">numChildren = <span class="number">3</span></span><br><span class="line">[zk: localhost:<span class="number">2181</span>(CONNECTED) <span class="number">8</span>] delete /workspace/<span class="keyword">super</span>/testNode</span><br><span class="line">[zk: localhost:<span class="number">2181</span>(CONNECTED) <span class="number">9</span>] create /workspace/<span class="keyword">super</span>/testNode test-data</span><br><span class="line">Created /workspace/<span class="keyword">super</span>/testNode</span><br><span class="line">[zk: localhost:<span class="number">2181</span>(CONNECTED) <span class="number">10</span>]</span><br></pre></td></tr></table></figure>
<p>此时控制台输出内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">当前客户端的状态：连接中...</span><br><span class="line">节点初始化数据为：new-data</span><br><span class="line">/super/testNode 节点的数据发生变化，最新的数据为：change-data</span><br><span class="line">/super/testNode 节点的数据发生变化，最新的数据为：change-agin-data</span><br><span class="line">获取节点数据异常，无法获取当前缓存的节点数据，可能该节点已被删除</span><br><span class="line">/super/testNode 节点的数据发生变化，最新的数据为：test-data</span><br><span class="line">当前客户端的状态：已关闭...</span><br></pre></td></tr></table></figure>
<p>从控制台输出的内容可以看到，只要数据发生改变了都会触发这个事件，并且是可以重复触发的，而不是一次性的。</p>
<h2>九、curator之PathChildrenCache子节点监听</h2>
<p>使用NodeCache虽然能实现一次注册n次监听，但是却只能监听一个nodeChanged事件，也就是说创建、删除以及子节点的事件都无法监听。如果我们要监听某一个节点的子节点的事件，或者监听某一个特定节点的增删改事件都需要借助PathChildrenCache来实现。从名称上可以看到，PathChildrenCache也是用缓存实现的，并且也是一次注册n次监听。当我们传递一个节点路径时是监听该节点下的子节点事件，如果我们要限制监听某一个节点，只需要加上判断条件即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CuratorConnect</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 实例化</span></span><br><span class="line">        CuratorConnect curatorConnect = <span class="keyword">new</span> CuratorConnect();</span><br><span class="line">        <span class="comment">// 获取当前客户端的状态</span></span><br><span class="line">        <span class="keyword">boolean</span> isZkCuratorStarted = curatorConnect.client.isStarted();</span><br><span class="line">        System.out.println(<span class="string">"当前客户端的状态："</span> + (isZkCuratorStarted ? <span class="string">"连接中..."</span> : <span class="string">"已关闭..."</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 父节点路径</span></span><br><span class="line">        String nodePath = <span class="string">"/super/testNode"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 为子节点添加watcher</span></span><br><span class="line">        <span class="comment">// PathChildrenCache: 监听数据节点的增删改，可以设置触发的事件</span></span><br><span class="line">        <span class="keyword">final</span> PathChildrenCache childrenCache = <span class="keyword">new</span> PathChildrenCache(curatorConnect.client, nodePath, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * StartMode: 初始化方式</span></span><br><span class="line"><span class="comment">         * POST_INITIALIZED_EVENT：异步初始化，初始化之后会触发事件</span></span><br><span class="line"><span class="comment">         * NORMAL：异步初始化</span></span><br><span class="line"><span class="comment">         * BUILD_INITIAL_CACHE：同步初始化</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        childrenCache.start(PathChildrenCache.StartMode.BUILD_INITIAL_CACHE);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 列出子节点数据列表，需要使用BUILD_INITIAL_CACHE同步初始化模式才能获得，异步是获取不到的</span></span><br><span class="line">        List&lt;ChildData&gt; childDataList = childrenCache.getCurrentData();</span><br><span class="line">        System.out.println(<span class="string">"当前节点的子节点详细数据列表："</span>);</span><br><span class="line">        <span class="keyword">for</span> (ChildData childData : childDataList) &#123;</span><br><span class="line">            System.out.println(<span class="string">"\t* 子节点路径："</span> + <span class="keyword">new</span> String(childData.getPath()) + <span class="string">"，该节点的数据为："</span> + <span class="keyword">new</span> String(childData.getData()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 添加事件监听器</span></span><br><span class="line">        childrenCache.getListenable().addListener(<span class="keyword">new</span> PathChildrenCacheListener() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">childEvent</span><span class="params">(CuratorFramework curatorFramework, PathChildrenCacheEvent event)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="comment">// 通过判断event type的方式来实现不同事件的触发</span></span><br><span class="line">                <span class="keyword">if</span> (event.getType().equals(PathChildrenCacheEvent.Type.INITIALIZED)) &#123;  <span class="comment">// 子节点初始化时触发</span></span><br><span class="line">                    System.out.println(<span class="string">"\n--------------\n"</span>);</span><br><span class="line">                    System.out.println(<span class="string">"子节点初始化成功"</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.getType().equals(PathChildrenCacheEvent.Type.CHILD_ADDED)) &#123;  <span class="comment">// 添加子节点时触发</span></span><br><span class="line">                    System.out.println(<span class="string">"\n--------------\n"</span>);</span><br><span class="line">                    System.out.print(<span class="string">"子节点："</span> + event.getData().getPath() + <span class="string">" 添加成功，"</span>);</span><br><span class="line">                    System.out.println(<span class="string">"该子节点的数据为："</span> + <span class="keyword">new</span> String(event.getData().getData()));</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.getType().equals(PathChildrenCacheEvent.Type.CHILD_REMOVED)) &#123;  <span class="comment">// 删除子节点时触发</span></span><br><span class="line">                    System.out.println(<span class="string">"\n--------------\n"</span>);</span><br><span class="line">                    System.out.println(<span class="string">"子节点："</span> + event.getData().getPath() + <span class="string">" 删除成功"</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event.getType().equals(PathChildrenCacheEvent.Type.CHILD_UPDATED)) &#123;  <span class="comment">// 修改子节点数据时触发</span></span><br><span class="line">                    System.out.println(<span class="string">"\n--------------\n"</span>);</span><br><span class="line">                    System.out.print(<span class="string">"子节点："</span> + event.getData().getPath() + <span class="string">" 数据更新成功，"</span>);</span><br><span class="line">                    System.out.println(<span class="string">"子节点："</span> + event.getData().getPath() + <span class="string">" 新的数据为："</span> + <span class="keyword">new</span> String(event.getData().getData()));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">200000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 关闭客户端</span></span><br><span class="line">        curatorConnect.closeZKClient();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取当前客户端的状态</span></span><br><span class="line">        isZkCuratorStarted = curatorConnect.client.isStarted();</span><br><span class="line">        System.out.println(<span class="string">"当前客户端的状态："</span> + (isZkCuratorStarted ? <span class="string">"连接中..."</span> : <span class="string">"已关闭..."</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></article></div></section><footer><div class="paginator"><a href="/2019/02/23/zookeeper/Zookeeper笔记11-Apache Curator客户端的使用（二）/" class="prev">上一篇</a><a href="/2019/02/23/zookeeper/Zookeeper笔记9-原生Java API使用/" class="next">下一篇</a></div><div id="container"></div><link rel="stylesheet" href="https://jjeejj.github.io/css/gitment.css">
<script src="https://www.wenjunjiang.win/js/gitment.js"></script><script>var gitment = new Gitment({
    id: 'Sat Feb 23 2019 16:43:42 GMT+0800',
    owner: 'sunweiguo',
    repo: 'sunweiguo.github.io',
    oauth: {
        client_id: '56c422eddebac740f021',
        client_secret: 'b0520b7f71d5d883e029133f06c3328e3d3168e1',
    },
})
gitment.render('container')</script><div class="copyright"><p>© 2019 - 2020 <a href="http://yoursite.com">fossi</a>,苏ICP备17064972号.</p></div></footer><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-134836068-1",'auto');ga('send','pageview');</script><script src="https://cdn.bootcss.com/mathjax/2.5.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>