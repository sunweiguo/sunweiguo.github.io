<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Zookeeper笔记11-Apache Curator客户端的使用（二） · fossi</title><meta name="description" content="Zookeeper笔记11-Apache Curator客户端的使用（二） - fossi"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"></head><body><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">博客</a></li><li class="nav-list-item"><a href="/tags" target="_self" class="nav-list-link">标签</a></li><li class="nav-list-item"><a href="http://bloghello.oursnail.cn/test.html" target="_blank" class="nav-list-link">爱情</a></li><li class="nav-list-item"><a href="https://github.com/sunweiguo" target="_blank" class="nav-list-link">GIT</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Zookeeper笔记11-Apache Curator客户端的使用（二）</h1><div class="post-meta"><span class="post-time">Feb 23, 2019</span></div><div class="post-content"><p>本文来继续来看Apache Curator客户端的使用！</p>
<a id="more"></a>
<h2>zk-watcher应用实例之模拟统一更新N台节点的配置文件</h2>
<p>zookeeper有一个比较常见的应用场景就是统一管理、更新分布式集群环境中每个节点的配置文件，我们可以在代码中监听集群中的节点，当节点数据发生改变时就同步到其他节点上。如下图：</p>
<p><img src="http://bloghello.oursnail.cn/18-12-10/90520428.jpg" alt="image"></p>
<p>因为我们使用的json作为节点存储的数据格式，所以需要准备一个工具类来做json与pojo对象的一个转换，也就是所谓的反序列化。创建一个 JsonUtils 类，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JsonUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义jackson对象</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ObjectMapper MAPPER = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将对象转换成json字符串。</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;Title: pojoToJson&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;Description: &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">objectToJson</span><span class="params">(Object data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String string = MAPPER.writeValueAsString(data);</span><br><span class="line">            <span class="keyword">return</span> string;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JsonProcessingException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将json结果集转化为对象</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jsonData json数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanType 对象中的object类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">jsonToPojo</span><span class="params">(String jsonData, Class&lt;T&gt; beanType)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            T t = MAPPER.readValue(jsonData, beanType);</span><br><span class="line">            <span class="keyword">return</span> t;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将json数据转换成pojo对象list</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;Title: jsonToList&lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;Description: &lt;/p&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jsonData</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanType</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt;<span class="function">List&lt;T&gt; <span class="title">jsonToList</span><span class="params">(String jsonData, Class&lt;T&gt; beanType)</span> </span>&#123;</span><br><span class="line">        JavaType javaType = MAPPER.getTypeFactory().constructParametricType(List.class, beanType);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            List&lt;T&gt; list = MAPPER.readValue(jsonData, javaType);</span><br><span class="line">            <span class="keyword">return</span> list;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>需要额外的依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-annotations<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>然后创建客户端类，客户端类就是用来监听集群中的节点的。由于是模拟，所以这里的部分代码是伪代码。客户端类我们这里创建了三个，因为集群中有三个节点，由于代码基本上是一样的，每个客户端分别监听watch事件，所以这里只贴出客户端_1的代码。如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client_1</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> CuratorFramework client = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String zkServerIp = <span class="string">"192.168.190.128:2181"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化重连策略以及客户端对象并启动</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Client_1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        RetryPolicy retryPolicy = <span class="keyword">new</span> RetryNTimes(<span class="number">3</span>, <span class="number">5000</span>);</span><br><span class="line">        client = CuratorFrameworkFactory.builder()</span><br><span class="line">                .connectString(zkServerIp)</span><br><span class="line">                .sessionTimeoutMs(<span class="number">10000</span>).retryPolicy(retryPolicy)</span><br><span class="line">                .namespace(<span class="string">"workspace"</span>).build();</span><br><span class="line">        client.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关闭客户端</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">closeZKClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (client != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.client.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  public final static String CONFIG_NODE = "/super/testNode/redis-config";</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String CONFIG_NODE_PATH = <span class="string">"/super/testNode"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String SUB_PATH = <span class="string">"/redis-config"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> CountDownLatch countDown = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);  <span class="comment">// 计数器</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Client_1 cto = <span class="keyword">new</span> Client_1();</span><br><span class="line">        System.out.println(<span class="string">"client1 启动成功..."</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 开启子节点缓存</span></span><br><span class="line">        <span class="keyword">final</span> PathChildrenCache childrenCache = <span class="keyword">new</span> PathChildrenCache(cto.client, CONFIG_NODE_PATH, <span class="keyword">true</span>);</span><br><span class="line">        childrenCache.start(StartMode.BUILD_INITIAL_CACHE);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 添加子节点监听事件</span></span><br><span class="line">        childrenCache.getListenable().addListener(<span class="keyword">new</span> PathChildrenCacheListener() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">childEvent</span><span class="params">(CuratorFramework client, PathChildrenCacheEvent event)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="comment">// 监听节点的数据更新事件</span></span><br><span class="line">                <span class="keyword">if</span> (event.getType().equals(PathChildrenCacheEvent.Type.CHILD_UPDATED)) &#123;</span><br><span class="line">                    String configNodePath = event.getData().getPath();</span><br><span class="line">                    <span class="keyword">if</span> (configNodePath.equals(CONFIG_NODE_PATH + SUB_PATH)) &#123;</span><br><span class="line">                        System.out.println(<span class="string">"监听到配置发生变化，节点路径为:"</span> + configNodePath);</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 读取节点数据</span></span><br><span class="line">                        String jsonConfig = <span class="keyword">new</span> String(event.getData().getData());</span><br><span class="line">                        System.out.println(<span class="string">"节点"</span> + CONFIG_NODE_PATH + <span class="string">"的数据为: "</span> + jsonConfig);</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 从json转换配置</span></span><br><span class="line">                        RedisConfig redisConfig = <span class="keyword">null</span>;</span><br><span class="line">                        <span class="keyword">if</span> (StringUtils.isNotBlank(jsonConfig)) &#123;</span><br><span class="line">                            redisConfig = JsonUtils.jsonToPojo(jsonConfig, RedisConfig.class);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 配置不为空则进行相应操作</span></span><br><span class="line">                        <span class="keyword">if</span> (redisConfig != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            String type = redisConfig.getType();</span><br><span class="line">                            String url = redisConfig.getUrl();</span><br><span class="line">                            String remark = redisConfig.getRemark();</span><br><span class="line">                            <span class="comment">// 判断事件</span></span><br><span class="line">                            <span class="keyword">if</span> (type.equals(<span class="string">"add"</span>)) &#123;</span><br><span class="line">                                System.out.println(<span class="string">"\n-------------------\n"</span>);</span><br><span class="line">                                System.out.println(<span class="string">"监听到新增的配置，准备下载..."</span>);</span><br><span class="line">                                <span class="comment">// ... 连接ftp服务器，根据url找到相应的配置</span></span><br><span class="line">                                Thread.sleep(<span class="number">500</span>);</span><br><span class="line">                                System.out.println(<span class="string">"开始下载新的配置文件，下载路径为&lt;"</span> + url + <span class="string">"&gt;"</span>);</span><br><span class="line">                                <span class="comment">// ... 下载配置到你指定的目录</span></span><br><span class="line">                                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                                System.out.println(<span class="string">"下载成功，已经添加到项目中"</span>);</span><br><span class="line">                                <span class="comment">// ... 拷贝文件到项目目录</span></span><br><span class="line">                            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type.equals(<span class="string">"update"</span>)) &#123;</span><br><span class="line">                                System.out.println(<span class="string">"\n-------------------\n"</span>);</span><br><span class="line">                                System.out.println(<span class="string">"监听到更新的配置，准备下载..."</span>);</span><br><span class="line">                                <span class="comment">// ... 连接ftp服务器，根据url找到相应的配置</span></span><br><span class="line">                                Thread.sleep(<span class="number">500</span>);</span><br><span class="line">                                System.out.println(<span class="string">"开始下载配置文件，下载路径为&lt;"</span> + url + <span class="string">"&gt;"</span>);</span><br><span class="line">                                <span class="comment">// ... 下载配置到你指定的目录</span></span><br><span class="line">                                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                                System.out.println(<span class="string">"下载成功..."</span>);</span><br><span class="line">                                System.out.println(<span class="string">"删除项目中原配置文件..."</span>);</span><br><span class="line">                                Thread.sleep(<span class="number">100</span>);</span><br><span class="line">                                <span class="comment">// ... 删除原文件</span></span><br><span class="line">                                System.out.println(<span class="string">"拷贝配置文件到项目目录..."</span>);</span><br><span class="line">                                <span class="comment">// ... 拷贝文件到项目目录</span></span><br><span class="line">                            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type.equals(<span class="string">"delete"</span>)) &#123;</span><br><span class="line">                                System.out.println(<span class="string">"\n-------------------\n"</span>);</span><br><span class="line">                                System.out.println(<span class="string">"监听到需要删除配置"</span>);</span><br><span class="line">                                System.out.println(<span class="string">"删除项目中原配置文件..."</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="comment">// TODO 视情况统一重启服务</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        countDown.await();</span><br><span class="line"></span><br><span class="line">        cto.closeZKClient();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>完成以上代码的编写后，将所有的客户类都运行起来。然后到zookeeper服务器上，进行如下操作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost:2181(CONNECTED) 14] set /workspace/super/testNode/redis-config &#123;&quot;type&quot;:&quot;add&quot;,&quot;url&quot;:&quot;ftp://192.168.10.123/config/redis.xml&quot;,&quot;remark&quot;:&quot;add&quot;&#125;</span><br><span class="line">cZxid = 0xc00000039</span><br><span class="line">ctime = Mon Apr 30 01:43:47 CST 2018</span><br><span class="line">mZxid = 0xc00000043</span><br><span class="line">mtime = Mon Apr 30 01:52:35 CST 2018</span><br><span class="line">pZxid = 0xc00000039</span><br><span class="line">cversion = 0</span><br><span class="line">dataVersion = 1</span><br><span class="line">aclVersion = 0</span><br><span class="line">ephemeralOwner = 0x0</span><br><span class="line">dataLength = 75</span><br><span class="line">numChildren = 0</span><br><span class="line">[zk: localhost:2181(CONNECTED) 15] set /workspace/super/testNode/redis-config &#123;&quot;type&quot;:&quot;update&quot;,&quot;url&quot;:&quot;ftp://192.168.10.123/config/redis.xml&quot;,&quot;remark&quot;:&quot;update&quot;&#125;</span><br><span class="line">cZxid = 0xc00000039</span><br><span class="line">ctime = Mon Apr 30 01:43:47 CST 2018</span><br><span class="line">mZxid = 0xc00000044</span><br><span class="line">mtime = Mon Apr 30 01:53:46 CST 2018</span><br><span class="line">pZxid = 0xc00000039</span><br><span class="line">cversion = 0</span><br><span class="line">dataVersion = 2</span><br><span class="line">aclVersion = 0</span><br><span class="line">ephemeralOwner = 0x0</span><br><span class="line">dataLength = 81</span><br><span class="line">numChildren = 0</span><br><span class="line">[zk: localhost:2181(CONNECTED) 16] set /workspace/super/testNode/redis-config &#123;&quot;type&quot;:&quot;delete&quot;,&quot;url&quot;:&quot;&quot;,&quot;remark&quot;:&quot;delete&quot;&#125;   </span><br><span class="line">cZxid = 0xc00000039               </span><br><span class="line">ctime = Mon Apr 30 01:43:47 CST 2018</span><br><span class="line">mZxid = 0xc00000045</span><br><span class="line">mtime = Mon Apr 30 01:54:06 CST 2018</span><br><span class="line">pZxid = 0xc00000039</span><br><span class="line">cversion = 0</span><br><span class="line">dataVersion = 3</span><br><span class="line">aclVersion = 0</span><br><span class="line">ephemeralOwner = 0x0</span><br><span class="line">dataLength = 44</span><br><span class="line">numChildren = 0</span><br><span class="line">[zk: localhost:2181(CONNECTED) 17]</span><br></pre></td></tr></table></figure>
<p><img src="http://bloghello.oursnail.cn/18-12-10/55655494.jpg" alt="image"></p>
<p><img src="http://bloghello.oursnail.cn/18-12-10/45175373.jpg" alt="image"></p>
<p><img src="http://bloghello.oursnail.cn/18-12-10/92597884.jpg" alt="image"></p>
<p>如上，从三个客户端的控制台输出信息可以看到，三个节点都进行了同样操作，触发了同样的watch事件，这样就可以完成统一的配置文件管理。</p>
<h2>curator之acl权限操作与认证授权</h2>
<p>我们先演示在创建节点时设置acl权限，现在/workspace/super只有如下节点：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost:2181(CONNECTED) 27] ls /workspace/super</span><br><span class="line">[xxxnode, testNode]</span><br></pre></td></tr></table></figure>
<p>然后新建一个 CuratorAcl 类，关于acl权限的概念以及部分API代码都在之前的zk原生API使用一文中介绍过了，所以这里就不赘述了。编写代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CuratorAcl</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Curator客户端</span></span><br><span class="line">    <span class="keyword">public</span> CuratorFramework client = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// 集群模式则是多个ip</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String zkServerIps = <span class="string">"192.168.190.128:2181,192.168.190.129:2181,192.168.190.130:2181"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CuratorAcl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        RetryPolicy retryPolicy = <span class="keyword">new</span> RetryNTimes(<span class="number">3</span>, <span class="number">5000</span>);</span><br><span class="line">        client = CuratorFrameworkFactory.builder().authorization(<span class="string">"digest"</span>, <span class="string">"user1:123456a"</span>.getBytes())  <span class="comment">// 认证授权，登录用户</span></span><br><span class="line">                .connectString(zkServerIps)</span><br><span class="line">                .sessionTimeoutMs(<span class="number">10000</span>).retryPolicy(retryPolicy)</span><br><span class="line">                .namespace(<span class="string">"workspace"</span>).build();</span><br><span class="line">        client.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">closeZKClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (client != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.client.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 实例化</span></span><br><span class="line">        CuratorAcl cto = <span class="keyword">new</span> CuratorAcl();</span><br><span class="line">        <span class="keyword">boolean</span> isZkCuratorStarted = cto.client.isStarted();</span><br><span class="line">        System.out.println(<span class="string">"当前客户的状态："</span> + (isZkCuratorStarted ? <span class="string">"连接中"</span> : <span class="string">"已关闭"</span>));</span><br><span class="line"></span><br><span class="line">        String nodePath = <span class="string">"/super/testAclNode/testOne"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 自定义权限列表</span></span><br><span class="line">        List&lt;ACL&gt; acls = <span class="keyword">new</span> ArrayList&lt;ACL&gt;();</span><br><span class="line">        Id user1 = <span class="keyword">new</span> Id(<span class="string">"digest"</span>, AclUtils.getDigestUserPwd(<span class="string">"user1:123456a"</span>));</span><br><span class="line">        Id user2 = <span class="keyword">new</span> Id(<span class="string">"digest"</span>, AclUtils.getDigestUserPwd(<span class="string">"user2:123456b"</span>));</span><br><span class="line">        acls.add(<span class="keyword">new</span> ACL(ZooDefs.Perms.ALL, user1));</span><br><span class="line">        acls.add(<span class="keyword">new</span> ACL(ZooDefs.Perms.READ, user2));</span><br><span class="line">        acls.add(<span class="keyword">new</span> ACL(ZooDefs.Perms.DELETE | ZooDefs.Perms.CREATE, user2));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建节点，使用自定义权限列表来设置节点的acl权限</span></span><br><span class="line">        <span class="keyword">byte</span>[] nodeData = <span class="string">"child-data"</span>.getBytes();</span><br><span class="line">        cto.client.create().creatingParentsIfNeeded().withMode(CreateMode.PERSISTENT).withACL(acls).forPath(nodePath, nodeData);</span><br><span class="line"></span><br><span class="line">        cto.closeZKClient();</span><br><span class="line">        <span class="keyword">boolean</span> isZkCuratorStarted2 = cto.client.isStarted();</span><br><span class="line">        System.out.println(<span class="string">"当前客户的状态："</span> + (isZkCuratorStarted2 ? <span class="string">"连接中"</span> : <span class="string">"已关闭"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行该类，然后到zookeeper服务器上，通过命令行进行如下操作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost:2181(CONNECTED) 19] ls /workspace/super/testAclNode    </span><br><span class="line">[testOne]</span><br><span class="line">[zk: localhost:2181(CONNECTED) 20] getAcl /workspace/super/testAclNode</span><br><span class="line">&apos;world,&apos;anyone</span><br><span class="line">: cdrwa</span><br><span class="line">[zk: localhost:2181(CONNECTED) 21] getAcl /workspace/super/testAclNode/testOne</span><br><span class="line">&apos;digest,&apos;user1:TQYTqd46qVVbWpOd02tLO5qb+JM=</span><br><span class="line">: cdrwa</span><br><span class="line">&apos;digest,&apos;user2:CV4ED0rE6SxA3h/DN/WyScDMbCs=</span><br><span class="line">: r</span><br><span class="line">&apos;digest,&apos;user2:CV4ED0rE6SxA3h/DN/WyScDMbCs=</span><br><span class="line">: cd</span><br></pre></td></tr></table></figure>
<p>如上，可以看到，创建的全部节点的acl权限都是我们设置的自定义权限。</p>
<p>最后我们再来演示如何修改一个已存在的节点的acl权限，修改 CuratorAcl 类中的main方法代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// 实例化</span></span><br><span class="line">    CuratorAcl cto = <span class="keyword">new</span> CuratorAcl();</span><br><span class="line">    <span class="keyword">boolean</span> isZkCuratorStarted = cto.client.isStarted();</span><br><span class="line">    System.out.println(<span class="string">"当前客户的状态："</span> + (isZkCuratorStarted ? <span class="string">"连接中"</span> : <span class="string">"已关闭"</span>));</span><br><span class="line"></span><br><span class="line">    String nodePath = <span class="string">"/super/testAclNodeTwo/testOne"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 自定义权限列表</span></span><br><span class="line">    List&lt;ACL&gt; acls = <span class="keyword">new</span> ArrayList&lt;ACL&gt;();</span><br><span class="line">    Id user1 = <span class="keyword">new</span> Id(<span class="string">"digest"</span>, AclUtils.getDigestUserPwd(<span class="string">"user1:123456a"</span>));</span><br><span class="line">    Id user2 = <span class="keyword">new</span> Id(<span class="string">"digest"</span>, AclUtils.getDigestUserPwd(<span class="string">"user2:123456b"</span>));</span><br><span class="line">    acls.add(<span class="keyword">new</span> ACL(ZooDefs.Perms.READ | ZooDefs.Perms.CREATE | ZooDefs.Perms.ADMIN, user1));</span><br><span class="line">    acls.add(<span class="keyword">new</span> ACL(ZooDefs.Perms.READ | ZooDefs.Perms.DELETE | ZooDefs.Perms.CREATE, user2));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置指定节点的acl权限</span></span><br><span class="line">    cto.client.setACL().withACL(acls).forPath(nodePath);</span><br><span class="line"></span><br><span class="line">    cto.closeZKClient();</span><br><span class="line">    <span class="keyword">boolean</span> isZkCuratorStarted2 = cto.client.isStarted();</span><br><span class="line">    System.out.println(<span class="string">"当前客户的状态："</span> + (isZkCuratorStarted2 ? <span class="string">"连接中"</span> : <span class="string">"已关闭"</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行该类，然后到zookeeper服务器上，通过命令行进行如下操作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost:2181(CONNECTED) 31] getAcl /workspace/super/testAclNodeTwo/testOne</span><br><span class="line">&apos;digest,&apos;user1:TQYTqd46qVVbWpOd02tLO5qb+JM=</span><br><span class="line">: cra</span><br><span class="line">&apos;digest,&apos;user2:CV4ED0rE6SxA3h/DN/WyScDMbCs=</span><br><span class="line">: cdr</span><br><span class="line">[zk: localhost:2181(CONNECTED) 32]</span><br></pre></td></tr></table></figure>
<p>可以看到，成功修改了该节点的acl权限。</p>
</div></article></div></section><footer><div class="paginator"><a href="/2019/02/23/zookeeper/Zookeeper笔记12-分布式锁/" class="prev">PRVE</a><a href="/2019/02/23/zookeeper/Zookeeper笔记10-Apache Curator客户端的使用（一）/" class="next">NEXT</a></div><div id="container"></div><link rel="stylesheet" href="https://jjeejj.github.io/css/gitment.css">
<script src="https://jjeejj.github.io/js/gitment.js"></script><script>var gitment = new Gitment({
    id: 'Sat Feb 23 2019 16:46:29 GMT+0800',
    owner: 'sunweiguo',
    repo: 'sunweiguo.github.io',
    oauth: {
        client_id: '56c422eddebac740f021',
        client_secret: 'fd1b1eff6dd6efc61b2a09650840be7aaab787fd',
    },
})
gitment.render('container')</script><div class="copyright"><p>© 2019 <a href="http://yoursite.com">fossi</a>,苏ICP备17064972号.</p></div></footer><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-134836068-1",'auto');ga('send','pageview');</script><script src="https://cdn.bootcss.com/mathjax/2.5.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>