<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 注解-生命周期 · fossi</title><meta name="description" content="注解-生命周期 - fossi"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"></head><body><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">博客</a></li><li class="nav-list-item"><a href="/tags" target="_self" class="nav-list-link">标签</a></li><li class="nav-list-item"><a href="http://bloghello.oursnail.cn/test.html" target="_blank" class="nav-list-link">爱情</a></li><li class="nav-list-item"><a href="https://github.com/sunweiguo" target="_blank" class="nav-list-link">GIT</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">注解-生命周期</h1><div class="post-meta"><span class="post-time">Mar 3, 2019</span></div><div class="post-content"><p>我们在之前说到过bean的生命周期，其中提到了很多初始化方法，搞得我们晕头晕脑，本文就是来解决这个问题，对bean生命周期中重要的几个初始化和销毁接口或注解进行消息阐述，使得对bean的生命周期理解更加轻松。</p>
<a id="more"></a>
<h2>1. @Bean指定初始化和销毁方法</h2>
<p>bean生命周期：bean创建----初始化----销毁的过程</p>
<p>容器管理bean的生命周期，我们可以自定义初始化和销毁方法，容器在bean进行到当前生命周期的时候来调用我们自定义的初始化和销毁方法。</p>
<ul>
<li>指定初始化和销毁方法</li>
</ul>
<p>用xml配置的方式，可以指定<code>init-method</code>和<code>destory-method</code>；</p>
<p>那么注解如何做到自定义的初始化和销毁方法呢？</p>
<p>我们先来创建一个Dog的类:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Dog</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Dog</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Dog constructor...."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Dog init..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destory</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Dog destory..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>写一个配置类来注册这个Dog：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainConfigOfLifeCycle</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Dog <span class="title">dog</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Dog();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先来启动容器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test01</span><span class="params">()</span></span>&#123;</span><br><span class="line">    AnnotationConfigApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext(MainConfigOfLifeCycle.class);</span><br><span class="line">    System.out.println(<span class="string">"容器已经启动成功..."</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么打印结果是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Dog constructor....</span><br><span class="line">容器已经启动成功...</span><br></pre></td></tr></table></figure>
<p>那如何指定我们自定义的初始化和销毁方法呢？</p>
<p>首先修改一下测试方法，增加一句关闭容器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test01</span><span class="params">()</span></span>&#123;</span><br><span class="line">    AnnotationConfigApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext(MainConfigOfLifeCycle.class);</span><br><span class="line">    System.out.println(<span class="string">"容器已经启动成功..."</span>);</span><br><span class="line">    applicationContext.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在@Bean注解上指定初始化方法和销毁方法：</p>
<blockquote>
<p>@Bean(initMethod = “init”,destroyMethod = “destory”)</p>
</blockquote>
<p>再次启动，显示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Dog constructor....</span><br><span class="line">Dog init...</span><br><span class="line">容器已经启动成功...</span><br><span class="line">Dog destory...</span><br></pre></td></tr></table></figure>
<p>但是注意单例和多例的区别，现在我将其配置成多例，由于多例是每次访问才会创建bean，所以我们还需要访问一下。</p>
<p>最后的打印结果是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">容器已经启动成功...</span><br><span class="line">Dog constructor....</span><br><span class="line">五月 28, 2018 3:49:33 下午 org.springframework.context.annotation.AnnotationConfigApplicationContext doClose</span><br><span class="line">信息: Closing org.springframework.context.annotation.AnnotationConfigApplicationContext@16f65612: startup date [Mon May 28 15:49:32 CST 2018]; root of context hierarchy</span><br><span class="line">Dog init...</span><br></pre></td></tr></table></figure>
<p>说明在多例的情况下，容器最后不会销毁这个bean。</p>
<p><strong>⭐总结一下：</strong></p>
<blockquote>
<p>注解如何指定bean的初始化和销毁：@Bean注解后面指定init-method和destory-method</p>
<p>初始化：对象创建完成之后，并赋值好，在调用初始化方法</p>
<p>销毁方法：单例：容器关闭的时候销毁；多例：容器不会管理这个bean，容器不会调用销毁方法</p>
</blockquote>
<h2>2. InitializingBean和DisposableBean</h2>
<p>除了上一种用<code>@Bean</code>的方式来指定<code>bean</code>的初始化和销毁之外，spring还提供了另外的方法来实现。</p>
<p>初始化：</p>
<p>让<code>Bean</code>实现<code>InitializingBean</code>接口并且实现它的<code>afterPropertiesSet</code>方法，他的作用时机是：当一个<code>BeanFactory</code>创建之后并且所有的属性值已经被设置完成之后，可以调用这个方法来进行初始化的工作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>销毁：</p>
<p>让<code>Bean</code>实现<code>DisposableBean</code>接口并且实现<code>destroy</code>方法，他的作用时机是<code>BeanFactory</code>销毁的时候也将单实例bean给销毁掉。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DisposableBean</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Cat</span> <span class="keyword">implements</span> <span class="title">InitializingBean</span>,<span class="title">DisposableBean</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Cat</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"cat constructor..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"cat destory..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"cat afterPropertiesSet init..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后打印一下，发现达到了一样的效果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat constructor...</span><br><span class="line">cat afterPropertiesSet init...</span><br><span class="line">容器已经启动成功...</span><br><span class="line">cat destory...</span><br></pre></td></tr></table></figure>
<h2>3. @PostConstruct&amp;@PreDestory</h2>
<p><code>@PostConstruct</code>：bean创建好并且赋值好属性值之后执行一些初始化工作</p>
<p><code>@PreDestory</code>：在容器销毁bean之前通知我们进行清理工作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Pig</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Pig</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"pig constructor..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"pig init..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PreDestroy</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destory</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"pig destory..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一样的效果。</p>
<h2>4. BeanPostProcessor-后置处理器</h2>
<p>这是一个接口，bean的后置处理器，在bean初始化前后进行一些处理工作，有两个方法，一个是初始化之前处理，一个是初始化之后处理。</p>
<p><strong>具体的执行时机：</strong></p>
<blockquote>
<p>postProcessBeforeInitialization是在bean实例生成之后，在任何的初始化方法之前（比如InitializingBean接口的afterPropertiesSet方法；比如init-method方法）</p>
</blockquote>
<blockquote>
<p>postProcessAfterInitialization与上面个完全相反，在任何的初始化方法完成之后再调用。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BeanPostProcessor</span> </span>&#123;</span><br><span class="line">    <span class="function">Object <span class="title">postProcessBeforeInitialization</span><span class="params">(Object var1, String var2)</span> <span class="keyword">throws</span> BeansException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Object <span class="title">postProcessAfterInitialization</span><span class="params">(Object var1, String var2)</span> <span class="keyword">throws</span> BeansException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>示例：</p>
<p>我这里将上面的Dog，Cat，Pig全部用起来。pig用到init-destory和destory-method方法；cat实现InitializingBean,DisposableBean这两个接口；pig是实现@PostConstruct和@PreDestory这两个接口。</p>
<p>再加上后置处理器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBeanPostProcessor</span> <span class="keyword">implements</span> <span class="title">BeanPostProcessor</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bean 还未初始化的bean对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> beanName 这个bean对象在容器中的名字</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回我们要用的bean实例对象，可以直接返回传进来的bean，也可以包装一下再返回</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> BeansException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"postProcessBeforeInitialization..."</span>+beanName+<span class="string">"=&gt;"</span>+bean);</span><br><span class="line">        <span class="keyword">return</span> bean;<span class="comment">//返回null的话，下面个方法就不会再执行了</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"postProcessAfterInitialization..."</span>+beanName+<span class="string">"=&gt;"</span>+bean);</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一起启动，看看是什么先后顺序：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">//1.首先是Dog对象创建</span><br><span class="line">//2.然后是在任何的初始化方法之前执行postProcessBeforeInitialization</span><br><span class="line">//3.然后初始化init</span><br><span class="line">//4.init初始化之后执行postProcessAfterInitialization</span><br><span class="line">Dog constructor....</span><br><span class="line">postProcessBeforeInitialization...dog=&gt;com.swg.bean.Dog@157632c9</span><br><span class="line">Dog init...</span><br><span class="line">postProcessAfterInitialization...dog=&gt;com.swg.bean.Dog@157632c9</span><br><span class="line">//同理</span><br><span class="line">cat constructor...</span><br><span class="line">postProcessBeforeInitialization...cat=&gt;com.swg.bean.Cat@64c87930</span><br><span class="line">cat afterPropertiesSet init...</span><br><span class="line">postProcessAfterInitialization...cat=&gt;com.swg.bean.Cat@64c87930</span><br><span class="line">//同理</span><br><span class="line">pig constructor...</span><br><span class="line">postProcessBeforeInitialization...pig=&gt;com.swg.bean.Pig@4de5031f</span><br><span class="line">pig init...</span><br><span class="line">postProcessAfterInitialization...pig=&gt;com.swg.bean.Pig@4de5031f</span><br><span class="line"></span><br><span class="line">容器已经启动成功...</span><br><span class="line">五月 28, 2018 4:29:27 下午 org.springframework.context.annotation.AnnotationConfigApplicationContext doClose</span><br><span class="line">信息: Closing org.springframework.context.annotation.AnnotationConfigApplicationContext@16f65612: startup date [Mon May 28 16:29:26 CST 2018]; root of context hierarchy</span><br><span class="line"></span><br><span class="line">pig destory...</span><br><span class="line">cat destory...</span><br><span class="line">Dog destory...</span><br></pre></td></tr></table></figure>
<p>⭐⭐⭐其实顺序是这样的：<code>Constructor</code> &gt; <code>@BeanPostProcessor</code>前置处理 &gt; <code>@PostConstruct</code> &gt; <code>InitializingBean</code> &gt; <code>init-method</code> &gt; <code>@BeanPostProcessor</code>后置处理</p>
<p><img src="http://bloghello.oursnail.cn/Spring%E4%B8%ADBean%E7%9A%84%E5%AE%9E%E4%BE%8B%E5%8C%96%E8%BF%87%E7%A8%8B.jpg" alt="image"></p>
<h2>5. BeanPostProcessor原理</h2>
<p>首先是创建IOC容器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AnnotationConfigApplicationContext applicationContext = <span class="keyword">new</span> AnnotationConfigApplicationContext(MainConfigOfLifeCycle.class);</span><br></pre></td></tr></table></figure>
<p>进去之后是构造器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AnnotationConfigApplicationContext</span><span class="params">(Class... annotatedClasses)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>();</span><br><span class="line">    <span class="keyword">this</span>.register(annotatedClasses);</span><br><span class="line">    <span class="keyword">this</span>.refresh();<span class="comment">//刷新IOC容器</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个<code>refresh</code>方法中有<code>finishBeanFactoryInitialization</code>这个方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//初始化剩下的所有非懒记载的单例bean</span></span><br><span class="line"><span class="keyword">this</span>.finishBeanFactoryInitialization(beanFactory);</span><br></pre></td></tr></table></figure>
<p><code>finishBeanFactoryInitialization</code>这个方法中有一个方法是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//真正初始化剩下的所有非懒记载的单例bean</span><br><span class="line">beanFactory.preInstantiateSingletons();</span><br></pre></td></tr></table></figure>
<p>下面就是获取bean，获取不到就创建对象。</p>
<p>上面已经完成了对象的创建。下面就是进行属性赋值和初始化工作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、赋值</span><br><span class="line">先执行populateBean方法，是对bean进行属性赋值</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>、初始化</span><br><span class="line"><span class="comment">//遍历得到容器中所有的BeanPostProcessor：挨个执行beforeInitialization,一旦返回null，后置处理器就不会再执行</span></span><br><span class="line">applyBeanPostProcessorsBeforeInitialization<span class="comment">//初始化之前处理</span></span><br><span class="line">invokeInitMethods：执行初始化方法</span><br><span class="line">applyBeanPostProcessorsAfterInitialization<span class="comment">//初始化之后处理</span></span><br></pre></td></tr></table></figure>
<h2>6. BeanPostProcessor在spring底层的使用</h2>
<p>aop最基本的原理就是通过动态代理（jdk，cglib）来构造出一个代理对象，在容器创建bean的时候替换原来的bean。</p>
<p>是谁来创建这个代理对象呢？<code>AnnotationAwareAspectJAutoProxyCreator</code>，这个玩意就是<code>BeanPostProcessor</code>的某个子类。</p>
<p>关于Spring AOP的具体实现，还是比较复杂的，具体的代码以后再去研究，这里给出一个大概的步骤：</p>
<ul>
<li><code>@EnableAspectJAutoProxy</code> 会注册一个<code>AnnotationAwareAspectJAutoProxyCreator</code></li>
<li><code>AnnotationAwareAspectJAutoProxyCreator</code>是一个<code>InstantiationAwareBeanPostProcessor</code></li>
<li>创建流程
<ul>
<li><code>registerBeanPostProcessors()</code> 注册后置处理器，创建<br>
<code>AnnotationAwareAspectJAutoProxyCreator</code></li>
<li><code>finishBeanFactoryInitialization</code> 初始化剩下的单实例<code>Bean</code>
<ul>
<li>创建<code>Bean</code>和切面</li>
<li><code>AnnotationAwareAspectJAutoProxyCreator</code>拦截创建过程</li>
<li>创建完<code>Bean</code>判断是否需要增强。通过<code>BeanPostProcessorsAfterInitialization</code>，<br>
<code>wrapIfNecessary()</code> 包装代理对象</li>
</ul>
</li>
</ul>
</li>
<li>执行目标方法
<ul>
<li>获取拦截器链（<code>advisor</code>包装为<code>Interceptor</code>）</li>
<li>递归调用拦截器链
<ul>
<li>前置通知、目标方法、后置通知、返回通知、异常通知</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2>总结</h2>
<ul>
<li>执行初始化和销毁方法
<ul>
<li>通过<code>@Bean</code>指定<code>init-destory</code>和<code>destory-method</code>方法</li>
</ul>
</li>
<li>通过让<code>Bean</code>实现<code>InitializingBean</code>（定义初始化逻辑）,<code>DisposableBean</code>（定义销毁前的逻辑）</li>
<li>通过使用JSR250规范中的<code>@PostConstruct</code>和<code>@PreDestory</code>来进行初始化工作和销毁之前的工作</li>
<li><code>BeanPostProcessor</code>：<code>bean</code>的后置处理器，在<code>bean</code>初始化前后进行一些处理工作</li>
</ul>
</div></article></div></section><footer><div class="paginator"><a href="/2019/03/03/spring/注解-属性赋值和自动装配/" class="prev">上一篇</a><a href="/2019/03/03/spring/注解--组件注册/" class="next">下一篇</a></div><div id="container"></div><link rel="stylesheet" href="https://jjeejj.github.io/css/gitment.css">
<script src="https://jjeejj.github.io/js/gitment.js"></script><script>var gitment = new Gitment({
    id: 'Sun Mar 03 2019 12:21:05 GMT+0800',
    owner: 'sunweiguo',
    repo: 'sunweiguo.github.io',
    oauth: {
        client_id: '56c422eddebac740f021',
        client_secret: 'fd1b1eff6dd6efc61b2a09650840be7aaab787fd',
    },
})
gitment.render('container')</script><div class="copyright"><p>© 2019 <a href="http://yoursite.com">fossi</a>,苏ICP备17064972号.</p></div></footer><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-134836068-1",'auto');ga('send','pageview');</script><script src="https://cdn.bootcss.com/mathjax/2.5.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>