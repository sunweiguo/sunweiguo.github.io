<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 07-交易工程(下) · fossi</title><meta name="description" content="07-交易工程(下) - fossi"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"></head><body><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">博客</a></li><li class="nav-list-item"><a href="/tags" target="_self" class="nav-list-link">标签</a></li><li class="nav-list-item"><a href="http://bloghello.oursnail.cn/test.html" target="_blank" class="nav-list-link">爱情</a></li><li class="nav-list-item"><a href="https://github.com/sunweiguo" target="_blank" class="nav-list-link">GIT</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">07-交易工程(下)</h1><div class="post-meta"><span class="post-time">Apr 17, 2019</span></div><div class="post-content"><h2>一、JEST客户端实现产品搜索接口</h2>
<p>上节完成了ELK平台的搭建，经过检验，确实可以实现全文检索的功能，这里在代码层面真正完成产品搜索等服务。</p>
<h3>controller层非常简单：</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/search"</span>)</span><br><span class="line"><span class="keyword">public</span> ApiResult&lt;List&lt;Product&gt;&gt; searchProduct(<span class="meta">@RequestBody</span> PageSearch pageSearch) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    ApiResult&lt;List&lt;Product&gt;&gt; result = <span class="keyword">new</span> ApiResult&lt;&gt;(<span class="number">200</span>,<span class="string">"检索数据成功"</span>);</span><br><span class="line">    List&lt;Product&gt; data = productService.search(pageSearch.getPageNumber(),pageSearch.getPageSize(),pageSearch.getSearchContent());</span><br><span class="line">    result.setData(data);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3>首先引入相关的依赖：</h3>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--全文搜索 这里用于商品搜索--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--全文检索 工具类--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.searchbox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jest<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这里说一说jest。</p>
<p>Jest 是一个Java 版的ElasticSearch Http Rest 客户端，基于HttpClient 封装实现。</p>
<p>因为我们在上一节中用kibana可视化平台发送类似于这样的命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">GET /jdbc/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;spu_name&quot;: &quot;蓝&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;highlight&quot;: &#123;</span><br><span class="line">    &quot;require_field_match&quot;: false,</span><br><span class="line">    &quot;fields&quot;: &#123;</span><br><span class="line">      &quot;*&quot;: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实就是说，我们通过kibana给elasticsearch发送了一个restful的一个http get请求，那么现在的问题就是：如何用java代码来封装成这样一个请求。最先想到的肯定是用HttpClient，但是不够方便，正好jest这个工具类帮助我们实现了这个功能。</p>
<p>它就是在httpclient的基础上进行封装，将请求包装成上面那种形式发送给ES，ES给相应信息，它可以接收到，然后我们再解析即可。</p>
<p>要将这个客户端注册到spring中，service层中才能注入使用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ES客户端</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> JestHttpClient <span class="title">getESClient</span><span class="params">()</span> <span class="keyword">throws</span> UnknownHostException </span>&#123;</span><br><span class="line">    JestClientFactory factory = <span class="keyword">new</span> JestClientFactory();</span><br><span class="line">    factory.setHttpClientConfig(<span class="keyword">new</span> HttpClientConfig</span><br><span class="line">            .Builder(<span class="string">"http://"</span>+parameters.getEsHost())</span><br><span class="line">            .multiThreaded(<span class="keyword">true</span>)</span><br><span class="line">            .readTimeout(<span class="number">10000</span>)</span><br><span class="line">            .build());</span><br><span class="line">    JestHttpClient client = (JestHttpClient)factory.getObject();</span><br><span class="line">    <span class="keyword">return</span> client;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3>具体来看看service层：</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ES全文检索</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Product&gt; <span class="title">search</span><span class="params">(<span class="keyword">int</span> pageNumber, <span class="keyword">int</span> pageSize, String searchContent)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(pageSize==<span class="number">0</span>) &#123;</span><br><span class="line">        pageSize = PAGE_SIZE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(pageNumber&lt;=<span class="number">0</span>) &#123;</span><br><span class="line">        pageNumber = PAGE_NUMBER;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">    <span class="comment">//查询，是一种链式的风格，很容易拼接，就是拼接根据上面字段进行匹配，并且支持分页</span></span><br><span class="line">    searchSourceBuilder.query(QueryBuilders<span class="comment">//组合查询</span></span><br><span class="line">            .boolQuery()</span><br><span class="line">            .must(QueryBuilders.matchQuery(<span class="string">"spu_name"</span>,searchContent))<span class="comment">//must：必须匹配，相当于and；should：相当于or；must not：不匹配</span></span><br><span class="line">            .must(QueryBuilders.matchQuery(<span class="string">"status"</span>,<span class="number">1</span>)))<span class="comment">//第二个条件是必须是在架的商品</span></span><br><span class="line">            .from(pageNumber*pageSize)<span class="comment">//分页展示的起始位置</span></span><br><span class="line">            .size(pageSize);<span class="comment">//每页展示多少</span></span><br><span class="line">    <span class="comment">//这里就是高亮显示的设置</span></span><br><span class="line">    searchSourceBuilder.highlight()</span><br><span class="line">            .field(<span class="string">"spu_name"</span>)</span><br><span class="line">            .preTags(<span class="string">"&lt;em&gt;"</span>).postTags(<span class="string">"&lt;/em&gt;"</span>)</span><br><span class="line">            .fragmentSize(<span class="number">200</span>);</span><br><span class="line">    <span class="comment">//索引，根据索引来查的，我们在logstash中已经设置了这个索引名称</span></span><br><span class="line">    Search search = <span class="keyword">new</span> Search.Builder(searchSourceBuilder.toString())</span><br><span class="line">            .addIndex(<span class="string">"jdbc"</span>)</span><br><span class="line">            .build();</span><br><span class="line">    <span class="comment">//响应结果</span></span><br><span class="line">    SearchResult response = esClient.execute(search);</span><br><span class="line">    String jsonString = response.getJsonString();</span><br><span class="line">    <span class="comment">//json字符串的解析</span></span><br><span class="line">    List&lt;Product&gt; productList = parseResult(jsonString);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> productList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3>下面进行测试：</h3>
<p><img src="http://bloghello.oursnail.cn/mama7-1.png" alt="image"></p>
<h2>二、spring cache来实现分类的查询和缓存</h2>
<h3>controller接口：</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/category"</span>)</span><br><span class="line"><span class="keyword">public</span> ApiResult&lt;List&lt;Category&gt;&gt; listCategory()&#123;</span><br><span class="line"></span><br><span class="line">    ApiResult&lt;List&lt;Category&gt;&gt; result = <span class="keyword">new</span> ApiResult&lt;&gt;(<span class="number">200</span>,<span class="string">"查询分类成功"</span>);</span><br><span class="line"></span><br><span class="line">    List&lt;Category&gt; list =  productService.listCategory();</span><br><span class="line"></span><br><span class="line">    result.setData(list);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3>其中service层：</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Cacheable</span>(cacheNames = Constants.CACHE_PRODUCT_CATEGORY)</span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Category&gt; <span class="title">listCategory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> categoryMapper.selectAll();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们注意到，这里添加了注解<code>@Cacheable</code>，这一行注解就可以将其查询出来的结果缓存到redis中，是不是特别地方便。不能忘记在启动类上添加注解开启缓存：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableCaching</span></span><br></pre></td></tr></table></figure>
<p>这里要注意，分类是有层级的，那么展示所有层级的分类有两种方式，一种是直接在sql中实现：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">sql</span> <span class="attr">id</span>=<span class="string">"Category_Column_List"</span> &gt;</span></span><br><span class="line">    p.id p_id, p.parent_id p_parent_id, p.name p_name, p.status p_status, p.sort_order p_sort_order,</span><br><span class="line">    p.create_time p_create_time, p.update_time p_update_time</span><br><span class="line"><span class="tag">&lt;/<span class="name">sql</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">sql</span> <span class="attr">id</span>=<span class="string">"Children_Column_List"</span> &gt;</span></span><br><span class="line">    c.id c_id, c.parent_id c_parent_id, c.name c_name, c.status c_status, c.sort_order c_sort_order,</span><br><span class="line">    c.create_time c_create_time, c.update_time c_update_time</span><br><span class="line"><span class="tag">&lt;/<span class="name">sql</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectAll"</span> <span class="attr">resultMap</span>=<span class="string">"CategoryResultMap"</span> &gt;</span></span><br><span class="line">    select </span><br><span class="line">    <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">"Category_Column_List"</span> /&gt;</span>,</span><br><span class="line">    <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">"Children_Column_List"</span> /&gt;</span></span><br><span class="line">    from t_category p</span><br><span class="line">    left join t_category c on c.parent_id = p.id</span><br><span class="line">    where p.parent_id = 0 and c.status = 1 and p.status=1</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>还有一种就是在代码层面实现，思路很简单，就是用一个Set集合，先存放所有的一级分类，然后递归查询它下面的所有子分类。这个方式在电商项目中用到的。本节用的是sql方式直接去查询。</p>
<p><img src="http://bloghello.oursnail.cn/mama7-2.png" alt="image"></p>
<p>测试缓存是否生效：</p>
<p><img src="http://bloghello.oursnail.cn/mama7-3.png" alt="image"></p>
<h2>三、商品详情展示</h2>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 显示商品详情，就是sku</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/detail/&#123;id&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ApiResult&lt;Product&gt; <span class="title">productDetail</span><span class="params">(@PathVariable Long id)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    ApiResult&lt;Product&gt; result = <span class="keyword">new</span> ApiResult&lt;&gt;(<span class="number">200</span>,<span class="string">"获取商品详情成功"</span>);</span><br><span class="line"></span><br><span class="line">    Product product =  productService.productDetail(id);</span><br><span class="line"></span><br><span class="line">    result.setData(product);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们在《交易工程上》中分析了一下，这一块是比较复杂的，因为涉及的东西比较多。这个产品下面有很多的sku，再将那张图拿过来：</p>
<p><img src="http://bloghello.oursnail.cn/mama5-9.png" alt="image"></p>
<p>对应着实际页面是：</p>
<p><img src="http://bloghello.oursnail.cn/mama7-4.png" alt="image"></p>
<p>那么，从表中我们可以看出，要完成这个详情页面，借助于三张表，那么就对应着三个bean。就是<code>product</code>里面包含着<code>ProductSku</code>，而<code>ProductSku</code>里面包含着<code>SkuPropertyOption</code>。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;select id="selectByPrimaryKeyWithSku" resultMap="ProductResultMapWithSku" parameterType="java.lang.Long" &gt;</span><br><span class="line">  <span class="keyword">select</span></span><br><span class="line">  &lt;<span class="keyword">include</span> refid=<span class="string">"Product_Column_List"</span> /&gt;,</span><br><span class="line">  &lt;<span class="keyword">include</span> refid=<span class="string">"Sku_Column_List"</span> /&gt;,</span><br><span class="line">  &lt;<span class="keyword">include</span> refid=<span class="string">"Sku_Option_Column_List"</span> /&gt;</span><br><span class="line">  <span class="keyword">from</span> t_product p</span><br><span class="line">  <span class="keyword">left</span> <span class="keyword">join</span> t_sku s <span class="keyword">on</span> s.spu_id = p.id</span><br><span class="line">  <span class="keyword">left</span> <span class="keyword">join</span> t_sku_property_option o <span class="keyword">on</span>  o.sku_id = s.id</span><br><span class="line">  <span class="keyword">where</span> p.id = #&#123;<span class="keyword">id</span>,jdbcType=<span class="built_in">BIGINT</span>&#125; <span class="keyword">and</span> s.enable_flag = <span class="number">1</span> <span class="keyword">and</span> o.enable_flag = <span class="number">1</span></span><br><span class="line">&lt;/<span class="keyword">select</span>&gt;</span><br></pre></td></tr></table></figure>
<p>库存工程当然还没有结束，交易这个功能将会持续集成。</p>
</div></article></div></section><footer><div class="paginator"><a href="/2019/04/17/mama-action/08-库存扣减问题/" class="prev">PRVE</a><a href="/2019/04/17/mama-action/06-交易工程(中)/" class="next">NEXT</a></div><div id="container"></div><link rel="stylesheet" href="https://jjeejj.github.io/css/gitment.css">
<script src="https://jjeejj.github.io/js/gitment.js"></script><script>var gitment = new Gitment({
    id: 'Wed Apr 17 2019 10:41:41 GMT+0800',
    owner: 'sunweiguo',
    repo: 'sunweiguo.github.io',
    oauth: {
        client_id: '56c422eddebac740f021',
        client_secret: 'fd1b1eff6dd6efc61b2a09650840be7aaab787fd',
    },
})
gitment.render('container')</script><div class="copyright"><p>© 2019 <a href="http://yoursite.com">fossi</a>, <a href="https://github.com/sunweiguo">contact with me!</a>.</p></div></footer><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-134836068-1",'auto');ga('send','pageview');</script><script src="https://cdn.bootcss.com/mathjax/2.5.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>