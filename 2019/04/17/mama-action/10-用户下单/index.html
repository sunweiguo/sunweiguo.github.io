<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 10-用户下单 · fossi</title><meta name="description" content="10-用户下单 - fossi"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"></head><body><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">首页</a></li><li class="nav-list-item"><a href="https://sunweiguo.github.io/tags/" target="_blank" class="nav-list-link">标签</a></li><li class="nav-list-item"><a href="http://bloghello.oursnail.cn/test.html" target="_blank" class="nav-list-link">爱情</a></li><li class="nav-list-item"><a href="https://github.com/sunweiguo" target="_blank" class="nav-list-link">GIT</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">10-用户下单</h1><div class="post-meta"><span class="post-time">Apr 17, 2019</span></div><div class="post-content"><p>又到了订单模块，这里直接将购物车这一块省略，假设用户已经在购物车选了很多商品之后，现在开始准备下订单。</p>
<p>我们知道，在库存服务中，我们已经将库存充足的商品记录在<code>Map</code>中，并且将每个商品库存扣减状态和锁定库存扣减状态都记录下来了。</p>
<p>在我们的下单服务中，最先想到的是为订单号生成全局唯一的ID，这里利用之前提到过的雪花算法来实现。具体的实现过程是从<code>ShardingJDBC</code>中的ID生成复制过来的：</p>
<p><img src="http://bloghello.oursnail.cn/mama10-1.png" alt="image"></p>
<h2>一、全局唯一ID生成服务</h2>
<p>新建<code>mama-buy-keygen-service</code>工程：</p>
<p><img src="http://bloghello.oursnail.cn/mama10-2.png" alt="image"></p>
<p>参照上一个写法即可，注入自己的zk地址。</p>
<p>要写一个接口供其他的服务调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KeyGeneratorController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier</span>(<span class="string">"snowFlakeKeyGenerator"</span>)</span><br><span class="line">    <span class="keyword">private</span> KeyGenerator keyGenerator;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/keygen"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">generateKey</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> String.valueOf(keyGenerator.generateKey().longValue());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2>二、购物车、订单表结构分析</h2>
<p><img src="http://bloghello.oursnail.cn/mama10-3.png" alt="image"></p>
<p>其实这个关系是很明朗的了，但是我们要注意一点就是，我们知道，扣减库存服务，如果发现库存不足了或者其他问题，那么返回的是<code>&lt;skuId,-1&gt;</code>，如果扣减成功，返回的是<code>&lt;skuId,1&gt;</code>。用户在下订单的时候，可能有部分商品库存已经不足，但是又不能影响其他库存足的商品导致整个订单出问题，所以在生成订单的时候，需要将库存不足的给移除出订单详情表，价格肯定是不能算进去的，并且要提示用户这个商品库存已经不足，无法购买，继续支付的话，只能支付其他库存充足的产品。</p>
<p>Ok，对于关系和注意点说明清楚之后，下面就要进行实际的编码了。</p>
<h2>三、创建订单逻辑</h2>
<p>我们首先注意到订单有几种状态，我们这里简化一下状态，用枚举来表示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> TradeStatus &#123;</span><br><span class="line"></span><br><span class="line">    WAITING_PAY(<span class="string">"等待支付"</span>,(<span class="keyword">byte</span>)<span class="number">1</span>),</span><br><span class="line">    TRADE_CANCEL(<span class="string">"订单取消"</span>,(<span class="keyword">byte</span>)<span class="number">2</span>),</span><br><span class="line">    TRADE_PAIED(<span class="string">"订单已支付"</span>,(<span class="keyword">byte</span>)<span class="number">3</span>),</span><br><span class="line">    TRADE_CLOSE(<span class="string">"订单关闭"</span>,(<span class="keyword">byte</span>)<span class="number">4</span>),</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">    TradeStatus(String desc, <span class="keyword">byte</span> value) &#123;</span><br><span class="line">        <span class="keyword">this</span>.desc = desc;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String desc;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>  <span class="keyword">byte</span> value;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//省略get和set方法...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>controller层去创建订单：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/order"</span>)</span><br><span class="line"><span class="keyword">public</span> ApiResult&lt;List&lt;TradeItem&gt;&gt; createOrder(<span class="meta">@RequestBody</span> List&lt;TradeItem&gt; tradeItemList)&#123;</span><br><span class="line"></span><br><span class="line">    ApiResult&lt;List&lt;TradeItem&gt;&gt; result = <span class="keyword">new</span> ApiResult(Constants.RESP_STATUS_OK,<span class="string">"订单提交成功"</span>);</span><br><span class="line"></span><br><span class="line">    List&lt;TradeItem&gt; tradeItemSuccResult =tradeService.createOrder(tradeItemList);</span><br><span class="line">    result.setData(tradeItemSuccResult);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>  result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在来到我们的service层，进行创建订单的细节。思路为：</p>
<ul>
<li>第一步：为订单生成唯一订单号（已经在ID生成服务中解决，调用接口即可）</li>
<li>第二步：构建扣减库存用到的reduceList（遍历传进来的<code>tradeItemList</code>接口）</li>
<li>第三步：扣减完库存，获取到是<code>Map&lt;skuID,status&gt;</code>，status为-1说明库存不足，无法购买；为1说明库存充足，扣减成功；</li>
<li>第四步：根据<code>skuID</code>可以拿到<code>skuList</code>，并且遍历<code>Map&lt;skuID,status&gt;</code>根据status将扣减失败的商品移除出<code>tradeItemList</code></li>
<li>第五步：创建订单主表</li>
<li>第六步：遍历处理完后的<code>tradeItemList</code>配合<code>skuList</code>写入订单详情表</li>
<li>第七步：返回<code>tradeItemList</code>结束。</li>
</ul>
<p>关于调用ID生成服务，那就需要用到<code>Feign</code>了，首先在引入依赖后在主函数上声明注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients</span></span><br></pre></td></tr></table></figure>
<p>然后找到对应的服务名+接口就可以去调用了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient</span>(name = <span class="string">"key-generator"</span>,fallback = KeyGeneratorServiceFallback.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">KeyGenServiceClient</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/keygen"</span>)</span><br><span class="line">    <span class="function">String <span class="title">keyGenerator</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//取不到的时候就返回null</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KeyGeneratorServiceFallback</span> <span class="keyword">implements</span> <span class="title">KeyGenServiceClient</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">keyGenerator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体的service层逻辑代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;TradeItem&gt; <span class="title">createOrder</span><span class="params">(List&lt;TradeItem&gt; tradeItemList)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//拿到唯一ID</span></span><br><span class="line">    String orderNo = keyGenServiceClient.keyGenerator();</span><br><span class="line">    Long tradeNo = Long.parseLong(orderNo);</span><br><span class="line">    Long userId = tradeItemList.get(<span class="number">0</span>).getUserUuid();</span><br><span class="line">    <span class="comment">//构建扣减库存用到的reduceList</span></span><br><span class="line">    List&lt;StockReduce&gt; stockReduceList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    tradeItemList.stream().forEach(</span><br><span class="line">            param-&gt;&#123;</span><br><span class="line">                StockReduce stockReduce = <span class="keyword">new</span> StockReduce();</span><br><span class="line">                stockReduce.setOrderNo(tradeNo);</span><br><span class="line">                stockReduce.setSkuId(param.getSkuId());</span><br><span class="line">                stockReduce.setReduceCount(-param.getQuantity());</span><br><span class="line"></span><br><span class="line">                stockReduceList.add(stockReduce);</span><br><span class="line">            &#125;</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">//扣减库存,只是从redis中预减库存和写入流水表，真正的库存表是在定时任务中用流水表去同步</span></span><br><span class="line">    ApiResult&lt;Map&lt;Long,Integer&gt;&gt; stockResult =  stockServiceClient.reduceStock(stockReduceList);</span><br><span class="line">    Map&lt;Long,Integer&gt; stockResultMap = stockResult.getData();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//查询相关SKU的属性</span></span><br><span class="line">    List&lt;ProductSku&gt; skuResult = productSkuMapper.selectBySkuIdList(stockResultMap.keySet());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//判断库存逻辑  插入订单</span></span><br><span class="line">    Trade trade = <span class="keyword">new</span> Trade();</span><br><span class="line">    trade.setTradeNo(tradeNo);</span><br><span class="line">    trade.setStatus(TradeStatus.WAITING_PAY.getValue());</span><br><span class="line">    trade.setUserUuid(userId);</span><br><span class="line">    tradeMapper.insertSelective(trade);</span><br><span class="line">    <span class="comment">//将扣减库存失败的商品选出来，然后去tradeItems中去移除</span></span><br><span class="line">    stockResultMap.keySet().stream().forEach(</span><br><span class="line">            param-&gt;&#123;</span><br><span class="line">                <span class="comment">//扣库存失败的移除</span></span><br><span class="line">                <span class="keyword">if</span>(stockResultMap.get(param)==-<span class="number">1</span>)&#123;</span><br><span class="line">                    TradeItem tradeItem =  tradeItemList.stream().filter(</span><br><span class="line">                            item-&gt;item.getSkuId()==param</span><br><span class="line">                    ).findFirst()</span><br><span class="line">                            .get();</span><br><span class="line">                    tradeItemList.remove(tradeItem);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">//计算商品价格等信息</span></span><br><span class="line">    tradeItemList.stream().forEach(</span><br><span class="line">            param-&gt;&#123;</span><br><span class="line">                ProductSku sku = skuResult.stream().filter(</span><br><span class="line">                        skuParam-&gt;param.getSkuId()==skuParam.getId()</span><br><span class="line">                ).findFirst()</span><br><span class="line">                        .get();</span><br><span class="line">                param.setTradeNo(tradeNo);</span><br><span class="line">                param.setSkuImageUrl(sku.getImgUrl());</span><br><span class="line">                param.setSkuName(sku.getSkuName());</span><br><span class="line">                param.setCurrentPrice(sku.getSkuPrice());</span><br><span class="line">                param.setTotalPrice(sku.getSkuPrice().multiply(<span class="keyword">new</span> BigDecimal(param.getQuantity())));</span><br><span class="line"></span><br><span class="line">                tradeItemMapper.insertSelective(param);</span><br><span class="line">            &#125;</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> tradeItemList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2>四、创建订单可能存在的问题</h2>
<p>这个时候，会存在一个问题，如果在redis扣减库存成功之后，后面的数据库插入抛出异常甚至出现错误，那么这个时候，订单没有存进库里，但是redis已经扣减库存成功。由于事务只能保证这里的数据库回滚，但是redis是不会回滚的，就会造成数据的不一致，这里就涉及到了分布式事务，该如何解决呢？</p>
<p>如果是发生了跨库，还涉及redis等情况，这里可能需要分布式事务来保证，但是这里暂时还用不到，因为这里比较特殊，虽然我库存已经扣了，但是订单没有入库，由于是这边的数据库出问题，用户那边肯定是报错的，然后用户肯定是无法进行支付的，如果还是想买，那么就重新下订单，说不定下次就可以成功，只是流水表中多了一条废弃记录而已和redis中扣了此次废弃记录对应的库存。</p>
<p>那么，既然还没有支付，那么这个没用的订单只是存在于流水表中。那么，我只需要有一个定时任务，去定时扫描这个流水表，如果发现这个订单已经过期了（或者可以拿着这个订单号去订单表去查，如果连记录都没有，那么说明是下单失败这种场景，直接释放锁定库存即可），这个时候锁定库存就会归位，达到了最终一致性。</p>
<p>定时扫描是一种比较有效的方法，但是根据其定时间隔，对于订单超时而言，可能会有一定时间的延迟才可能将其库存归位。</p>
<p>这里还有一种比较及时的方式是，<code>orderNo</code>为key，设置过期时间，比如15分钟，一旦到了15分钟，说明这个订单超时了（如果在超时时间内正常支付了，那么就将这个key删除掉），那么redis就进行一个事件通知，自动告诉程序：这个订单超时了（超时这里就会有两种情况：用户下单成功未支付超时；用户下单失败，订单表压根就没有这条记录，但是已经写到了流水表中并且也扣了库存这种异常情况），那么我就可以根据这个信息，获得超时的那个订单号，如果订单表存在，我将其状态进行更新为“订单超时未支付”状态；如果订单表不存在，啥都不用做或者删除流水表即可；最后，我就可以放心地释放锁定库存（更新redis，更新库存表）。</p>
<p>要达到redis key过期事件通知的效果，需要现在redis中配置一下过期事件：</p>
<p><img src="http://bloghello.oursnail.cn/mama10-4.png" alt="image"></p>
<p>在创建完订单之后设置redis订单号过期:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//设置redis 订单号过期</span></span><br><span class="line">redisTemplate.opsForValue().set(tradeNo.toString(),tradeNo.toString(),<span class="number">20</span>, TimeUnit.MINUTES);</span><br></pre></td></tr></table></figure>
<p>下面要监听一个事件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderKeyExpriedHandler</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisMessageListenerContainer <span class="title">configRedisMessageListenerContainer</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span></span>&#123;</span><br><span class="line">        RedisMessageListenerContainer listenerContainer = <span class="keyword">new</span> RedisMessageListenerContainer();</span><br><span class="line">        listenerContainer.setConnectionFactory(redisConnectionFactory);</span><br><span class="line">        listenerContainer.addMessageListener((message,listener)-&gt;&#123;</span><br><span class="line">        </span><br><span class="line">            <span class="comment">//处理key过期事件逻辑，new String(message.getBody())就是设置进去的orderNo</span></span><br><span class="line">            System.out.println(<span class="string">"------redis过期事件"</span>+<span class="keyword">new</span> String(message.getBody()));</span><br><span class="line">            </span><br><span class="line">        &#125;, <span class="keyword">new</span> PatternTopic(<span class="string">"__keyevent@*__:expired"</span>));</span><br><span class="line">        <span class="keyword">return</span> listenerContainer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于网络抖动，可能会出现各种情况，导致这种事件发不出来或者监听不到，所以我们还要用清点库存定时任务来辅助，自动再去扫描一遍流水表或者订单表，看看是不是还有过期没有释放的记录。</p>
</div></article></div></section><footer><div class="paginator"><a href="/2019/04/23/miaosha/1. 登录功能/" class="prev">PRVE</a><a href="/2019/04/17/mama-action/09-分布式定时任务/" class="next">NEXT</a></div><div id="container"></div><link rel="stylesheet" href="https://jjeejj.github.io/css/gitment.css">
<script src="https://jjeejj.github.io/js/gitment.js"></script><script>var gitment = new Gitment({
    id: 'Wed Apr 17 2019 10:42:12 GMT+0800',
    owner: 'sunweiguo',
    repo: 'sunweiguo.github.io',
    oauth: {
        client_id: '56c422eddebac740f021',
        client_secret: 'fd1b1eff6dd6efc61b2a09650840be7aaab787fd',
    },
})
gitment.render('container')</script><div class="copyright"><p>© 2019 <a href="http://yoursite.com">fossi</a>,苏ICP备17064972号.</p></div></footer><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-134836068-1",'auto');ga('send','pageview');</script><script src="https://cdn.bootcss.com/mathjax/2.5.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>