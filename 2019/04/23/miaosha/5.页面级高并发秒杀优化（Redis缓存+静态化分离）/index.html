<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 5.页面级高并发秒杀优化（Redis缓存+静态化分离） · fossi</title><meta name="description" content="5.页面级高并发秒杀优化（Redis缓存+静态化分离） - fossi"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"></head><body><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">博客</a></li><li class="nav-list-item"><a href="/tags" target="_self" class="nav-list-link">标签</a></li><li class="nav-list-item"><a href="http://bloghello.oursnail.cn/test.html" target="_blank" class="nav-list-link">爱情</a></li><li class="nav-list-item"><a href="https://github.com/sunweiguo" target="_blank" class="nav-list-link">GIT</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">5.页面级高并发秒杀优化（Redis缓存+静态化分离）</h1><div class="post-meta"><span class="post-time">Apr 23, 2019</span></div><div class="post-content"><p>尝试对前端页面进行相应的优化，比较典型的是缓存，一些东西可以存在浏览器身上或者redis中，提高相应速度，降低后端压力。</p>
<a id="more"></a>
<h2>1. 页面缓存</h2>
<p>这里以商品列表页面为例。</p>
<p>原来的商品列表页面是这样写的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"to_list"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toList</span><span class="params">(Model model,MiaoshaUser user)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(user == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"login"</span>;</span><br><span class="line">    model.addAttribute(<span class="string">"user"</span>,user);</span><br><span class="line">    List&lt;GoodsVo&gt; goodsVoList = goodsService.getGoodsVoList();</span><br><span class="line">    model.addAttribute(<span class="string">"goodsList"</span>,goodsVoList);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"goods_list"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>给他添加页面缓存：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"to_list"</span>,produces = <span class="string">"text/html"</span>)</span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toList</span><span class="params">(Model model, MiaoshaUser user, HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(user == <span class="keyword">null</span>)&#123;</span><br><span class="line">        response.sendRedirect(<span class="string">"/login/to_login"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    model.addAttribute(<span class="string">"user"</span>,user);</span><br><span class="line">    <span class="comment">//先尝试从缓存中取</span></span><br><span class="line">    String html = redisService.get(GoodsKey.getGoodsList,<span class="string">""</span>,String.class);</span><br><span class="line">    <span class="keyword">if</span>(!StringUtils.isEmpty(html))&#123;</span><br><span class="line">        <span class="keyword">return</span> html;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//取不到，则手动渲染，再保存到redis</span></span><br><span class="line">    List&lt;GoodsVo&gt; goodsVoList = goodsService.getGoodsVoList();</span><br><span class="line">    model.addAttribute(<span class="string">"goodsList"</span>,goodsVoList);</span><br><span class="line">    SpringWebContext ctx = <span class="keyword">new</span> SpringWebContext(request,response,request.getServletContext(),</span><br><span class="line">                                                request.getLocale(), model.asMap(),applicationContext);</span><br><span class="line">    html = thymeleafViewResolver.getTemplateEngine().process(<span class="string">"goods_list"</span>,ctx);</span><br><span class="line">    <span class="keyword">if</span>(!StringUtils.isEmpty(html))&#123;</span><br><span class="line">        redisService.set(GoodsKey.getGoodsList,<span class="string">""</span>,html);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> html;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于商品详情页面的缓存，原来是这样写的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/to_detail/&#123;goodsId&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toDetail</span><span class="params">(@PathVariable(<span class="string">"goodsId"</span>)</span> <span class="keyword">long</span> goodsId,Model model, MiaoshaUser user)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(user == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"login"</span>;</span><br><span class="line">    model.addAttribute(<span class="string">"user"</span>,user);</span><br><span class="line"></span><br><span class="line">    GoodsVo goodsVo = goodsService.getGoodsVoByGoodsId(goodsId);</span><br><span class="line">    model.addAttribute(<span class="string">"goods"</span>,goodsVo);</span><br><span class="line">    <span class="keyword">long</span> startAt = goodsVo.getStartDate().getTime();</span><br><span class="line">    <span class="keyword">long</span> endAt = goodsVo.getEndDate().getTime();</span><br><span class="line">    <span class="keyword">long</span> now = System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">int</span> miaoshaStatus = <span class="number">0</span>;<span class="comment">//秒杀活动的状态，0-秒杀前；1-正在秒杀；2-秒杀结束</span></span><br><span class="line">    <span class="keyword">int</span> remainSeconds = <span class="number">0</span>;<span class="comment">//秒杀活动还剩多少秒</span></span><br><span class="line">    <span class="keyword">if</span>(now &lt; startAt)&#123;</span><br><span class="line">        miaoshaStatus = Constants.MiaoshaStatus.BEFORE_START;</span><br><span class="line">        remainSeconds = (<span class="keyword">int</span>)(startAt-now)/<span class="number">1000</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> (now &gt; endAt)&#123;</span><br><span class="line">        miaoshaStatus = Constants.MiaoshaStatus.AFTER_MIAOSHA;</span><br><span class="line">        remainSeconds = -<span class="number">1</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        miaoshaStatus = Constants.MiaoshaStatus.ON_MIAOSHA;</span><br><span class="line">        remainSeconds = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    model.addAttribute(<span class="string">"miaoshaStatus"</span>,miaoshaStatus);</span><br><span class="line">    model.addAttribute(<span class="string">"remainSeconds"</span>,remainSeconds);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"goods_detail"</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>现在改为如下，以<code>goodsid</code>作为区别：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/to_detail/&#123;goodsId&#125;"</span>,produces = <span class="string">"text/html"</span>)</span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toDetail</span><span class="params">(@PathVariable(<span class="string">"goodsId"</span>)</span> <span class="keyword">long</span> goodsId,Model model, MiaoshaUser user, HttpServletRequest request,</span></span><br><span class="line"><span class="function">                       HttpServletResponse response) <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(user == <span class="keyword">null</span>)&#123;</span><br><span class="line">        response.sendRedirect(<span class="string">"/login/to_login"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    model.addAttribute(<span class="string">"user"</span>,user);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//先尝试从缓存中取</span></span><br><span class="line">    String html = redisService.get(GoodsKey.getGoodsDetail,<span class="string">""</span>+goodsId,String.class);</span><br><span class="line">    <span class="keyword">if</span>(!StringUtils.isEmpty(html))&#123;</span><br><span class="line">        <span class="keyword">return</span> html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    GoodsVo goodsVo = goodsService.getGoodsVoByGoodsId(goodsId);</span><br><span class="line">    model.addAttribute(<span class="string">"goods"</span>,goodsVo);</span><br><span class="line">    <span class="keyword">long</span> startAt = goodsVo.getStartDate().getTime();</span><br><span class="line">    <span class="keyword">long</span> endAt = goodsVo.getEndDate().getTime();</span><br><span class="line">    <span class="keyword">long</span> now = System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">int</span> miaoshaStatus = <span class="number">0</span>;<span class="comment">//秒杀活动的状态，0-秒杀前；1-正在秒杀；2-秒杀结束</span></span><br><span class="line">    <span class="keyword">int</span> remainSeconds = <span class="number">0</span>;<span class="comment">//秒杀活动还剩多少秒</span></span><br><span class="line">    <span class="keyword">if</span>(now &lt; startAt)&#123;</span><br><span class="line">        miaoshaStatus = Constants.MiaoshaStatus.BEFORE_START;</span><br><span class="line">        remainSeconds = (<span class="keyword">int</span>)(startAt-now)/<span class="number">1000</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> (now &gt; endAt)&#123;</span><br><span class="line">        miaoshaStatus = Constants.MiaoshaStatus.AFTER_MIAOSHA;</span><br><span class="line">        remainSeconds = -<span class="number">1</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        miaoshaStatus = Constants.MiaoshaStatus.ON_MIAOSHA;</span><br><span class="line">        remainSeconds = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    model.addAttribute(<span class="string">"miaoshaStatus"</span>,miaoshaStatus);</span><br><span class="line">    model.addAttribute(<span class="string">"remainSeconds"</span>,remainSeconds);</span><br><span class="line"></span><br><span class="line">    SpringWebContext ctx = <span class="keyword">new</span> SpringWebContext(request,response,request.getServletContext(),</span><br><span class="line">            request.getLocale(), model.asMap(),applicationContext);</span><br><span class="line">    html = thymeleafViewResolver.getTemplateEngine().process(<span class="string">"goods_detail"</span>,ctx);</span><br><span class="line">    <span class="keyword">if</span>(!StringUtils.isEmpty(html))&#123;</span><br><span class="line">        redisService.set(GoodsKey.getGoodsDetail,<span class="string">""</span>+goodsId,html);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> html;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2>2. 对象缓存</h2>
<p>就是对一个对象进行缓存，比如这里可以对<code>MiaoshaUser</code>这个对象进行缓存：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> MiaoshaUser <span class="title">getById</span><span class="params">(<span class="keyword">long</span> id)</span></span>&#123;</span><br><span class="line">    <span class="comment">//先去缓存取</span></span><br><span class="line">    MiaoshaUser user = redisService.get(MiaoshaUserKey.getById,<span class="string">""</span>+id,MiaoshaUser.class);</span><br><span class="line">    <span class="keyword">if</span>(user != <span class="keyword">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//缓存没有则去数据库取</span></span><br><span class="line">    user = miaoshaUserDao.getById(id);</span><br><span class="line">    <span class="keyword">if</span>(user != <span class="keyword">null</span>)&#123;</span><br><span class="line">        redisService.set(MiaoshaUserKey.getById,<span class="string">""</span>+user.getId(),user);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个逻辑是十分清晰的，但是如果我是更新一个信息呢？比如更新登录的用户的<code>Nickname</code>。那么就要注意，先更新数据库，在更新好数据库之后，一定要注意处理相关的缓存。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">updateUsername</span><span class="params">(String token,<span class="keyword">long</span> id,String newUsername)</span></span>&#123;</span><br><span class="line">    MiaoshaUser user = getById(id);</span><br><span class="line">    <span class="keyword">if</span>(user == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> GlobalException(CodeMsg.MOBILE_NOT_EXIST);</span><br><span class="line">    <span class="comment">//更新数据库</span></span><br><span class="line">    MiaoshaUser toBeUpdate = <span class="keyword">new</span> MiaoshaUser();</span><br><span class="line">    toBeUpdate.setId(id);</span><br><span class="line">    toBeUpdate.setNickname(newUsername);</span><br><span class="line">    miaoshaUserDao.update(toBeUpdate);</span><br><span class="line">    <span class="comment">//处理缓存</span></span><br><span class="line">    redisService.del(MiaoshaUserKey.getById,<span class="string">""</span>+id);</span><br><span class="line">    user.setNickname(newUsername);</span><br><span class="line">    redisService.set(MiaoshaUserKey.token,token,user);<span class="comment">//token不能直接删除，否则会要求重新登录</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2>3. 商品详情页面静态化</h2>
<p>之前我们队商品详情页面进行了<code>redis</code>缓存，因为这个接口只是展示相应产品详情和秒杀倒计时等信息，只要显示几个关键信息即可，其他的都可以进行静态化。</p>
<p>这种技术，我们其实已经做过了，在之前的电商项目中，前端用<code>vue.js</code>等其他js框架或者不用框架，直接<code>jquery</code>。前端分为两部分，一部分是不改变的<code>html</code>块，还有一块就是数据，他只要后端传数据到前端即可，用到<code>ajax</code>技术。</p>
<p>确定哪些是需要传到前端的数据：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DetailVo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> miaoshaStatus = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> remainSeconds = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> GoodsVo goods;</span><br><span class="line">    <span class="keyword">private</span> MiaoshaUser user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将<code>detail</code>这个接口改为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/detail/&#123;goodsId&#125;"</span>)</span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Result&lt;DetailVo&gt; <span class="title">toDetail</span><span class="params">(@PathVariable(<span class="string">"goodsId"</span>)</span> <span class="keyword">long</span> goodsId, MiaoshaUser user, HttpServletRequest request,</span></span><br><span class="line"><span class="function">                                 HttpServletResponse response) <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(user == <span class="keyword">null</span>)&#123;</span><br><span class="line">        response.sendRedirect(<span class="string">"/login/to_login"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    GoodsVo goodsVo = goodsService.getGoodsVoByGoodsId(goodsId);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> startAt = goodsVo.getStartDate().getTime();</span><br><span class="line">    <span class="keyword">long</span> endAt = goodsVo.getEndDate().getTime();</span><br><span class="line">    <span class="keyword">long</span> now = System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">int</span> miaoshaStatus = <span class="number">0</span>;<span class="comment">//秒杀活动的状态，0-秒杀前；1-正在秒杀；2-秒杀结束</span></span><br><span class="line">    <span class="keyword">int</span> remainSeconds = <span class="number">0</span>;<span class="comment">//秒杀活动还剩多少秒</span></span><br><span class="line">    <span class="keyword">if</span>(now &lt; startAt)&#123;</span><br><span class="line">        miaoshaStatus = Constants.MiaoshaStatus.BEFORE_START;</span><br><span class="line">        remainSeconds = (<span class="keyword">int</span>)(startAt-now)/<span class="number">1000</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> (now &gt; endAt)&#123;</span><br><span class="line">        miaoshaStatus = Constants.MiaoshaStatus.AFTER_MIAOSHA;</span><br><span class="line">        remainSeconds = -<span class="number">1</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        miaoshaStatus = Constants.MiaoshaStatus.ON_MIAOSHA;</span><br><span class="line">        remainSeconds = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    DetailVo detailVo = <span class="keyword">new</span> DetailVo();</span><br><span class="line">    detailVo.setUser(user);</span><br><span class="line">    detailVo.setGoods(goodsVo);</span><br><span class="line">    detailVo.setMiaoshaStatus(miaoshaStatus);</span><br><span class="line">    detailVo.setRemainSeconds(remainSeconds);</span><br><span class="line">    <span class="keyword">return</span> Result.success(detailVo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>后端的数据已经有了，那么前端只要接收这些数据即可。</p>
<p>首先是在<code>static</code>目录下新建<code>goods_detail.htm</code>页面，里面讲<code>themeleaf</code>的动态获取的对象全部去除。改为最普通的<code>html</code>，只要用<code>id</code>来标识一下，然后在<code>js</code>中赋值即可。比如：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tr</span>&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;<span class="name">td</span>&gt;</span>商品原价<span class="tag">&lt;/<span class="name">td</span>&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;<span class="name">td</span> <span class="attr">colspan</span>=<span class="string">"3"</span> <span class="attr">id</span>=<span class="string">"goodsPrice"</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">tr</span>&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;<span class="name">td</span>&gt;</span>秒杀价<span class="tag">&lt;/<span class="name">td</span>&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;<span class="name">td</span> <span class="attr">colspan</span>=<span class="string">"3"</span>  <span class="attr">id</span>=<span class="string">"miaoshaPrice"</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">tr</span>&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;<span class="name">td</span>&gt;</span>库存数量<span class="tag">&lt;/<span class="name">td</span>&gt;</span>  </span><br><span class="line">   <span class="tag">&lt;<span class="name">td</span> <span class="attr">colspan</span>=<span class="string">"3"</span>  <span class="attr">id</span>=<span class="string">"stockCount"</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>js</code>部分，首先是打开页面就执行这个方法：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="comment">//countDown();</span></span><br><span class="line">	getDetail();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>里面的<code>getDetail</code>方法为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getDetail</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> goodsId = g_getQueryString(<span class="string">"goodsId"</span>);</span><br><span class="line">	$.ajax(&#123;</span><br><span class="line">		url:<span class="string">"/goods/detail/"</span>+goodsId,</span><br><span class="line">		type:<span class="string">"GET"</span>,</span><br><span class="line">		success:<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(data.code == <span class="number">0</span>)&#123;</span><br><span class="line">				render(data.data);</span><br><span class="line">			&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">				layer.msg(data.msg);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;,</span><br><span class="line">		error:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">			layer.msg(<span class="string">"客户端请求有误"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>获取<code>goods_id</code>，因为<code>list</code>页面的商品详情请求是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;td&gt;&lt;a th:href=&quot;&apos;/goods_detail.htm?goodsId=&apos;+$&#123;goods.id&#125;&quot;&gt;详情&lt;/a&gt;&lt;/td&gt;</span><br></pre></td></tr></table></figure>
<p>所以下面要获取这个参数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">g_getQueryString</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> reg = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">"(^|&amp;)"</span> + name + <span class="string">"=([^&amp;]*)(&amp;|$)"</span>);</span><br><span class="line"><span class="keyword">var</span> r = <span class="built_in">window</span>.location.search.substr(<span class="number">1</span>).match(reg);</span><br><span class="line"><span class="keyword">if</span>(r != <span class="literal">null</span>) <span class="keyword">return</span> <span class="built_in">unescape</span>(r[<span class="number">2</span>]);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>获取到之后就请求后端接口，获取数据去渲染：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">detail</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> miaoshaStatus = detail.miaoshaStatus;</span><br><span class="line">	<span class="keyword">var</span>  remainSeconds = detail.remainSeconds;</span><br><span class="line">	<span class="keyword">var</span> goods = detail.goods;</span><br><span class="line">	<span class="keyword">var</span> user = detail.user;</span><br><span class="line">	<span class="keyword">if</span>(user)&#123;</span><br><span class="line">		$(<span class="string">"#userTip"</span>).hide();</span><br><span class="line">	&#125;</span><br><span class="line">	$(<span class="string">"#goodsName"</span>).text(goods.goodsName);</span><br><span class="line">	$(<span class="string">"#goodsImg"</span>).attr(<span class="string">"src"</span>, goods.goodsImg);</span><br><span class="line">	$(<span class="string">"#startTime"</span>).text(<span class="keyword">new</span> <span class="built_in">Date</span>(goods.startDate).format(<span class="string">"yyyy-MM-dd hh:mm:ss"</span>));</span><br><span class="line">	$(<span class="string">"#remainSeconds"</span>).val(remainSeconds);</span><br><span class="line">	$(<span class="string">"#goodsId"</span>).val(goods.id);</span><br><span class="line">	$(<span class="string">"#goodsPrice"</span>).text(goods.goodsPrice);</span><br><span class="line">	$(<span class="string">"#miaoshaPrice"</span>).text(goods.miaoshaPrice);</span><br><span class="line">	$(<span class="string">"#stockCount"</span>).text(goods.stockCount);</span><br><span class="line">	countDown();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>倒计时<code>countDown()</code>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">countDown</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> remainSeconds = $(<span class="string">"#remainSeconds"</span>).val();</span><br><span class="line">	<span class="keyword">var</span> timeout;</span><br><span class="line">	<span class="keyword">if</span>(remainSeconds &gt; <span class="number">0</span>)&#123;<span class="comment">//秒杀还没开始，倒计时</span></span><br><span class="line">		$(<span class="string">"#buyButton"</span>).attr(<span class="string">"disabled"</span>, <span class="literal">true</span>);</span><br><span class="line">	   $(<span class="string">"#miaoshaTip"</span>).html(<span class="string">"秒杀倒计时："</span>+remainSeconds+<span class="string">"秒"</span>);</span><br><span class="line">		timeout = setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">			$(<span class="string">"#countDown"</span>).text(remainSeconds - <span class="number">1</span>);</span><br><span class="line">			$(<span class="string">"#remainSeconds"</span>).val(remainSeconds - <span class="number">1</span>);</span><br><span class="line">			countDown();</span><br><span class="line">		&#125;,<span class="number">1000</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span> <span class="keyword">if</span>(remainSeconds == <span class="number">0</span>)&#123;<span class="comment">//秒杀进行中</span></span><br><span class="line">		$(<span class="string">"#buyButton"</span>).attr(<span class="string">"disabled"</span>, <span class="literal">false</span>);</span><br><span class="line">		<span class="keyword">if</span>(timeout)&#123;</span><br><span class="line">			clearTimeout(timeout);</span><br><span class="line">		&#125;</span><br><span class="line">		$(<span class="string">"#miaoshaTip"</span>).html(<span class="string">"秒杀进行中"</span>);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;<span class="comment">//秒杀已经结束</span></span><br><span class="line">		$(<span class="string">"#buyButton"</span>).attr(<span class="string">"disabled"</span>, <span class="literal">true</span>);</span><br><span class="line">		$(<span class="string">"#miaoshaTip"</span>).html(<span class="string">"秒杀已经结束"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的日期格式化为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//设定时间格式化函数，使用new Date().format("yyyyMMddhhmmss");</span></span><br><span class="line"><span class="built_in">Date</span>.prototype.format = <span class="function"><span class="keyword">function</span> (<span class="params">format</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> args = &#123;</span><br><span class="line">        <span class="string">"M+"</span>: <span class="keyword">this</span>.getMonth() + <span class="number">1</span>,</span><br><span class="line">        <span class="string">"d+"</span>: <span class="keyword">this</span>.getDate(),</span><br><span class="line">        <span class="string">"h+"</span>: <span class="keyword">this</span>.getHours(),</span><br><span class="line">        <span class="string">"m+"</span>: <span class="keyword">this</span>.getMinutes(),</span><br><span class="line">        <span class="string">"s+"</span>: <span class="keyword">this</span>.getSeconds(),</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span> (<span class="regexp">/(y+)/</span>.test(format))</span><br><span class="line">        format = format.replace(<span class="built_in">RegExp</span>.$<span class="number">1</span>, (<span class="keyword">this</span>.getFullYear() + <span class="string">""</span>).substr(<span class="number">4</span> - <span class="built_in">RegExp</span>.$<span class="number">1.</span>length));</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> args) &#123;</span><br><span class="line">        <span class="keyword">var</span> n = args[i];</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">"("</span> + i + <span class="string">")"</span>).test(format))</span><br><span class="line">            format = format.replace(<span class="built_in">RegExp</span>.$<span class="number">1</span>, <span class="built_in">RegExp</span>.$<span class="number">1.</span>length == <span class="number">1</span> ? n : (<span class="string">"00"</span> + n).substr((<span class="string">""</span> + n).length));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> format;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2>4. 订单详情页面静态化</h2>
<p>之前的<code>do_miaosha</code>要进行修改，不能再返回<code>String</code>了，而是要返回<code>Json</code>数据，原来是这样写的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/do_miaosha"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">do_miaosha</span><span class="params">(Model model, MiaoshaUser user, @RequestParam(<span class="string">"goodsId"</span>)</span> <span class="keyword">long</span> goodsId)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(user == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"login"</span>;</span><br><span class="line">    model.addAttribute(<span class="string">"user"</span>,user);</span><br><span class="line">    <span class="comment">//判断库存</span></span><br><span class="line">    GoodsVo goodsVo = goodsService.getGoodsVoByGoodsId(goodsId);</span><br><span class="line">    <span class="keyword">if</span>(goodsVo.getStockCount() &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">        model.addAttribute(<span class="string">"errmsg"</span>, CodeMsg.MIAO_SHA_OVER.getMsg());</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"miaosha_fail"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//判断是否已经秒杀到了</span></span><br><span class="line">    MiaoshaOrder miaoshaOrder = orderService.getMiaoshaOrderByUserIdGoodsId(user.getId(),goodsId);</span><br><span class="line">    <span class="keyword">if</span>(miaoshaOrder != <span class="keyword">null</span>)&#123;</span><br><span class="line">        model.addAttribute(<span class="string">"errmsg"</span>, CodeMsg.REPEATE_MIAOSHA.getMsg());</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"miaosha_fail"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//减库存、下订单、写入秒杀订单,需要在一个事务中执行</span></span><br><span class="line">    OrderInfo orderInfo = miaoshaService.miaosha(user,goodsVo);</span><br><span class="line">    model.addAttribute(<span class="string">"orderInfo"</span>, orderInfo);</span><br><span class="line">    model.addAttribute(<span class="string">"goods"</span>, goodsVo);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"order_detail"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在改为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/do_miaosha"</span>,method = RequestMethod.POST)</span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Result&lt;OrderInfo&gt; <span class="title">do_miaosha</span><span class="params">(Model model, MiaoshaUser user, @RequestParam(<span class="string">"goodsId"</span>)</span> <span class="keyword">long</span> goodsId)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(user == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span> Result.error(CodeMsg.SESSION_ERROR);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//判断库存</span></span><br><span class="line">    GoodsVo goodsVo = goodsService.getGoodsVoByGoodsId(goodsId);</span><br><span class="line">    <span class="keyword">if</span>(goodsVo.getStockCount() &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.error(CodeMsg.MIAO_SHA_OVER);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//判断是否已经秒杀到了</span></span><br><span class="line">    MiaoshaOrder miaoshaOrder = orderService.getMiaoshaOrderByUserIdGoodsId(user.getId(),goodsId);</span><br><span class="line">    <span class="keyword">if</span>(miaoshaOrder != <span class="keyword">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.error(CodeMsg.REPEATE_MIAOSHA);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//减库存、下订单、写入秒杀订单,需要在一个事务中执行</span></span><br><span class="line">    OrderInfo orderInfo = miaoshaService.miaosha(user,goodsVo);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Result.success(orderInfo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面按秒杀按钮：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"btn btn-primary btn-block"</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">id</span>=<span class="string">"buyButton"</span><span class="attr">onclick</span>=<span class="string">"doMiaosha()"</span>&gt;</span>立即秒杀<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"goodsId"</span>  <span class="attr">id</span>=<span class="string">"goodsId"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>下面进行处理：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">doMiaosha</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	$.ajax(&#123;</span><br><span class="line">		url:<span class="string">"/miaosha/do_miaosha"</span>,</span><br><span class="line">		type:<span class="string">"POST"</span>,</span><br><span class="line">		data:&#123;</span><br><span class="line">			goodsId:$(<span class="string">"#goodsId"</span>).val(),</span><br><span class="line">		&#125;,</span><br><span class="line">		success:<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(data.code == <span class="number">0</span>)&#123;</span><br><span class="line">				<span class="built_in">window</span>.location.href=<span class="string">"/order_detail.htm?orderId="</span>+data.data.id;</span><br><span class="line">			&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">				layer.msg(data.msg);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;,</span><br><span class="line">		error:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">			layer.msg(<span class="string">"客户端请求有误"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一旦抢到商品，那么就跳转到订单详情页面，<code>order_detail.htm</code>中的处理与上面的一样：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">detail</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> goods = detail.goods;</span><br><span class="line">	<span class="keyword">var</span> order = detail.order;</span><br><span class="line">	$(<span class="string">"#goodsName"</span>).text(goods.goodsName);</span><br><span class="line">	$(<span class="string">"#goodsImg"</span>).attr(<span class="string">"src"</span>, goods.goodsImg);</span><br><span class="line">	$(<span class="string">"#orderPrice"</span>).text(order.goodsPrice);</span><br><span class="line">	$(<span class="string">"#createDate"</span>).text(<span class="keyword">new</span> <span class="built_in">Date</span>(order.createDate).format(<span class="string">"yyyy-MM-dd hh:mm:ss"</span>));</span><br><span class="line">	<span class="keyword">var</span> status = <span class="string">""</span>;</span><br><span class="line">	<span class="keyword">if</span>(order.status == <span class="number">0</span>)&#123;</span><br><span class="line">		status = <span class="string">"未支付"</span></span><br><span class="line">	&#125;<span class="keyword">else</span> <span class="keyword">if</span>(order.status == <span class="number">1</span>)&#123;</span><br><span class="line">		status = <span class="string">"待发货"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	$(<span class="string">"#orderStatus"</span>).text(status);</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	getOrderDetail();</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getOrderDetail</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> orderId = g_getQueryString(<span class="string">"orderId"</span>);</span><br><span class="line">	$.ajax(&#123;</span><br><span class="line">		url:<span class="string">"/order/detail"</span>,</span><br><span class="line">		type:<span class="string">"GET"</span>,</span><br><span class="line">		data:&#123;</span><br><span class="line">			orderId:orderId</span><br><span class="line">		&#125;,</span><br><span class="line">		success:<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(data.code == <span class="number">0</span>)&#123;</span><br><span class="line">				render(data.data);</span><br><span class="line">			&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">				layer.msg(data.msg);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;,</span><br><span class="line">		error:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">			layer.msg(<span class="string">"客户端请求有误"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>要显示<code>order_detail</code>,他请求<code>/order/detail</code>这个接口，需要<code>order</code>和<code>goods</code>两个对象，所以新建一个<code>vo</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderDetailVo</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> GoodsVo goods;</span><br><span class="line">	<span class="keyword">private</span> OrderInfo order;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对<code>OrderController</code>增加接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/detail"</span>)</span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Result&lt;OrderDetailVo&gt; <span class="title">info</span><span class="params">(MiaoshaUser user,</span></span></span><br><span class="line"><span class="function"><span class="params">								  @RequestParam(<span class="string">"orderId"</span>)</span> <span class="keyword">long</span> orderId) </span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(user == <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> Result.error(CodeMsg.SESSION_ERROR);</span><br><span class="line">	&#125;</span><br><span class="line">	OrderInfo order = orderService.getOrderById(orderId);</span><br><span class="line">	<span class="keyword">if</span>(order == <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> Result.error(CodeMsg.ORDER_NOT_EXIST);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">long</span> goodsId = order.getGoodsId();</span><br><span class="line">	GoodsVo goods = goodsService.getGoodsVoByGoodsId(goodsId);</span><br><span class="line">	OrderDetailVo vo = <span class="keyword">new</span> OrderDetailVo();</span><br><span class="line">	vo.setOrder(order);</span><br><span class="line">	vo.setGoods(goods);</span><br><span class="line">	<span class="keyword">return</span> Result.success(vo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样就ok了，对于商品详情和订单详情两个页面完成了静态化。</p>
<h2>5. 页面缓存</h2>
<p><code>Cache-Control</code>:指定缓存有多少时间</p>
<p>为了在浏览器端进行缓存，以及控制缓存时间，这里可以添加一些配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">    resources:</span><br><span class="line">        <span class="keyword">static</span>-locations: classpath:/<span class="keyword">static</span>/</span><br><span class="line">        add-mappings: <span class="keyword">true</span></span><br><span class="line">        cache-period: <span class="number">3600</span></span><br><span class="line">        chain:</span><br><span class="line">          cache: <span class="keyword">true</span></span><br><span class="line">          enabled: <span class="keyword">true</span></span><br><span class="line">          gzipped: <span class="keyword">true</span></span><br><span class="line">          html-application-cache: <span class="keyword">true</span></span><br></pre></td></tr></table></figure>
<h2>6. 解决超卖</h2>
<p>先解决卖成负数的问题：</p>
<p>在<code>reduceStock(MiaoshaGoods g);</code>这个方法里，<code>sql</code>要多加一个<code>stock_count &gt; 0</code>即：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> miaosha_goods <span class="keyword">set</span> stock_count = stock_count<span class="number">-1</span> <span class="keyword">where</span> goods_id=#&#123;goodsId&#125; <span class="keyword">and</span> stock_count &gt; <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>给<code>miaosha_order</code>中的<code>user_id</code>和<code>goods_id</code>建立唯一联合索引。保证同一个人不能秒杀都两个商品。</p>
<p>但是从压测结果来看，虽然解决了上面两个问题。但是仍然发生了超卖现象，即比如只有10件秒杀商品，但是有22个人抢到了。</p>
<p>— <strong>2019/4/17号补充</strong></p>
<p>关于这里的超卖问题，视频中的解决是用数据库的锁来实现，但是这样的话显然效率会比较低，我觉得可以交给redis+MQ来解决，redis结合lua脚本可以实现原子性，这样子可以保证redis中库存扣减不会出问题，再结合MQ的队列，可以避免高并发下发生库存扣减错误问题。这个在mama-buy这个项目中进行了一些演示和说明。</p>
<h2>7. 静态资源优化</h2>
<ul>
<li>js/css压缩</li>
<li>多个js/css组合，减少连接数</li>
<li>CDN就近访问</li>
<li>nginx加缓存，页面缓存，对象缓存</li>
</ul>
</div></article></div></section><footer><div class="paginator"><a href="/2019/04/23/miaosha/6.服务级高并发秒杀优化（RabbitMQ+接口优化）/" class="prev">上一篇</a><a href="/2019/04/23/miaosha/4.JMeter压测/" class="next">下一篇</a></div><div id="container"></div><link rel="stylesheet" href="https://jjeejj.github.io/css/gitment.css">
<script src="https://jjeejj.github.io/js/gitment.js"></script><script>var gitment = new Gitment({
    id: 'Tue Apr 23 2019 18:48:01 GMT+0800',
    owner: 'sunweiguo',
    repo: 'sunweiguo.github.io',
    oauth: {
        client_id: '56c422eddebac740f021',
        client_secret: 'fd1b1eff6dd6efc61b2a09650840be7aaab787fd',
    },
})
gitment.render('container')</script><div class="copyright"><p>© 2019 <a href="http://yoursite.com">fossi</a>, <a href="https://github.com/sunweiguo">contact with me!</a>.</p></div></footer><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-134836068-1",'auto');ga('send','pageview');</script><script src="https://cdn.bootcss.com/mathjax/2.5.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>